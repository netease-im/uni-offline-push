/**
 * 
 *   Version: 0.13.0
 * 
 *   Git Hash: 924ae883cd85a91286ac78e830d956b2269979d7
 * 
 *   Created At: 3/1/2023, 8:08:12 PM
 * 
 *   Target: NIM_UNIAPP_SDK.js
 *   
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).NIM=t()}(this,(function(){"use strict";function __rest(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]])}return r}function __awaiter(e,t,r,s){return new(r||(r=Promise))((function(n,i){function fulfilled(e){try{step(s.next(e))}catch(e){i(e)}}function rejected(e){try{step(s.throw(e))}catch(e){i(e)}}function step(e){e.done?n(e.value):function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((s=s.apply(e,t||[])).next())}))}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var t=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,r="~";function Events(){}function EE(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function addListener(e,t,s,n,i){if("function"!=typeof s)throw new TypeError("The listener must be a function");var o=new EE(s,n||e,i),a=r?r+t:t;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],o]:e._events[a].push(o):(e._events[a]=o,e._eventsCount++),e}function clearEvent(e,t){0==--e._eventsCount?e._events=new Events:delete e._events[t]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(r=!1)),EventEmitter.prototype.eventNames=function eventNames(){var e,s,n=[];if(0===this._eventsCount)return n;for(s in e=this._events)t.call(e,s)&&n.push(r?s.slice(1):s);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},EventEmitter.prototype.listeners=function listeners(e){var t=r?r+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var n=0,i=s.length,o=new Array(i);n<i;n++)o[n]=s[n].fn;return o},EventEmitter.prototype.listenerCount=function listenerCount(e){var t=r?r+e:e,s=this._events[t];return s?s.fn?1:s.length:0},EventEmitter.prototype.emit=function emit(e,t,s,n,i,o){var a=r?r+e:e;if(!this._events[a])return!1;var c,d,m=this._events[a],p=arguments.length;if(m.fn){switch(m.once&&this.removeListener(e,m.fn,void 0,!0),p){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,t),!0;case 3:return m.fn.call(m.context,t,s),!0;case 4:return m.fn.call(m.context,t,s,n),!0;case 5:return m.fn.call(m.context,t,s,n,i),!0;case 6:return m.fn.call(m.context,t,s,n,i,o),!0}for(d=1,c=new Array(p-1);d<p;d++)c[d-1]=arguments[d];m.fn.apply(m.context,c)}else{var l,u=m.length;for(d=0;d<u;d++)switch(m[d].once&&this.removeListener(e,m[d].fn,void 0,!0),p){case 1:m[d].fn.call(m[d].context);break;case 2:m[d].fn.call(m[d].context,t);break;case 3:m[d].fn.call(m[d].context,t,s);break;case 4:m[d].fn.call(m[d].context,t,s,n);break;default:if(!c)for(l=1,c=new Array(p-1);l<p;l++)c[l-1]=arguments[l];m[d].fn.apply(m[d].context,c)}}return!0},EventEmitter.prototype.on=function on(e,t,r){return addListener(this,e,t,r,!1)},EventEmitter.prototype.once=function once(e,t,r){return addListener(this,e,t,r,!0)},EventEmitter.prototype.removeListener=function removeListener(e,t,s,n){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return clearEvent(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||n&&!o.once||s&&o.context!==s||clearEvent(this,i);else{for(var a=0,c=[],d=o.length;a<d;a++)(o[a].fn!==t||n&&!o[a].once||s&&o[a].context!==s)&&c.push(o[a]);c.length?this._events[i]=1===c.length?c[0]:c:clearEvent(this,i)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(e){var t;return e?(t=r?r+e:e,this._events[t]&&clearEvent(this,t)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=r,EventEmitter.EventEmitter=EventEmitter,e.exports=EventEmitter})),r=Backoff;function Backoff(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(e){this.ms=e},Backoff.prototype.setMax=function(e){this.max=e},Backoff.prototype.setJitter=function(e){this.jitter=e};var s="object"==typeof e&&e&&e.Object===Object&&e,n="object"==typeof self&&self&&self.Object===Object&&self,i=s||n||Function("return this")(),o=i.Symbol,a=Object.prototype,c=a.hasOwnProperty,d=a.toString,m=o?o.toStringTag:void 0;var p=function getRawTag(e){var t=c.call(e,m),r=e[m];try{e[m]=void 0;var s=!0}catch(e){}var n=d.call(e);return s&&(t?e[m]=r:delete e[m]),n},l=Object.prototype.toString;var u=function objectToString(e){return l.call(e)},g=o?o.toStringTag:void 0;var y=function baseGetTag(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":g&&g in Object(e)?p(e):u(e)};var h=function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var f=function isFunction(e){if(!h(e))return!1;var t=y(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t};const v={deviceId:"",timeout:8e3},T={account:"",appkey:"",token:"",debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,isAbtestEnable:!0,abtestUrl:"https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",abtestProjectKey:"imElite_sdk_abtest_web"},b="weblink.netease.im:443";class CustomError extends Error{constructor(e,t={},r=400){super(e),this.data=t,this.code=r,this.name="customError"}}class ValidateError extends CustomError{constructor(e,t={},r){super(e,t,414),this.code=414,this.name="validateError",this.rules=r}}const S={200:null,406:null,808:null,810:null,201:"The client version is incorrect. You need to upgrade the SDK",302:"The user name or password is incorrect. Please check whether the appkey and token are valid and whether the account and token match",403:"Illegal operation or no permission",404:"Target object does not exist",405:"Parameter length too long",408:"Client request timed out",414:"Request parameter error",415:"Service unavailable",416:"Frequency control",417:"Repeat operation",422:"Account disabled",500:"Server internal error",503:"Server busy",508:"Expiration date",509:"Invalid",7101:"Be pulled black",700:"Partial failure of batch operation",801:"The number of people in the team has reached the upper limit",802:"No permission",803:"The team does not exist or has not changed",804:"The user is not in the team",805:"Team type mismatch",806:"The number of teams created has reached the limit",807:"Team member not valid",809:"Already in the team",811:"The number of accounts in the forced push list exceeds the limit",812:"The team is muted",813:"Due to the limited number of team, some pull people successfully",814:"Disable team message read service",815:"Maximum number of team administrators",816:"Batch operation partial failure",997:"The packet has expired",998:"Deserialize packet error",999:"Serialize packet error",9102:"Channel failure",9103:"This call has been answered / rejected at another end",10201:"Signaling: target NIM client is offline",10202:"Signaling: push is unreachable",10404:"Signaling: channel not exists",10405:"Signaling: channel already exists",10406:"Signaling: member of channel not exists",10407:"Signaling: member of channel already exists",10408:"Signaling: the invitation request does not exist or has expired",10409:"Signaling: the invitation request has been rejected",10410:"Signaling: the invitation request has been accepted",10414:"Signaling: request parameter error",10417:"Signaling: uid conflict",10419:"Signaling: the number of members of channel exceed the limit",10420:"Signaling: member is already in the channel on other client",10700:"Signaling: phased success",13002:"Abnormal chatroom status",13003:"In the blacklist",13004:"In the mute list",13006:"All members are muted, and only the administrator can speak"};class CmdError extends CustomError{constructor(e,t,r="",s=(new Date).getTime(),n={}){super(r=r||S[e],n,e),this.name="cmdError",this.cmd=t,this.timetag=s}}class FormatError extends CustomError{constructor(e,t,r){super(e,{},412),this.code=412,this.name="formatError",this.key=t,this.reason=r}}class UploadError extends CustomError{constructor(e,t,r,s,n){super(e,{file:n},400),this.name="uploadError",this.rawError=t,this.curProvider=r||1,this.mixStorePolicy=s}}const M=["error","warn","log","debug"],emptyFunc=function(){},k=["off","error","warn","log","debug"];class Logger{constructor(e,t){this.name=t,this.strategies={debug:console.log,log:console.log,warn:console.warn,error:console.error},this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc,this.name=t,Logger.instancesName.push(t),k.includes(e)||(e="off"),this.setLogFunc(e)}setLogFunc(e){const t=M.findIndex((t=>t===e));M.forEach(((e,r)=>{r<=t&&(this[e]=function(){const t=Array.prototype.slice.call(arguments),r=this.formatArgs(t,e);this.strategies[e](r)})}))}formatArgs(e,t){const r=new Date,s=`${r.getMonth()+1}-${r.getDate()} ${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`;return`[NIM ${t} ${this.name} ${s}] `+e.map((e=>e instanceof CustomError?`${e.name}, ${e.code}, ${e.message}`:e instanceof Error?e&&e.message?e.message:e:"object"==typeof e?JSON.stringify(e):e)).join(" ")}}Logger.instancesName=[];var _=createCommonjsModule((function(e,t){e.exports=function(){function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function __rest(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]])}return r}var e={reportUrl:"https://statistic.live.126.net/statics/report/common/form",maxSize:100,msgListMaxSize:1e3,cacheMaxSize:1e3,maxDelay:3e5,maxInterval:3e4,minInterval:1e4,timeout:5e3,autoStart:!0},t="https://statistic.live.126.net/dispatcher/req",r=function emptyFn(){},s=function(){function Reporter(t){_classCallCheck(this,Reporter),this.enable=!1,this.initConfigLoaded=!1,this.loading=!1,this.isDestroyed=!1,this.reportConfig=e,this.msgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.cacheMsgList=[],this.lastReportTime=Date.now(),this.timer=null,this.setConfig(t),this.reportConfig.autoStart&&this.initUploadConfig()}return _createClass(Reporter,[{key:"setConfig",value:function setConfig(e){this.reportConfig=Object.assign({},this.reportConfig,e)}},{key:"reportImmediately",value:function reportImmediately(e,t){var r=this;this.reportConfig.request(e,Object.assign({dataType:"json",method:"POST",timeout:this.reportConfig.timeout},t)).catch((function(e){var t,s;null===(s=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===s||s.warn("Reporter immediately upload failed",e)}))}},{key:"report",value:function report(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e){var s=Date.now();r?this.lowPriorityMsgList.push({module:e,msg:t,createTime:s}):this.msgList.push({module:e,msg:t,createTime:s}),this.msgList.length>this.reportConfig.msgListMaxSize&&this.msgList.shift(),this.lowPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.lowPriorityMsgList.shift(),this.doReport()}}},{key:"reportTraceStart",value:function reportTraceStart(e,t){if(e&&!this.traceMsgCache[e]){var r=Object.assign(Object.assign({start_time:Date.now()},t),{extension:[]});this.traceMsgCache[e]=r}}},{key:"reportTraceUpdate",value:function reportTraceUpdate(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.traceMsgCache[e]){var s,n=t.operation_type,i=t.code,o=t.target,a=t.error,c=__rest(t,["operation_type","code","target","error"]),d=Date.now(),m=this.traceMsgCache[e].extension.length;s=0===m?this.traceMsgCache[e].start_time:this.traceMsgCache[e].extension[m-1].end_time,a&&a.code&&(i=a.code),this.traceMsgCache[e].extension.push({operation_type:n,code:i,succeed:r,target:o,duration:d-s,description:JSON.stringify(c),end_time:d})}}},{key:"reportTraceUpdateV2",value:function reportTraceUpdateV2(e,t){if(this.traceMsgCache[e]){var r=this.traceMsgCache[e].extension.length;t.end_time=0===r?this.traceMsgCache[e].start_time+(t.duration?t.duration:0):this.traceMsgCache[e].extension[r-1].end_time+(t.duration?t.duration:0),this.traceMsgCache[e].extension.push(t)}}},{key:"reportTraceEnd",value:function reportTraceEnd(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.traceMsgCache[e]&&("nos"!==e||!1===t?("boolean"==typeof t?this.traceMsgCache[e].succeed=!!t:this.traceMsgCache[e].state=t,this.traceMsgCache[e].duration=Date.now()-this.traceMsgCache[e].start_time,this.traceMsgCache[e].extension.forEach((function(e){delete e.end_time})),this.report(e,this.traceMsgCache[e]),this.traceMsgCache[e]=null):this.traceMsgCache[e]=null)}},{key:"pause",value:function pause(){this.enable=!1}},{key:"restore",value:function restore(){this.enable=!0,this.initConfigLoaded||this.initUploadConfig()}},{key:"destroy",value:function destroy(){var e=this;Object.keys(this.traceMsgCache).forEach((function(t){e.reportTraceEnd(t,1)})),null!==this.timer&&clearTimeout(this.timer),this.setConfig=r,this.report=r,this.reportTraceStart=r,this.reportTraceUpdate=r,this.reportTraceEnd=r,this.pause=r,this.restore=r,this.destroy=r,this.cacheMsgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.msgList=[],this.reportConfig={},this.isDestroyed=!0}},{key:"initUploadConfig",value:function initUploadConfig(){var e,r,s=this;if(!this.loading){this.loading=!0;var n=this.reportConfig.common||{};try{this.reportConfig.request(t,{method:"GET",dataType:"json",params:{deviceId:n.dev_id,sdkVer:n.sdk_ver,platform:n.platform,appkey:n.app_key},timeout:this.reportConfig.timeout}).then((function(e){var t,r;if(!s.isDestroyed){if(200===e.status&&e.data&&200===e.data.code){var n=e.data.data||{};s.reportConfig.maxSize=n.maxSize>1e3?1e3:n.maxSize,s.reportConfig.maxInterval=n.maxInterval>1e4?1e4:n.maxInterval,s.reportConfig.maxInterval=n.maxInterval<10?10:n.maxInterval,s.reportConfig.minInterval=n.minInterval<2?2:n.minInterval,s.reportConfig.maxDelay=n.maxDelay||300,s.reportConfig.maxInterval=1e3*s.reportConfig.maxInterval,s.reportConfig.minInterval=1e3*s.reportConfig.minInterval,s.reportConfig.maxDelay=1e3*s.reportConfig.maxDelay,s.enable=!0,s.initConfigLoaded=!0,s.loading=!1,s.reportHeartBeat()}null===(r=null===(t=s.reportConfig)||void 0===t?void 0:t.logger)||void 0===r||r.log("Get reporter upload config success")}})).catch((function(e){var t,r;s.loading=!1,null===(r=null===(t=s.reportConfig)||void 0===t?void 0:t.logger)||void 0===r||r.error("Get reporter upload config failed",e)}))}catch(t){this.loading=!1,null===(r=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===r||r.error("Exec reporter request failed",t)}}}},{key:"reportHeartBeat",value:function reportHeartBeat(){var e=this;this.isDestroyed||(this.timer=setTimeout((function(){e.reportHeartBeat()}),this.reportConfig.minInterval),this.doReport())}},{key:"doReport",value:function doReport(){if(!this.isDestroyed){var e=this.msgList.length+this.lowPriorityMsgList.length+this.cacheMsgList.length>2*this.reportConfig.maxSize?this.reportConfig.minInterval:this.reportConfig.maxInterval;Date.now()-this.lastReportTime>=e&&this.upload()}}},{key:"getUploadMsg",value:function getUploadMsg(){var e=this,t={},r=Date.now();this.msgList=this.msgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.lowPriorityMsgList=this.lowPriorityMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.cacheMsgList=this.cacheMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay}));var s=this.msgList.slice(0,this.reportConfig.maxSize);if(this.msgList=this.msgList.slice(s.length),s.length<this.reportConfig.maxSize){var n=this.reportConfig.maxSize-s.length;s=s.concat(this.lowPriorityMsgList.slice(0,n)),this.lowPriorityMsgList=this.lowPriorityMsgList.slice(n)}if(s.length<this.reportConfig.maxSize){var i=this.reportConfig.maxSize-s.length;s=s.concat(this.cacheMsgList.slice(0,i)),this.cacheMsgList=this.cacheMsgList.slice(i)}return s.forEach((function(e){t[e.module]?t[e.module].push(e.msg):t[e.module]=[e.msg]})),{uploadMsgArr:s,uploadMsg:t}}},{key:"upload",value:function upload(){var e,t,r=this;if(this.enable&&!(this.lastReportTime&&Date.now()-this.lastReportTime<this.reportConfig.minInterval)){var s=this.getUploadMsg(),n=s.uploadMsgArr,i=s.uploadMsg;if(n.length){this.lastReportTime=Date.now();try{this.reportConfig.request(this.reportConfig.reportUrl,{dataType:"json",method:"POST",params:{common:this.reportConfig.common,event:i},headers:{sdktype:"im"},timeout:this.reportConfig.timeout}).catch((function(e){var t,s;r.cacheMsgList=r.cacheMsgList.concat(n).slice(0,r.reportConfig.cacheMaxSize),null===(s=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===s||s.warn("Reporter upload failed",e)}))}catch(r){null===(t=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===t||t.warn("Exec reporter request failed",r)}clearTimeout(this.timer),this.reportHeartBeat()}}}}]),Reporter}();return s}()}));const w={setLogger:function(e){throw new Error("Function not implemented.")},platform:"",WebSocket:class AdapterSocket{constructor(e,t){throw this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,new Error("Method not implemented.")}close(e,t){throw new Error("Method not implemented.")}send(e){throw new Error("Method not implemented.")}onclose(e){throw new Error("Method not implemented.")}onerror(e){throw new Error("Method not implemented.")}onmessage(e){throw new Error("Method not implemented.")}onopen(e){throw new Error("Method not implemented.")}},localStorage:{},request:function(e,t){throw new Error("Function not implemented.")},uploadFile:function(e){throw new Error("Function not implemented.")},getSystemInfo:function(){throw new Error("Function not implemented.")}};var I=function isUndefined(e){return void 0===e};let C={},E={};function parseCmd(e,t){var r;let s;try{s=JSON.parse(e)}catch(r){throw t.error("Parse command error: ",e),r}let n=s.sid+"_"+s.cid,i=s.r;if(["4_1","4_2","4_10","4_11"].includes(n)){const e=s.r[1].headerPacket;n=`${e.sid}_${e.cid}`,i=s.r[1].body}const o=E[n],a=C[o],c=function genCmdError(e,t){const r=S[e];return null===r?null:new CmdError(e,t,r,(new Date).getTime())}(s.code,o),d={cmd:o,raw:s,error:c,service:null==a?void 0:a.service,content:{}};if(d.error){if(d.error.cmd=o,d.error.callFunc="parseCmd",!(null===(r=null==a?void 0:a.ignoreErrCodes)||void 0===r?void 0:r.includes(s.code)))return d;t.warn("parseCmd:: ignore error ",d.error),d.error.ignore=!0}return o&&a?(a.response&&a.response.forEach(((e,t)=>{const r=i[t],s=e.type,n=e.name,o=e.reflectMapper;if(!I(r))switch(s){case"Property":d.content[n]=o?deserialize(r,o):r;break;case"PropertyArray":d.content[n]=r.map((e=>o?deserialize(e,o):e));break;case"long":case"Long":case"byte":case"Byte":case"Number":d.content[n]=+r;break;default:d.content[n]=r}})),d):(d.notFound=!0,d)}function serialize(e,t){const r={};for(const s in e)void 0!==t[s]&&(r[t[s]]=e[s]);return r}function deserialize(e,t){const r={};for(const s in e)void 0!==t[s]&&(r[t[s]]=e[s]);return r}function registerParser(e){C=Object.assign(C,e.cmdConfig),E=Object.assign(E,e.cmdMap)}function invertSerializeMap(e){return Object.keys(e).reduce(((t,r)=>{const s=e[r];return t[r]=Object.keys(s).reduce(((e,t)=>(e[s[t]]=t,e)),{}),t}),{})}const x=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],P=["transport not supported","client not handshaken","unauthorized"],A=["reconnect"];class NIMWebsocket extends t{constructor(e,t,r){super(),this.url=t,this.logger=r,this.websocket=null,this.core=e,this.url=t,this.status="disconnected",this.logger=r,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this.core.adapters.request("https://"+this.url+"/socket.io/1/?t="+Date.now(),{method:"GET",dataType:"text",timeout:8e3}).then((e=>{const[t,r]=e.data.split(":");return this.sessionId=t,this.closeTimeout=1e3*r,this._createWebsocket("wss://"+this.url+"/socket.io/1/websocket/"+t)})).catch((e=>{this.logger.error("imsocket::handshake fail. ",e&&e.message),this.status="disconnected",this.emit("handshakeFailed")}))):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){var e;if(this.websocket){this.status="disconnected",this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null;try{null===(e=this.websocket)||void 0===e||e.send(this.encodePacket({type:"disconnect"})),this.websocket.close()}catch(e){this.logger.warn("attempt to close websocket error",e)}this.websocket.onclose=null,this.websocket=null,this.emit("disconnect")}}onConnect(){this.status="connected",this.resetCloseTimer(),this.emit("connect")}_createWebsocket(e){this.websocket=new w.WebSocket(e),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=()=>{this.logger.log("imsocket:: websocket onclose done"),"disconnected"!==this.status&&(this.logger.log("imsocket:: close()",this.status),this.close())},this.websocket.onerror=e=>{this.logger.error("imsocket:: onerror",e)}}onMessage(e){var t;this.resetCloseTimer();const r=this.decodePacket(e.data);if(r)switch(r.type){case"connect":this.onConnect();break;case"disconnect":this.close();break;case"message":case"json":this.emit("message",r.data);break;case"event":r.name&&this.emit(r.name,r.args);break;case"error":"unauthorized"===r.reason?this.emit("connect_failed",r.reason):this.emit("error",r.reason);break;case"heartbeat":null===(t=this.websocket)||void 0===t||t.send(this.encodePacket({type:"heartbeat"}));break;default:this.logger.warn("imsocket::no handler type",r.type)}}encodePacket(e){const{type:t,id:r="",endpoint:s="",ack:n}=e;let i,o,a=null;if(!t)return"";switch(t){case"error":i=e.reason?P.indexOf(e.reason):"",o=e.advice?A.indexOf(e.advice):"",""===i&&""===o||(a=i+(""!==o?"+"+o:""));break;case"message":""!==e.data&&(a=e.data);break;case"event":i={name:e.name},i=e.args&&e.args.length?{name:e.name,args:e.args}:{name:e.name},a=JSON.stringify(i);break;case"json":a=JSON.stringify(e.data);break;case"connect":e.qs&&(a=e.qs);break;case"ack":a=e.ackId+(e.args&&e.args.length?"+"+JSON.stringify(e.args):"")}const c=[x.indexOf(t),r+("data"===n?"+":""),s];return null!=a&&c.push(a),c.join(":")}decodePacket(e){if(!e)return;if("ï¿½"==e.charAt(0))return void this.logger.error("imsocket::unrecognize dataStr",e.slice(0,20));const t=e.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(!t)return;const[,r,s,n,i,o]=t,a={type:x[+r],endpoint:i};let c;switch(s&&(a.id=s,a.ack=!n||"data"),a.type){case"error":c=o.split("+"),a.reason=P[+c[0]]||"";break;case"message":a.data=o||"";break;case"connect":a.qs=o||"";break;case"event":try{const e=JSON.parse(o);a.name=e.name,a.args=e.args}catch(e){this.logger.error("imsocket::parseData::type::event error",e)}a.args=a.args||[];break;case"json":try{a.data=JSON.parse(o)}catch(e){this.logger.error("imsocket::parseData::type::json error",e)}break;case"ack":if(c=o.match(/^([0-9]+)(\+)?(.*)/),c&&(a.ackId=c[1],a.args=[],c[3]))try{a.args=c[3]?JSON.parse(c[3]):[]}catch(e){this.logger.error("imsocket::parseData::type::ack error",e)}}return a}send(e){var t;const r={data:e,type:"message",endpoint:""};null===(t=this.websocket)||void 0===t||t.send(this.encodePacket(r))}resetCloseTimer(){this.closeTimeout&&(clearTimeout(this.closeTimer),this.closeTimer=setTimeout((()=>{this.close()}),this.closeTimeout))}}var j=function isObjectLike(e){return null!=e&&"object"==typeof e};var O=function baseIsRegExp(e){return j(e)&&"[object RegExp]"==y(e)};var R,L=function baseUnary(e){return function(t){return e(t)}},N=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,i=n&&n.exports===r&&s.process,o=function(){try{var e=n&&n.require&&n.require("util").types;return e||i&&i.binding&&i.binding("util")}catch(e){}}();e.exports=o})),U=N&&N.isRegExp,B=U?L(U):O,D=i["__core-js_shared__"],q=(R=/[^.]+$/.exec(D&&D.keys&&D.keys.IE_PROTO||""))?"Symbol(src)_1."+R:"";var H=function isMasked(e){return!!q&&q in e},$=Function.prototype.toString;var z=function toSource(e){if(null!=e){try{return $.call(e)}catch(e){}try{return e+""}catch(e){}}return""},K=/^\[object .+?Constructor\]$/,V=Function.prototype,G=Object.prototype,W=V.toString,J=G.hasOwnProperty,Y=RegExp("^"+W.call(J).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var X=function baseIsNative(e){return!(!h(e)||H(e))&&(f(e)?Y:K).test(z(e))};var Q=function getValue(e,t){return null==e?void 0:e[t]};var Z=function getNative(e,t){var r=Q(e,t);return X(r)?r:void 0},ee=Z(Object,"create");var te=function hashClear(){this.__data__=ee?ee(null):{},this.size=0};var re=function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},se=Object.prototype.hasOwnProperty;var ne=function hashGet(e){var t=this.__data__;if(ee){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return se.call(t,e)?t[e]:void 0},ie=Object.prototype.hasOwnProperty;var oe=function hashHas(e){var t=this.__data__;return ee?void 0!==t[e]:ie.call(t,e)};var ae=function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=ee&&void 0===t?"__lodash_hash_undefined__":t,this};function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var s=e[t];this.set(s[0],s[1])}}Hash.prototype.clear=te,Hash.prototype.delete=re,Hash.prototype.get=ne,Hash.prototype.has=oe,Hash.prototype.set=ae;var ce=Hash;var de=function listCacheClear(){this.__data__=[],this.size=0};var me=function eq(e,t){return e===t||e!=e&&t!=t};var pe=function assocIndexOf(e,t){for(var r=e.length;r--;)if(me(e[r][0],t))return r;return-1},le=Array.prototype.splice;var ue=function listCacheDelete(e){var t=this.__data__,r=pe(t,e);return!(r<0)&&(r==t.length-1?t.pop():le.call(t,r,1),--this.size,!0)};var ge=function listCacheGet(e){var t=this.__data__,r=pe(t,e);return r<0?void 0:t[r][1]};var ye=function listCacheHas(e){return pe(this.__data__,e)>-1};var he=function listCacheSet(e,t){var r=this.__data__,s=pe(r,e);return s<0?(++this.size,r.push([e,t])):r[s][1]=t,this};function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var s=e[t];this.set(s[0],s[1])}}ListCache.prototype.clear=de,ListCache.prototype.delete=ue,ListCache.prototype.get=ge,ListCache.prototype.has=ye,ListCache.prototype.set=he;var fe=ListCache,ve=Z(i,"Map");var Te=function mapCacheClear(){this.size=0,this.__data__={hash:new ce,map:new(ve||fe),string:new ce}};var be=function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var Se=function getMapData(e,t){var r=e.__data__;return be(t)?r["string"==typeof t?"string":"hash"]:r.map};var Me=function mapCacheDelete(e){var t=Se(this,e).delete(e);return this.size-=t?1:0,t};var ke=function mapCacheGet(e){return Se(this,e).get(e)};var _e=function mapCacheHas(e){return Se(this,e).has(e)};var we=function mapCacheSet(e,t){var r=Se(this,e),s=r.size;return r.set(e,t),this.size+=r.size==s?0:1,this};function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var s=e[t];this.set(s[0],s[1])}}MapCache.prototype.clear=Te,MapCache.prototype.delete=Me,MapCache.prototype.get=ke,MapCache.prototype.has=_e,MapCache.prototype.set=we;var Ie=MapCache;var Ce=function setCacheAdd(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this};var Ee=function setCacheHas(e){return this.__data__.has(e)};function SetCache(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new Ie;++t<r;)this.add(e[t])}SetCache.prototype.add=SetCache.prototype.push=Ce,SetCache.prototype.has=Ee;var xe=SetCache;var Pe=function baseFindIndex(e,t,r,s){for(var n=e.length,i=r+(s?1:-1);s?i--:++i<n;)if(t(e[i],i,e))return i;return-1};var Ae=function baseIsNaN(e){return e!=e};var je=function strictIndexOf(e,t,r){for(var s=r-1,n=e.length;++s<n;)if(e[s]===t)return s;return-1};var Oe=function baseIndexOf(e,t,r){return t==t?je(e,t,r):Pe(e,Ae,r)};var Fe=function arrayIncludes(e,t){return!!(null==e?0:e.length)&&Oe(e,t,0)>-1};var Re=function arrayIncludesWith(e,t,r){for(var s=-1,n=null==e?0:e.length;++s<n;)if(r(t,e[s]))return!0;return!1};var Le=function arrayMap(e,t){for(var r=-1,s=null==e?0:e.length,n=Array(s);++r<s;)n[r]=t(e[r],r,e);return n};var Ne=function cacheHas(e,t){return e.has(t)};var Ue=function baseDifference(e,t,r,s){var n=-1,i=Fe,o=!0,a=e.length,c=[],d=t.length;if(!a)return c;r&&(t=Le(t,L(r))),s?(i=Re,o=!1):t.length>=200&&(i=Ne,o=!1,t=new xe(t));e:for(;++n<a;){var m=e[n],p=null==r?m:r(m);if(m=s||0!==m?m:0,o&&p==p){for(var l=d;l--;)if(t[l]===p)continue e;c.push(m)}else i(t,p,s)||c.push(m)}return c};var Be=function identity(e){return e};var De=function apply(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)},qe=Math.max;var He=function overRest(e,t,r){return t=qe(void 0===t?e.length-1:t,0),function(){for(var s=arguments,n=-1,i=qe(s.length-t,0),o=Array(i);++n<i;)o[n]=s[t+n];n=-1;for(var a=Array(t+1);++n<t;)a[n]=s[n];return a[t]=r(o),De(e,this,a)}};var $e=function constant(e){return function(){return e}},ze=function(){try{var e=Z(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),Ke=ze?function(e,t){return ze(e,"toString",{configurable:!0,enumerable:!1,value:$e(t),writable:!0})}:Be,Ve=Date.now;var Ge=function shortOut(e){var t=0,r=0;return function(){var s=Ve(),n=16-(s-r);if(r=s,n>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}},We=Ge(Ke);var Je=function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var Ye=function isArrayLike(e){return null!=e&&Je(e.length)&&!f(e)};var Xe=function isArrayLikeObject(e){return j(e)&&Ye(e)},Qe=function baseRest(e,t){return We(He(e,t,Be),e+"")}((function(e,t){return Xe(e)?Ue(e,t):[]}));function replacer(e,t){return t instanceof RegExp?"__REGEXP "+t.toString():t}function validate(e,t={},r){const s={};return Object.keys(e).forEach((n=>{const i=e[n].type,o=r?`In ${r}, `:"";if(void 0===t[n]){if(!1===e[n].required)return void(s[n]=t[n]);throw new ValidateError(`${o}param "${n}" is required`,{key:n},"required")}const a=Ze[i];if(a&&!a(t,n,e[n]))throw new ValidateError(`${o}param "${n}" expects ${JSON.stringify(e[n],replacer)}`,{key:n,value:t[n]},JSON.stringify(e[n]));s[n]=t[n]})),s}const Ze={string:function(e,t,r){const{allowEmpty:s,max:n,min:i,regExp:o}=r,a=e[t];return"string"==typeof a&&((!1!==s||""!==a)&&(!("number"==typeof n&&a.length>n)&&(!("number"==typeof i&&a.length<i)&&!(B(o)&&!o.test(a)))))},number:function(e,t,r){const{min:s,max:n}=r,i=e[t];return"number"==typeof i&&(!("number"==typeof s&&i<s)&&!("number"==typeof n&&i>n))},boolean:function(e,t){return"boolean"==typeof e[t]},enum:function(e,t,r){const{values:s}=r,n=e[t];return!s||s.indexOf(n)>-1},array:function(e,t,r){const{itemType:s,rules:n,min:i,max:o,values:a}=r,c=e[t];return!!Array.isArray(c)&&(!("number"==typeof o&&c.length>o)&&(!("number"==typeof i&&c.length<i)&&(!(s&&"enum"!==s&&!c.every((e=>typeof e===s)))&&(("enum"!==s||!a||!Qe(c,...a).length)&&(n&&c.forEach(((e,r)=>validate(n,e,`${t}[${r}]`))),!0)))))},object:function(e,t,r){const{rules:s}=r,n=e[t];return s&&validate(s,n,t),!0}};var et=Z(i,"Set");var rt=function noop(){};var st=function setToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r},nt=et&&1/st(new et([,-0]))[1]==1/0?function(e){return new et(e)}:rt;var it=function baseUniq(e,t,r){var s=-1,n=Fe,i=e.length,o=!0,a=[],c=a;if(r)o=!1,n=Re;else if(i>=200){var d=t?null:nt(e);if(d)return st(d);o=!1,n=Ne,c=new xe}else c=t?[]:a;e:for(;++s<i;){var m=e[s],p=t?t(m):m;if(m=r||0!==m?m:0,o&&p==p){for(var l=c.length;l--;)if(c[l]===p)continue e;t&&c.push(p),a.push(m)}else n(c,p,r)||(c!==a&&c.push(p),a.push(m))}return a};var ot=function uniq(e){return e&&e.length?it(e):[]};const at=function(){const _s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return function(){return _s4()+_s4()+_s4()+_s4()+_s4()+_s4()+_s4()+_s4()}}();function getEnumKeys(e){return Object.keys(e).filter((e=>!(+e>=0)))}function getEnumKeyByEnumValue(e,t){const r=Object.keys(e).filter((r=>e[r]==t));return r.length>0?r[0]:void 0}function getAccountFromSessionId(e,t="-"){if(!e)throw new Error("No sessionId");const r=e.indexOf(t);if(-1===r)throw new Error("Can not find conjunctions");const s=e.slice(0,r);return{accid:e.slice(r+1),scene:"super_team"===s?"superTeam":s}}class TimerManager{constructor(){this.timerList=[],this.id=0,this.timer=null,this.timeout=0}addTimer(e,t=0,r=1){const s=(new Date).getTime(),n=this.id;return this.timerList.push({id:n,loop:r,count:0,timeout:s+t,interval:t,callback:e}),this.id++,this.checkTimer(s),n}checkTimer(e=(new Date).getTime()){if(this.removeFinished(),0===this.timerList.length&&null!=this.timer)return;let t=0;for(const e of this.timerList)(0===t||t>e.timeout)&&(t=e.timeout);0!==this.timerList.length&&(null===this.timer||t<this.timeout||this.timeout<e)&&(this.timer=setTimeout(this.nowTime.bind(this),t-e),this.timeout=t)}nowTime(){const e=(new Date).getTime();for(const t of this.timerList)e>=t.timeout&&(t.callback(),t.count++,t.timeout=e+t.interval);this.clerTime(),this.checkTimer(e)}clerTime(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)}deleteTimer(e){for(let t=this.timerList.length-1;t>=0;t--){this.timerList[t].id===e&&this.timerList.splice(t,1)}}removeFinished(){for(let e=this.timerList.length-1;e>=0;e--){const t=this.timerList[e];t.loop>=0&&t.count>=t.loop&&this.timerList.splice(e,1)}}destroy(){this.clerTime(),this.timerList=[],this.id=0,this.timer=null}}class CoreAdapters{constructor(e){this.core=e}request(e,t){const r=(new Date).getTime();return w.request(e,t).catch((s=>{var n,i;const o=s;throw this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(i=null===(n=this.core)||void 0===n?void 0:n.socket)||void 0===i?void 0:i.sessionId,start_time:r,action:1}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof o.code?o.code:0,description:o.message||`${o.code}`,operation_type:0,target:e,context:t?JSON.stringify(t):""}),this.core.reporter.reportTraceEnd("exceptions",1),s}))}uploadFile(e){const t=(new Date).getTime();return w.uploadFile(e).catch((r=>{var s,n;const i=r;this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(n=null===(s=this.core)||void 0===s?void 0:s.socket)||void 0===n?void 0:n.sessionId,start_time:t,action:1});const o="BROWSER"===w.platform?e.chunkUploadHost:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken&&e.nosToken.bucket}`:"https://nos.netease.com/nim";throw this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof i.code?i.code:0,description:i.message||`${i.code}`,operation_type:1,target:o}),this.core.reporter.reportTraceEnd("exceptions",1),r}))}}var ct;!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(ct||(ct={}));const dt=window&&f(window.addEventListener)&&f(window.removeEventListener);class Core extends t{constructor(e,s){super(),this.status="unconnected",this.linkUrls=[],this.eventBus=new t,this.packetSer=1,this.retryCount=0,this.reconnectTimer=0,this.backoff=new r({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.config=v,this.abtInfo={},validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),this.options=Object.assign(Object.assign({},T),e),this.adapters=new CoreAdapters(this);let n=w.localStorage.getItem("__NIM_DEVC_ID__");this.options.isFixedDeviceId?(n=w.localStorage.getItem("__NIM_DEVC_ID__")||at(),w.localStorage.setItem("__NIM_DEVC_ID__",n)):n=at(),this.config=Object.assign(Object.assign(Object.assign({},v),s),{deviceId:n}),this.timerManager=new TimerManager,this.logger=new Logger(this.options.debugLevel,this.options.account);const i=w.getSystemInfo();this.reporter=new _({common:{app_key:e.appkey,dev_id:n,platform:"Web",sdk_ver:"0.13.0",env:"online",os_name:i.os,os_ver:i.osVer,host_env:i.hostEnv,host_info:i.hostInfo,host_env_ver:i.hostEnvVer},request:w.request,logger:this.logger,autoStart:"BROWSER"===w.platform}),w.setLogger(this.logger),this.logger.log("Core init, version ","0.13.0"," sdk version ",91e3," appkey ",e.appkey)}connect(e={}){return __awaiter(this,void 0,void 0,(function*(){if(validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),!/^(unconnected|waitReconnect)$/.test(this.status)){const e=`Core socket status is ${this.status}, and would not connect`;return this.logger.warn(e),Promise.reject(e)}this.status="connecting",e.linkUrls&&e.linkUrls.length>0&&(this.linkUrls=e.linkUrls.concat(this.linkUrls),this.linkUrls=ot(this.linkUrls)),0===this.linkUrls.length&&this.linkUrls.push(b);for(let e=0;e<this.linkUrls.length;e++){const t=this.linkUrls[e],r=(new Date).getTime();try{return yield this.doConnect(t),this.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:200,succeed:!0}),this.status="connected",this.logger.log(`core:: connect success with url: ${t}`),this.abtRequest(),t}catch(e){const s=e;this.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:s.code||408,description:`ws_handshake_failed:${s.message}`,succeed:!1}),this.reporter.reportTraceStart("exceptions",{user_id:this.options.account,start_time:r,action:0}),this.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof s.code?s.code:0,description:s.message||`${s.code}`,operation_type:0,target:t}),this.reporter.reportTraceEnd("exceptions",1),this.logger.warn(`core:: connect failed with url: ${t}`,e)}}throw this.reporter.reportTraceEnd("login",!1),0===this.retryCount?this.doDisconnect(ct.ACTIVE,"SocketHandshakeFailed"):this.doDisconnect(ct.OFFLINE,"ReconnectHadRetryAllLinks"),new Error("core: socket handshake failed")}))}doConnect(e){return new Promise(((t,r)=>{this.socket=new NIMWebsocket(this,e,this.logger),this.socket.on("connect",(()=>{this.logger.log("socket on connect",e),t()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(e=>{this.logger.log("core:: socket on disconnect",e),this.doDisconnect(ct.OFFLINE,"SocketOnDisconnect")})),this.socket.on("handshakeFailed",(()=>{this.logger.warn("core:: socket handshake failed"),r(new CustomError("handshake failed",{},408))}))}))}resetConnectStatus(){clearTimeout(this.reconnectTimer),this.backoff.reset(),this.retryCount=0,this.initOnlineListener()}doDisconnect(e,t){if(this.logger.log(`doDisconnect: type ${e}, description ${t}`),"unconnected"===this.status)return void this.logger.warn("doDisconnect: already unconnected");this.markAllCmdInvaild(new CustomError("Packet timeout due to instance disconnect",{},408)),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0);const r=!this.options.needReconnect||this.retryCount>=this.options.reconnectionAttempts;if(e===ct.ACTIVE||r)this.logger.log("doDisconnect: emit disconnect, type "+e,r),this.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.eventBus.emit("disconnect"),this.emit("disconnect"),this.destroyOnlineListener();else if(e===ct.KICKED){this.logger.log("doDisconnect: kicked"),this.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer);const e="string"==typeof t?{reason:"unknow",message:t}:t;this.eventBus.emit("kicked",e),this.emit("kicked",e),this.destroyOnlineListener()}else e===ct.OFFLINE?(this.logger.log("doDisconnect: start to reconnect"),this.attempToReconnect()):this.logger.log("doDisconnect: nothing to do")}attempToReconnect(){if("waitReconnect"===this.status)return void this.logger.warn("doDisconnect: already is waiting reconnect");const e=this.backoff.duration();this.retryCount++,this.logger.log(`willReconnect ${this.retryCount} ${e}`),this.eventBus.emit("willReconnect",{retryCount:this.retryCount,duration:e}),this.emit("willReconnect",{retryCount:this.retryCount,duration:e}),this.status="waitReconnect",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout((()=>{"waitReconnect"===this.status?this.connect({isAutoReconnect:!0}).catch((()=>{this.logger.error(`core::attempToReconnect failed ${this.retryCount}`)})):this.logger.warn(`doDisconnect: reconnectTimer status is ${this.status}, would not go on reconnecting`)}),e)}sendCmd(e,t,r){if("logined"!==this.status&&"login"!==e&&"chatroomLogin"!==e&&"qchatLogin"!==e)return this.logger.warn(`nim status is ${this.status}, so can not sendCmd ${e}`),Promise.reject({cmd:e,error:{code:"No_connected",message:"Connection not established",timetag:(new Date).getTime()}});if(!this.socket||!this.socket.send)return Promise.reject("No_socket");const s="heartbeat"!==e,n=s?this.packetSer++:0,i=function createCmd(e,t,r,s){const n=C[e];if(!n)return r.error("createCmd:: can not find cmd config: ",e),null;const i={SER:t,SID:n.sid,CID:n.cid,Q:[]};return n.params&&s&&n.params.forEach((function(e){let t=s[e.name];if(I(t))return;let r=e.type;const{reflectMapper:n}=e;switch(e.type){case"PropertyArray":r="ArrayMable",t=t.map((e=>({t:"Property",v:n?serialize(e,n):e})));break;case"Property":t=n?serialize(t,n):t;break;case"Bool":case"bool":t=t?"true":"false"}i.Q.push({t:r,v:t})})),{packet:i,isNoResponse:n.isNoResponse||!1}}(e,n,this.logger,t);if(!i){const t=`SendCmd ${n} ${e} error`;return this.logger.error(t),Promise.reject(t)}const{packet:o,isNoResponse:a}=i,c=JSON.stringify(o);s&&("debug"===this.options.debugLevel?this.logger.debug("core::sendCmd",e,`ser:${n}`,c):this.logger.log("core::sendCmd",e,`ser:${n}`));const d=(new Date).getTime();return new Promise(((s,i)=>{this.sendingCmdMap.set(n,{cmd:e,params:t,callback:[s,i],timer:a?null:setTimeout((()=>{var t;const r=new CmdError(504,e,"Packet Timeout",(new Date).getTime(),{message:`ser ${n} cmd ${e} timeout`});r.callFunc="sendCmd",this.markCmdInvalid(n,r,e),this.reporter.reportTraceStart("exceptions",{user_id:this.options.account,trace_id:null===(t=this.socket)||void 0===t?void 0:t.sessionId,start_time:d,action:2}),this.reporter.reportTraceUpdateV2("exceptions",{code:408,description:"Packet timeout",operation_type:1,target:`${o.SID}-${o.CID}`,context:`${o.SER}`}),this.reporter.reportTraceEnd("exceptions",1)}),r&&r.timeout?r.timeout:this.config.timeout)});try{this.socket.send(c)}catch(t){const r=new CmdError(415,e,t&&t.message||"Unable to send packet",(new Date).getTime(),{message:"send json error",rawError:t});r.callFunc="sendCmd",this.markCmdInvalid(n,r,e),i(t)}}))}onMessage(e){const t=parseCmd(e,this.logger);if(!t)return;const r=t.raw.ser;if(t.error&&this.logger.error("core:onMessage packet error",`${t.raw.sid}_${t.raw.cid}, ser:${r},`,t.error),!t.notFound)return"heartbeat"!==t.cmd&&("debug"===this.options.debugLevel?this.logger.debug(`imsocket::recvCmd ser:${r}`,t.cmd,t.content):this.logger.log(`imsocket::recvCmd ser:${r}`,t.cmd)),t.__receiveTime=Date.now(),t;this.logger.warn("core::onMessage packet not found",`${t.raw.sid}_${t.raw.cid}, ser:${r}`)}markCmdInvalid(e,t,r){const s=this.sendingCmdMap.get(e);if(!s)return;const{callback:n,timer:i}=s;i&&clearTimeout(i),this.sendingCmdMap.delete(e),this.logger.warn(`packet ${e}, ${r} is invalid:`,t),n[1](t)}markAllCmdInvaild(e){this.logger.log("markAllCmdInvaild"),this.sendingCmdMap.forEach((t=>{const{callback:r,timer:s}=t;s&&clearTimeout(s),r[1](e)})),this.sendingCmdMap.clear()}ping(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(e){if(yield this.testHeartBeat5Timeout())return void this.doDisconnect(ct.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(let e=0;e<5;e++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(t){this.logger.debug(`core:: test heartbeat ${e} Timeout`)}return!0}))}initOnlineListener(){this.onlineListener||(dt?(this.onlineListener=function(){"logined"===this.status&&this.ping()}.bind(this),this.offlineListener=function(){this.logger.log("offline"),this.doDisconnect(ct.OFFLINE,"OfflineListener")}.bind(this),window.addEventListener("online",this.onlineListener),window.addEventListener("offline",this.offlineListener)):this.logger.warn("initOnlineListener not support add listener"))}destroyOnlineListener(){this.onlineListener&&(window.removeEventListener("online",this.onlineListener),this.onlineListener=void 0),this.offlineListener&&(window.removeEventListener("offline",this.offlineListener),this.offlineListener=void 0)}disconnect(){switch(this.status){case"connected":case"logined":case"connecting":case"waitReconnect":return this.doDisconnect(ct.ACTIVE,"UserActiveDisconnect"),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}destroy(){return this.disconnect().then((()=>{this.status="destroyed",this.removeAllListeners(),this.eventBus.removeAllListeners(),this.reporter.destroy(),this.connect=()=>Promise.resolve(),this.disconnect=()=>Promise.resolve(),this.destroy=()=>Promise.resolve()}))}abtRequest(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(!this.options.isAbtestEnable)return;if(this.abtInfo.experiments)return;if(!this.options.abtestUrl)return;let r;try{r=yield this.adapters.request(this.options.abtestUrl,{method:"POST",dataType:"json",headers:{sdktype:"ABTest"},params:{clientInfo:{projectKey:this.options.abtestProjectKey,appKey:this.options.appkey,osType:"Web",sdkVersion:"0.13.0",deviceId:this.config.deviceId},useLocalCache:!0}})}catch(e){this.logger.warn("ABTest request failed")}this.abtInfo=(null===(t=null===(e=null==r?void 0:r.data)||void 0===e?void 0:e.data)||void 0===t?void 0:t.abtInfo)||{},this.abtInfo.experiments&&this.abtInfo.experiments.length>0&&this.reporter.reportImmediately("https://statistic.live.126.net/statics/report/abtest/result",{params:{app_key:this.options.appkey,biz_sdk_type:"IM",sdk_ver:"0.13.0",device_id:this.config.deviceId,platform:"Web",projectKey:this.options.abtestProjectKey,experiments:this.abtInfo.experiments.map((e=>({experimentKey:e.experimentKey,schemeKey:e.schemeKey})))},headers:{sdktype:"ABTest"},method:"POST",dataType:"json"})}))}}Core.setAdapters=function setAdapters(e){Object.assign(w,e)};const mt={"1_2":"heartbeat","2_3":"login","2_5":"kicked","2_6":"logout","2_7":"multiPortLogin","2_8":"kick"},pt={login:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,deviceId:13,appkey:18,account:19,browser:24,session:26,deviceInfo:32,isReactNative:112,token:1e3,customTag:38,customClientType:39,sdkHumanVersion:40,sdkType:41,userAgent:42,authType:115,loginExt:116},loginRes:{lastLoginDeviceId:17,customTag:38,connectionId:102,ip:103,port:104,country:106,hasXMPush:111},loginPort:{type:3,os:4,mac:5,deviceId:13,account:19,deviceInfo:32,customTag:38,connectionId:102,ip:103,time:109},aosPushInfo:{pushType:110,hasTokenPreviously:111}},lt=invertSerializeMap(pt),ut={login:{sid:2,cid:3,service:"auth",params:[{type:"Property",name:"login",reflectMapper:pt.login}],response:[{type:"Property",name:"loginRes",reflectMapper:lt.loginRes},{type:"PropertyArray",name:"loginPorts",reflectMapper:lt.loginPort},{type:"Property",name:"aosPushInfo",reflectMapper:lt.aosPushInfo}]},logout:{sid:2,cid:6,service:"auth"},heartbeat:{sid:1,cid:2,service:"auth"},kicked:{sid:2,cid:5,service:"auth",response:[{type:"Number",name:"clientType"},{type:"Number",name:"reason"},{type:"String",name:"ext"},{type:"Number",name:"customClientType"}]},multiPortLogin:{sid:2,cid:7,service:"auth",response:[{type:"Number",name:"state"},{type:"PropertyArray",name:"loginPorts",reflectMapper:lt.loginPort}]},kick:{sid:2,cid:8,service:"auth",params:[{type:"StrArray",name:"deviceIds"}],response:[{type:"StrArray",name:"deviceIds"}]}};var gt=Array.isArray;var yt=function isSymbol(e){return"symbol"==typeof e||j(e)&&"[object Symbol]"==y(e)},ht=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ft=/^\w*$/;var vt=function isKey(e,t){if(gt(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!yt(e))||(ft.test(e)||!ht.test(e)||null!=t&&e in Object(t))};function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var memoized=function(){var r=arguments,s=t?t.apply(this,r):r[0],n=memoized.cache;if(n.has(s))return n.get(s);var i=e.apply(this,r);return memoized.cache=n.set(s,i)||n,i};return memoized.cache=new(memoize.Cache||Ie),memoized}memoize.Cache=Ie;var Tt=memoize;var bt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,St=/\\(\\)?/g,Mt=function memoizeCapped(e){var t=Tt(e,(function(e){return 500===r.size&&r.clear(),e})),r=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(bt,(function(e,r,s,n){t.push(s?n.replace(St,"$1"):r||e)})),t})),kt=o?o.prototype:void 0,_t=kt?kt.toString:void 0;var wt=function baseToString(e){if("string"==typeof e)return e;if(gt(e))return Le(e,baseToString)+"";if(yt(e))return _t?_t.call(e):"";var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var It=function toString(e){return null==e?"":wt(e)};var Ct=function castPath(e,t){return gt(e)?e:vt(e,t)?[e]:Mt(It(e))};var Et=function toKey(e){if("string"==typeof e||yt(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var xt=function baseGet(e,t){for(var r=0,s=(t=Ct(t,e)).length;null!=e&&r<s;)e=e[Et(t[r++])];return r&&r==s?e:void 0};var Pt=function get(e,t,r){var s=null==e?void 0:xt(e,t);return void 0===s?r:s};const At={debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,lbsUrls:["https://lbs.netease.im/lbs/webconf.jsp"],linkUrl:b,isAbtestEnable:!0,abtestUrl:"https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",abtestProjectKey:"imElite_sdk_abtest_web"},jt={};class NIM extends Core{constructor(e,t={serverConfig:{},syncOptions:{},sessionConfig:{}}){super(e),this.instanceName="NIM",this.account="",this.options={},this.auth={},this.offlinePush={},this.sync={},this.msg={},this.msgLog={},this.session={},this.cloudSession={},this.misc={},this.user={},this.friend={},this.systemMessage={},this.team={},this.event={},this.msgExtend={},this.cloudStorage={},this.passThrough={},this.superTeam={},this.plugin={},this.signaling={},this.setOptions(e),registerParser({cmdMap:mt,cmdConfig:ut});let r=null;Object.keys(jt).forEach((e=>{const s=jt[e];"sync"===e?r=s:this[e]="session"===e?new s(this,t.sessionConfig):"cloudStorage"===e?new s(this,Object.assign({storageKeyPrefix:this.instanceName},t.serverConfig,t.cloudStorageConfig)):new s(this)})),r&&(this.sync=new r(this,t.syncOptions)),this.eventBus.on("willReconnect",(()=>{this.reporter.reportTraceStart("login",{user_id:this.account,action:"auto_login"}),this.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(Object.assign(Object.assign({},this.options),{account:"***",token:"***"})),duration:0,operation_type:"conf_init",succeed:!0,target:""})})),NIM.instance=this}static getInstance(e,t){if(!NIM.instance){if(e)return new NIM(e,t);throw new Error("Instance not exist, please input options")}if(e){if(NIM.instance.options.account===e.account&&NIM.instance.options.appkey===e.appkey)return NIM.instance.setOptions(e),NIM.instance;throw new Error("Unexpected login")}return NIM.instance}setOptions(e){validate({account:{type:"string"},appkey:{type:"string"},token:{type:"string"},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e),this.logger.log("NIM::setOptions options is",e),this.account=e.account,this.options=Object.assign(Object.assign({},At),e)}connect(e={}){const t=Object.create(null,{connect:{get:()=>super.connect}});return __awaiter(this,void 0,void 0,(function*(){if(!/^(unconnected|waitReconnect)$/.test(this.status)){const e=`NIM status is ${this.status}, and would not connect`;return this.logger.warn(e),Promise.reject(e)}e.isAutoReconnect||(this.reporter.reportTraceStart("login",{user_id:this.options.account,action:"manual_login"}),this.reporter.reportTraceUpdateV2("login",{code:0,description:JSON.stringify(Object.assign(Object.assign({},this.options),{account:"***",token:"***"})),operation_type:"conf_init",succeed:!0,duration:0,target:""})),yield this.getLbsInfos(),yield t.connect.call(this,e),yield this.login(e.isAutoReconnect)}))}login(e=!1){return __awaiter(this,void 0,void 0,(function*(){let t;try{t=yield this.auth.doLogin(e),this.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:200,succeed:!0}),this.reporter.reportTraceEnd("login",!0),this.status="logined"}catch(e){const t=e;if(this.logger.warn("nim login:: login failed",e),this.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:t.code||0,succeed:!1,description:t.message}),this.reporter.reportTraceEnd("login",!1),0===this.retryCount)throw this.doDisconnect(ct.ACTIVE,"FailedToInitializeLogin"),e;return void this.doDisconnect(ct.OFFLINE,"ReconnectLoginFailed")}try{yield this.cloudStorage.init()}catch(e){this.logger.error("NIM:login cloudStorage init failed ",e)}this.eventBus.emit("logined",t),this.emit("logined",t),this.logger.log("login done"),this.resetConnectStatus(),this.sync&&this.sync.doSync&&(yield this.sync.doSync()),this.ping()}))}onMessage(e){var t,r;const s=super.onMessage(e);if(!s)return;const n=s.raw.ser,i=this.sendingCmdMap.get(n);if(i&&i.cmd===s.cmd){const{callback:e,timer:r,params:o}=i;if(clearTimeout(r),s.params=o,this.sendingCmdMap.delete(n),"heartbeat"===s.cmd)return void e[0]();const a=null===(t=this[s.service])||void 0===t?void 0:t.process(s);a&&"function"==typeof a.then?a.then((t=>{e[0](t)})).catch((t=>{e[1](t)})):(this.logger.log("imsocket:: handlerFn without promise",s.service,s.cmd),e[0]())}else null===(r=this[s.service])||void 0===r||r.process(s)}getLbsInfos(){var e;return __awaiter(this,void 0,void 0,(function*(){const t=this.options.lbsUrls[0],r=t.indexOf("?")>-1?"&":"?",s=t+r+"k="+this.options.appkey+"&id="+this.options.account+"&sv=180&pv=1&networkType=0";try{this.logger.log("getLbsInfos ",s);const t=yield this.adapters.request(s,{method:"GET",dataType:"json",timeout:1e4});if(200!==t.status||!t.data)throw this.logger.error("getLbsInfos::error status",t.status,t),new Error(`getLbsInfos failed, status ${t.status}`);this.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:s,code:200,succeed:!0});const r=t.data;let n=[this.options.linkUrl];Pt(r,"common.link")&&(n=Pt(r,"common.link").concat(n)),Pt(r,'common["link.default"]')&&(n=n.concat(Pt(r,'common["link.default"]'))),this.linkUrls=ot(n),t.data["nos-chunk"]&&(null===(e=this.cloudStorage)||void 0===e||e.setOptions({chunkUploadHost:t.data["nos-chunk"]})),this.logger.log("getLbsInfos success, socket link:",this.linkUrls.slice(0),"chunkUploadHost: ",t.data["nos-chunk"])}catch(e){const t=e;this.logger.error("getLbsInfos::error",t),this.linkUrls=[this.options.linkUrl],this.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:s,description:t.message,code:t.code||0,succeed:!1})}}))}disconnect(){switch(this.status){case"connected":case"logined":return this.sendCmd("logout").then((()=>{super.doDisconnect(ct.ACTIVE,"UserActiveDisconnect")}));case"connecting":case"waitReconnect":return super.doDisconnect(ct.ACTIVE,"UserActiveDisconnect"),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}destroy(){return NIM.instance=null,super.destroy()}kick(e){return validate({deviceIds:{type:"array",itemType:"string"}},e),this.auth.kick(e)}static registerService(e,t){jt[t]=e}}NIM.instance=null;let Ot=console;const Ft={clear(){try{uni.clearStorageSync()}catch(e){Ot.error("uni-app::ws: clearStorage ",e)}},getItem:e=>uni.getStorageSync(e),setItem:(e,t)=>uni.setStorageSync(e,t),removeItem:e=>uni.removeStorageSync(e)};const Rt={setLogger(e){Ot=e},platform:"UNIAPP",localStorage:Ft,request:function request(e,t){return new Promise(((r,s)=>{uni.request(Object.assign(Object.assign({method:"GET",url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){s(e)}}))}))},WebSocket:class WebSocket{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.onclose=function(e){Ot.log("Adapter uniapp: sockets on close ",e)},this.onerror=function(e){Ot.error("Adapter uniapp: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(e){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;const r=this.protocol?{protocols:this.protocol}:{};if("function"==typeof getApp){const e=getApp();if(e&&e.globalData&&e.globalData.__NIM_SDK_SOCKET_INTANCE_STATE)throw Ot.warn("warning: uniapp create socket:: Multiple websockets are created in uniapp, may lead to unexpected results"),new Error("Create websocket failed cause multiple websockets are not supported in uniapp")}uni.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{if("function"==typeof getApp){const e=getApp();e&&e.globalData&&(e.globalData.__NIM_SDK_SOCKET_INTANCE_STATE="CREATED")}}})),uni.onSocketOpen((e=>{this.readyState=this.OPEN,this.onmessage&&this.onmessage({type:"open",header:e})})),uni.onSocketError((e=>{if("function"==typeof getApp){const e=getApp();e&&e.globalData&&delete e.globalData.__NIM_SDK_SOCKET_INTANCE_STATE}this.errorHandler(e)})),uni.onSocketClose((e=>{Ot.log("uniapp socket closed"),this.readyState=this.CLOSED;const{code:t,reason:r,wasClean:s}=e;if("function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:s,type:"close"}),"function"==typeof getApp){const e=getApp();e&&e.globalData&&delete e.globalData.__NIM_SDK_SOCKET_INTANCE_STATE}})),uni.onSocketMessage((e=>{const{data:t,origin:r,ports:s,source:n}=e;this.onmessage&&this.onmessage({data:t,origin:r,ports:s,source:n,type:"message"})}))}close(){uni.closeSocket({code:1e3,reason:"user force close websocket",complete:()=>{}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`Adapter uniapp: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("Adapter uniapp: socket sendMsg only String/ArrayBuffer supported");uni.sendSocketMessage({data:e})}errorHandler(e){this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg}),e.errMsg&&"[object Array]"===Object.prototype.toString.call(e.errMsg)&&(e.errMsg.indexOf("æ­è£ç®¡é")>0||e.errMsg.indexOf("broken pipe")>0)&&this.onclose&&this.onclose({code:1006,reason:e&&e.errMsg,type:"close"})}},uploadFile:function uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{const s=uni.uploadFile({url:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken.bucket}`:"https://nos.netease.com/nim",formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",fileType:e.type,filePath:e.filePath,success(s){if(200==s.statusCode)try{const r=JSON.parse(s.data);r.name=e.filePath,r.ext=r.name.lastIndexOf(".")>-1?r.name.slice(r.name.lastIndexOf(".")+1).toLowerCase():"",t(r)}catch(e){r(new Error(`Upload Error parse result error: ${s.data}`))}else r(new Error(`Upload error ${s.statusCode}: ${s.errMsg}`))},fail(e){r(e)}});try{e.onUploadStart&&e.onUploadStart(s)}catch(e){Ot.error("Adapter uploadFile: options.onUploadStart error",e&&e.message),s.abort(),r(e)}e.onUploadProgress&&s.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))},getSystemInfo:function getSystemInfo(){const e=uni.getSystemInfoSync()||{};return{os:e.osName||"UNIAPP_UNKNOW",osVer:e.osVersion,browser:e.browserName||"",browserVer:e.browserVersion||"",hostEnv:e.hostName,hostEnvVer:e.hostVersion,hostInfo:e.uniPlatform,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}};class Service{constructor(e,t){this.name=e,this.core=t,this.name=e,this.logger=t.logger,this.core=t}process(e){const t=this[e.cmd+"Handler"];return"function"==typeof t?t.call(this,e):e.error&&!e.error.ignore?Promise.reject(e.error):Promise.resolve(e)}}var Lt,Nt,Ut,Bt,Dt;!function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(Lt||(Lt={})),function(e){e[e.p2p=0]="p2p",e[e.team=1]="team",e[e.superTeam=5]="superTeam"}(Nt||(Nt={})),function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac"}(Ut||(Ut={})),function(e){e[e.unread=1]="unread",e[e.read=2]="read",e[e.deleted=3]="deleted",e[e.sending=4]="sending",e[e.sendFailed=5]="sendFailed",e[e.sent=6]="sent",e[e.receipt=7]="receipt",e[e.refused=10]="refused"}(Bt||(Bt={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(Dt||(Dt={}));var qt=function overArg(e,t){return function(r){return e(t(r))}},Ht=qt(Object.getPrototypeOf,Object),$t=Function.prototype,zt=Object.prototype,Kt=$t.toString,Vt=zt.hasOwnProperty,Gt=Kt.call(Object);var Wt=function isPlainObject(e){if(!j(e)||"[object Object]"!=y(e))return!1;var t=Ht(e);if(null===t)return!0;var r=Vt.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&Kt.call(r)==Gt};function format(e,t){if(!Wt(t))return{};const r=JSON.parse(JSON.stringify(t)),s=doFormat(e,r);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},r),s)))}function doFormat(e,t){if(!Wt(t))return{};const r={};return Object.keys(e).forEach((s=>{const n=e[s].type;if("string"!=typeof n){const n=doFormat(e[s],t);return void(Object.keys(n).length>0&&(r[s]=n))}const i=e[s],o=i.rawKey||s,a=Jt[n](t,o,i);void 0!==a&&(t[o]=void 0,r[s]=a)})),r}const Jt={number:function(e,t){if(void 0!==e[t])return+e[t]},string:function(e,t){if(void 0!==e[t])return e[t]},boolean:function(e,t){return+e[t]>0||0!=+e[t]&&void 0},enum:function(e,t,r){return r.values[e[t]]},object:function(e,t){if(void 0!==e[t])try{return JSON.parse(e[t])}catch(e){return{}}}};function formatReverse(e,t){if(!Wt(t))return{};const r=JSON.parse(JSON.stringify(t)),s=doFormatReverse(e,r);return JSON.parse(JSON.stringify(Object.assign(Object.assign({},r),s)))}function doFormatReverse(e,t){if(!Wt(t))return Object.keys(e).reduce(((t,r)=>(t[e[r].rawKey||r]=void 0,t)),{});const r={};return Object.keys(e).forEach((s=>{const n=e[s].type;if("string"!=typeof n){const n=doFormatReverse(e[s],t[s]);return Object.assign(r,n),void(t[s]=void 0)}const i=e[s],o=i.rawKey||s,a=Yt[n](t,s,i);t[o]=void 0,r[o]=a})),r}const Yt={number:function(e,t){return e[t]},string:function(e,t){return e[t]},boolean:function(e,t){return!0===e[t]?1:!1===e[t]?0:void 0},enum:function(e,t,r){return r.values[e[t]]},object:function(e,t){if(void 0!==e[t])try{return JSON.stringify(e[t])}catch(e){return""}}};var Xt=function createBaseFor(e){return function(t,r,s){for(var n=-1,i=Object(t),o=s(t),a=o.length;a--;){var c=o[e?a:++n];if(!1===r(i[c],c,i))break}return t}}();var Qt=function baseTimes(e,t){for(var r=-1,s=Array(e);++r<e;)s[r]=t(r);return s};var Zt=function baseIsArguments(e){return j(e)&&"[object Arguments]"==y(e)},er=Object.prototype,tr=er.hasOwnProperty,rr=er.propertyIsEnumerable,sr=Zt(function(){return arguments}())?Zt:function(e){return j(e)&&tr.call(e,"callee")&&!rr.call(e,"callee")},nr=sr;var ir=function stubFalse(){return!1},or=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,s=r&&e&&!e.nodeType&&e,n=s&&s.exports===r?i.Buffer:void 0,o=(n?n.isBuffer:void 0)||ir;e.exports=o})),ar=/^(?:0|[1-9]\d*)$/;var cr=function isIndex(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&ar.test(e))&&e>-1&&e%1==0&&e<t},dr={};dr["[object Float32Array]"]=dr["[object Float64Array]"]=dr["[object Int8Array]"]=dr["[object Int16Array]"]=dr["[object Int32Array]"]=dr["[object Uint8Array]"]=dr["[object Uint8ClampedArray]"]=dr["[object Uint16Array]"]=dr["[object Uint32Array]"]=!0,dr["[object Arguments]"]=dr["[object Array]"]=dr["[object ArrayBuffer]"]=dr["[object Boolean]"]=dr["[object DataView]"]=dr["[object Date]"]=dr["[object Error]"]=dr["[object Function]"]=dr["[object Map]"]=dr["[object Number]"]=dr["[object Object]"]=dr["[object RegExp]"]=dr["[object Set]"]=dr["[object String]"]=dr["[object WeakMap]"]=!1;var mr=function baseIsTypedArray(e){return j(e)&&Je(e.length)&&!!dr[y(e)]},pr=N&&N.isTypedArray,lr=pr?L(pr):mr,ur=Object.prototype.hasOwnProperty;var gr=function arrayLikeKeys(e,t){var r=gt(e),s=!r&&nr(e),n=!r&&!s&&or(e),i=!r&&!s&&!n&&lr(e),o=r||s||n||i,a=o?Qt(e.length,String):[],c=a.length;for(var d in e)!t&&!ur.call(e,d)||o&&("length"==d||n&&("offset"==d||"parent"==d)||i&&("buffer"==d||"byteLength"==d||"byteOffset"==d)||cr(d,c))||a.push(d);return a},yr=Object.prototype;var hr=function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||yr)},fr=qt(Object.keys,Object),vr=Object.prototype.hasOwnProperty;var Tr=function baseKeys(e){if(!hr(e))return fr(e);var t=[];for(var r in Object(e))vr.call(e,r)&&"constructor"!=r&&t.push(r);return t};var br=function keys(e){return Ye(e)?gr(e):Tr(e)};var Sr=function baseForOwn(e,t){return e&&Xt(e,t,br)};var Mr=function baseInverter(e,t,r,s){return Sr(e,(function(e,n,i){t(s,r(e),n,i)})),s};var kr=function createInverter(e,t){return function(r,s){return Mr(r,e,t(s),{})}},_r=Object.prototype.toString,wr=kr((function(e,t,r){null!=t&&"function"!=typeof t.toString&&(t=_r.call(t)),e[t]=r}),$e(Be));const Ir=wr({Android:1,iOS:2,PC:4,WindowsPhone:8,Web:16,Server:32,Mac:64}),Cr={p2p:0,team:1,superTeam:5};var Er;function formatMultiPortLoginInfo(e,t){return e&&e.length>0?e.map((e=>Object.assign(Object.assign({},e),{account:e.account,connectionId:e.connectionId,deviceId:e.deviceId,ip:e.ip,mac:e.mac,os:e.os,type:Ir[e.type]||e.type,time:parseInt(e.time),online:3!==t}))):[]}wr(Cr),function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(Er||(Er={}));const xr={1:{reason:"samePlatformKick",message:"The same account is not allowed to multiple login at the same time"},2:{reason:"serverKick",message:"Kicked out by IM server"},3:{reason:"otherPlatformKick",message:"Kicked out by other client of your account"},4:{reason:"silentlyKick",message:"Quietly kicked"}};const Pr={BROWSER:0,RN:2,UNIAPP:3,WECHAT:6};const Ar=wr({none:0,normal:1,all:3}),jr={normal:0,advanced:1},Or=wr(jr),Fr=wr({normal:0,owner:1,manager:2}),Rr={noVerify:0,needVerify:1,rejectAll:2},Lr=wr(Rr),Nr={needVerify:0,noVerify:1},Ur=wr(Nr),Br={manager:0,all:1},Dr=wr(Br),qr={manager:0,all:1},Hr=wr(qr),$r={manager:0,all:1},zr=wr($r);function formatTeam(e){const t={type:Or,muteType:Ar,joinMode:Lr,beInviteMode:Ur,inviteMode:Dr,updateTeamMode:Hr,updateExtMode:zr},r=__rest(e,["bits"]);return["teamId"].forEach((e=>{r[e]&&(r[e]=r[e].toString())})),["level","memberNum","memberUpdateTime","createTime","updateTime"].forEach((e=>{void 0!==r[e]&&(r[e]=parseInt(r[e]))})),["valid","validToCurrentUser","mute"].forEach((e=>{void 0!==r[e]&&(r[e]=1===parseInt(r[e]))})),Object.keys(t).forEach((e=>{void 0!==r[e]&&(r[e]=t[e][r[e]]||r[e])})),r}function formatTeams(e){return e&&e.length>0?e.map((e=>formatTeam(e))):[]}function generateTeam(e){const t=Object.assign({},e),r={type:jr,joinMode:Rr,beInviteMode:Nr,inviteMode:Br,updateTeamMode:qr,updateExtMode:$r};return["avatar","name","intro","announcement","ext"].forEach((e=>{void 0!==t[e]&&(t[e]=t[e].toString())})),Object.keys(r).forEach((e=>{void 0!==t[e]&&(t[e]=r[e][t[e]])})),t}function generatorTeamMemberForCmd(e){const t={};return void 0!==e.bitConfigMask&&(t.bits=parseInt(e.bitConfigMask)),["teamId","ext","account","nickInTeam"].forEach((r=>{e[r]&&(t[r]=e[r].toString())})),t}function formatTeamMember(e){const t={type:Fr},{bits:r}=e,s=__rest(e,["bits"]);return void 0!==r&&(s.muteTeam=1===parseInt(r),s.bitConfigMask=r),s.id=`${s.teamId}-${s.account}`,["teamId"].forEach((e=>{s[e]&&(s[e]=s[e].toString())})),["joinTime","updateTime","bitConfigMask"].forEach((e=>{void 0!==s[e]&&(s[e]=parseInt(s[e]))})),["active","valid","mute"].forEach((e=>{void 0!==s[e]&&(s[e]=1===parseInt(s[e]))})),Object.keys(t).forEach((e=>{void 0!==s[e]&&(s[e]=t[e][s[e]]||s[e])})),s}function formatTeamMembers(e){return e&&e.length>0?e.map((e=>formatTeamMember(e))):[]}function generatorMemberByTeam(e,t,r="normal"){return{id:`${e.teamId}-${t}`,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersByTeam(e,t,r="normal"){return t&&t.length>0?t.map((t=>generatorMemberByTeam(e,t,r))):[]}var Kr;function formatUser(e){const t=Object.assign({},e);return t.createTime&&(t.createTime=+t.createTime),t.updateTime&&(t.updateTime=+t.updateTime),t.gender&&(t.gender=Kr[+t.gender]),t}!function(e){e[e.unknown=0]="unknown",e[e.male=1]="male",e[e.female=2]="female"}(Kr||(Kr={}));const Vr={"8_1":"createTeam","8_5":"addTeamMembers","8_6":"removeTeamMembers","8_7":"updateTeamInfo","8_8":"leaveTeam","8_9":"getTeamInfo","8_10":"getTeams","8_11":"getTeamMembers","8_12":"dismissTeam","8_13":"applyTeam","8_14":"passTeamApply","8_15":"rejectTeamApply","8_16":"addTeamManagers","8_17":"removeTeamManagers","8_18":"transferTeam","8_19":"updateMyMemberInfo","8_20":"updateNickInTeam","8_21":"acceptTeamInvite","8_22":"rejectTeamInvite","8_25":"muteTeamMember","8_27":"getMutedTeamMembers","8_28":"sendTeamMsgReceipt","8_29":"getTeamMsgReads","8_30":"getTeamMsgReadAccounts","8_31":"notifyTeamMsgReceipts","8_32":"muteTeam","8_33":"getTeamMemberInvitorAccid","8_34":"getTeamsById","8_101":"syncCreateTeam","8_109":"syncTeams","8_119":"syncUpdateTeamMember","8_126":"syncMyTeamMembers"},Gr={team:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},teamMsgReceiptTag:{teamId:0,idServer:1,read:100,unread:101,idClient:102,account:103},teamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,joinTime:10,updateTime:11,ext:12,mute:13,invitorAccid:14}},Wr=invertSerializeMap(Gr),Jr={getTeamInfo:{sid:8,cid:9,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:Wr.team}]},getTeams:{sid:8,cid:10,service:"team",params:[{type:"long",name:"timetag"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:Wr.team},{type:"Number",name:"timetag"}]},createTeam:{sid:8,cid:1,service:"team",params:[{type:"Property",name:"team",reflectMapper:Gr.team},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:Wr.team},{type:"StrArray",name:"abortedAccidList"}]},sendTeamMsgReceipt:{sid:8,cid:28,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:Gr.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:Wr.teamMsgReceiptTag}]},getTeamMsgReads:{sid:8,cid:29,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:Gr.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:Wr.teamMsgReceiptTag}]},getTeamMsgReadAccounts:{sid:8,cid:30,service:"team",params:[{type:"Property",name:"teamMsgReceiptTag",reflectMapper:Gr.teamMsgReceiptTag}],response:[{type:"Property",name:"teamMsgReceipt",reflectMapper:Wr.teamMsgReceiptTag},{type:"StrArray",name:"readAccounts"},{type:"StrArray",name:"unreadAccounts"}]},notifyTeamMsgReceipts:{sid:8,cid:31,service:"team",response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:Wr.teamMsgReceiptTag}]},dismissTeam:{sid:8,cid:12,service:"team",params:[{type:"Long",name:"teamId"}]},leaveTeam:{sid:8,cid:8,service:"team",params:[{type:"Long",name:"teamId"}]},transferTeam:{sid:8,cid:18,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"bool",name:"leave"}]},updateTeamInfo:{sid:8,cid:7,service:"team",params:[{type:"Property",name:"team",reflectMapper:Gr.team}],response:[{type:"Number",name:"id"},{type:"Number",name:"time"}]},getTeamsById:{sid:8,cid:34,service:"team",params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:Wr.team},{type:"StrArray",name:"tids"}],ignoreErrCodes:[816]},getTeamMembers:{sid:8,cid:11,service:"team",params:[{type:"Long",name:"teamId"},{type:"Long",name:"timetag"}],response:[{type:"String",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:Wr.teamMember},{type:"Number",name:"timetag"}]},getMutedTeamMembers:{sid:8,cid:27,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"String",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:Wr.teamMember}]},addTeamMembers:{sid:8,cid:5,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"},{type:"String",name:"attach"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},removeTeamMembers:{sid:8,cid:6,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applyTeam:{sid:8,cid:13,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:Wr.team}]},addTeamManagers:{sid:8,cid:16,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeTeamManagers:{sid:8,cid:17,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},updateMyMemberInfo:{sid:8,cid:19,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:Gr.teamMember}]},updateNickInTeam:{sid:8,cid:20,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:Gr.teamMember}]},muteTeamMember:{sid:8,cid:25,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Int",name:"mute"}]},getTeamMemberInvitorAccid:{sid:8,cid:33,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"Object",name:"accountsMap"}]},muteTeam:{sid:8,cid:32,service:"team",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},passTeamApply:{sid:8,cid:14,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamApply:{sid:8,cid:15,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptTeamInvite:{sid:8,cid:21,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamInvite:{sid:8,cid:22,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncTeams:{sid:8,cid:109,service:"team",response:[{type:"Number",name:"timetag"},{type:"PropertyArray",name:"teams",reflectMapper:Wr.team}]},syncCreateTeam:{sid:8,cid:101,service:"team",response:[{type:"Property",name:"team",reflectMapper:Wr.team}]},syncUpdateTeamMember:{sid:8,cid:119,service:"team",response:[{type:"Property",name:"teamMember",reflectMapper:Wr.teamMember}]},syncMyTeamMembers:{sid:8,cid:126,ext:"sync",service:"team",response:[{type:"PropertyArray",name:"teamMembers",entity:"teamMember",reflectMapper:Wr.teamMember},{type:"Number",name:"timetag"}]}},Yr={"3_7":"getUsersNameCardFromServer","3_10":"updateMyNameCard","3_109":"syncMyNameCard","3_110":"onUpdateMyNameCard","3_3":"setBlack","3_103":"onUpdateBlackList","3_5":"setMute","3_105":"onUpdateMuteList","3_8":"syncRelations"},Xr={user:{account:1,nick:3,avatar:4,signature:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13},relationMember:{account:0,isMuted:1,isBlack:2,createTime:3,updateTime:4}},Qr=invertSerializeMap(Xr),Zr={syncMyNameCard:{sid:3,cid:109,service:"user",response:[{type:"Property",name:"user",reflectMapper:Qr.user},{type:"Number",name:"timetag"}]},setBlack:{service:"user",sid:3,cid:3,params:[{type:"String",name:"account"},{type:"bool",name:"isAdd"}]},onUpdateBlackList:{service:"user",sid:3,cid:103,response:[{type:"String",name:"account"},{type:"Boolean",name:"isAdd"}]},setMute:{service:"user",sid:3,cid:5,params:[{type:"String",name:"account"},{type:"bool",name:"isAdd"}]},onUpdateMuteList:{service:"user",sid:3,cid:105,response:[{type:"String",name:"account"},{type:"Boolean",name:"isAdd"}]},syncRelations:{service:"user",sid:3,cid:8,params:[{type:"long",name:"timetag"}],response:[{type:"PropertyArray",name:"list",reflectMapper:Qr.relationMember},{type:"Number",name:"timetag"}]},getUsersNameCardFromServer:{service:"user",sid:3,cid:7,params:[{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"users",reflectMapper:Qr.user}]},updateMyNameCard:{service:"user",sid:3,cid:10,params:[{type:"Property",name:"user",reflectMapper:Xr.user}],response:[{type:"Number",name:"timetag"}]},onUpdateMyNameCard:{service:"user",sid:3,cid:110,response:[{type:"Property",name:"user",reflectMapper:Qr.user}]}},es={subType:{type:"string"},setting:{resendFlag:{type:"boolean"},envConfig:{type:"string"},needSaveHistory:{type:"boolean"},needRoaming:{type:"boolean"},needOffline:{type:"boolean"},needSelfSync:{type:"boolean"},needRouted:{type:"boolean"},needUpdateSession:{type:"boolean"},isMuted:{type:"boolean"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBIZID:{type:"string"},clientAntispamHitting:{type:"boolean"},antiSpamUsingYidun:{type:"boolean"},yidunCallbackURL:{type:"string"},yidunAntiCheating:{type:"string"},yidunAntiSpamExtension:{type:"string"},yidunAntiSpamResult:{type:"string"}},pushInfo:{needPush:{type:"boolean"},needPushBadge:{type:"boolean"},needPushNick:{type:"boolean"},pushApnsText:{type:"string"},pushPayload:{type:"string"}},teamSpecializationInfo:{needForcePush:{type:"boolean"},needACK:{type:"boolean"},forcePushIDsList:{type:"string"},pushContent:{type:"string"},isACKSent:{type:"boolean"},ackSnapshot:{type:"number"}},threadMessageInfo:{replyMsgFromAccount:{type:"string"},replyMsgToAccount:{type:"string"},replyMsgTime:{type:"number"},replyMsgIdServer:{type:"string"},replyMsgIdClient:{type:"string"},threadMsgFromAccount:{type:"string"},threadMsgToAccount:{type:"string"},threadMsgTime:{type:"number"},threadMsgIdServer:{type:"string"},threadMsgIdClient:{type:"string"}}},ts={0:"addTeamMembers",1:"removeTeamMembers",2:"leaveTeam",3:"updateTeam",4:"dismissTeam",5:"passTeamApply",6:"transferTeam",7:"addTeamManagers",8:"removeTeamManagers",9:"acceptTeamInvite",10:"updateTeamMemberMute",101:"netcallMiss",102:"netcallBill",103:"netcallReject",401:"addSuperTeamMembers",402:"removeSuperTeamMembers",403:"leaveSuperTeam",404:"updateSuperTeam",405:"dismissSuperTeam",406:"transferSuperTeam",407:"addSuperTeamManagers",408:"removeSuperTeamManagers",409:"updateSuperTeamMembersMute",410:"passSuperTeamApply",411:"acceptSuperTeamInvite"};function getSessionId(e,t){return`${Nt[e.scene]}-${e.to===t?e.from:e.to}`}function msgFlow(e,t){return e.from===t?e.to===t?"in":"out":"in"}function formatMsg(e,t){const{account:r,featureValue:s,statusValue:n,sessionAck:i,msgReceiptTime:o}=t,a=Nt[e.scene],c=e.to===r?e.from:e.to,d=Dt.default;let m=Bt.unread;parseInt(e.isInBlackList)>0?(m=Bt.refused,delete e.isInBlackList):m=e.from===r?o&&o>=+e.time?Bt.receipt:Bt.sent:i&&i>=+e.time?Bt.read:Bt.unread;const p=Object.assign(Object.assign({},format(es,e)),{scene:a,type:Lt[e.type],fromClientType:Ut[e.fromClientType],flow:msgFlow(e,r),target:c,to:e.to,from:e.from,time:e.time?+e.time:void 0,userUpdateTime:e.userUpdateTime?+e.userUpdateTime:void 0,idClient:e.idClient,sessionId:`${a}-${c}`,status:Bt[n||m],feature:Dt[s||d]});if("string"==typeof p.attach)try{p.attach=JSON.parse(p.attach)}catch(e){}return"notification"===p.type&&(p.attach=p.attach?function formatNotificationAttach(e){const t={};if(t.type=ts[e.id]||e.id,!e.data)return t;const r={ids:"accounts",id:"account",attach:"custom",channel:"channelId",calltype:"netcallType",mute:"mute",duration:"duration",time:"time",from:"from",ext:"ext"},s=e.data;return Object.keys(r).forEach((e=>{void 0!==s[e]&&(t[r[e]]=s[e])})),s.tinfo&&(t.team=formatTeam(deserialize(s.tinfo,Wr.team))),s.uinfos&&(t.users=s.uinfos.map((e=>formatUser(deserialize(e,Qr.user))))),void 0!==s.mute&&(t.mute=1===parseInt(s.mute)),t}(p.attach):{}),p}function formatMsgs(e,t){return e&&e.length>0?e.map((e=>formatMsg(e,t))):[]}function formatDeletedMsgs(e,t){return e.map((e=>{let r;return r=t||(Number.isNaN(parseInt(e.scene))?e.scene:1===parseInt(e.scene)?"p2p":"team"),{deletedTime:parseInt(e.time),from:e.from,idClient:e.deletedIdClient||e.idClient,idServer:e.deletedIdServer||e.idServer,scene:r,time:parseInt(e.time),to:e.to}}))}var rs=Array.prototype.reverse;var ss=function reverse(e){return null==e?e:rs.call(e)};class ModuleService$2{constructor(e){this.core=e}processBroadcastMsg(e){const t=e.map((e=>Object.assign(Object.assign({},e),{time:parseInt(e.time)})));return this.core.sendCmd("batchMarkRead",{sid:7,cid:17,ids:t.map((e=>e.id))}),t}}const ns={"4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","4_21":"syncDeleteSelfMsgs","7_1":"sendMsg","8_23":"getHistoryTeamMsgs","21_14":"getHistorySuperTeamMsgs","8_2":"sendTeamMsg","21_2":"sendSuperTeamMsg","7_11":"sendMsgReceipt","7_13":"recallMsg","7_24":"deleteSelfMsgs","21_17":"recallSuperTeamMsg","7_2":"onMsg","8_3":"onMsg","21_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_102":"onMsg","8_4":"nimOnTeamMsgs","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg","7_123":"onDeleteSelfMsg","7_124":"onDeleteSelfMsgs"},is={scene:0,to:1,from:2,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,type:8,body:9,attach:10,idClient:11,idServer:12,resendFlag:13,userUpdateTime:14,ext:15,pushPayload:16,pushApnsText:17,forcePushIDsList:18,pushContent:19,needForcePush:20,needAntiSpam:21,antiSpamContent:22,antiSpamBIZID:23,clientAntispamHitting:24,antiSpamUsingYidun:25,needACK:26,yidunCallbackURL:27,needUpdateSession:28,replyMsgFromAccount:29,replyMsgToAccount:30,replyMsgTime:31,replyMsgIdServer:32,replyMsgIdClient:33,threadMsgFromAccount:34,threadMsgToAccount:35,threadMsgTime:36,threadMsgIdServer:37,threadMsgIdClient:38,isDeleted:39,callbackExt:40,subType:41,yidunAntiCheating:42,envConfig:43,yidunAntiSpamExtension:44,yidunAntiSpamResult:45,needSaveHistory:100,needRoaming:101,needSelfSync:102,isMuted:104,needRouted:105,isInBlackList:106,needPush:107,needOffline:108,needPushBadge:109,needPushNick:110,isReplyMsg:111,ackSnapshot:112},os={msg:is,recallMsgTag:{time:0,type:1,to:2,from:3,ps:4,attach:5,apnsText:8,pushPayload:9,deletedIdClient:10,deletedIdServer:11,opeAccount:16,env:21},deleteSelfMsgTag:{scene:1,from:2,to:3,idServer:4,idClient:5,time:6,deletedTime:7,ext:8},msgReceiptTag:{to:1,from:2,time:7,idClient:11},broadcastMsg:{id:1,fromAccid:2,time:4,body:5}},as=invertSerializeMap(os),cs={sendMsg:{sid:7,cid:1,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:os.msg}],response:[{type:"Property",name:"msg",reflectMapper:as.msg}],ignoreErrCodes:[7101]},sendTeamMsg:{sid:8,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:os.msg}],response:[{type:"Property",name:"msg",reflectMapper:as.msg}]},sendSuperTeamMsg:{sid:21,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:os.msg}],response:[{type:"Property",name:"msg",reflectMapper:as.msg}]},onMsg:{sid:7,cid:2,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:as.msg}]},nimOnTeamMsgs:{sid:8,cid:4,service:"msg",response:[{type:"PropertyArray",name:"datas",reflectMapper:as.msg}]},getHistoryTeamMsgs:{sid:8,cid:23,service:"msg",params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"int",name:"limit"},{type:"bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:as.msg}]},getHistorySuperTeamMsgs:{sid:21,cid:14,params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"int",name:"limit"},{type:"bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:as.msg}],service:"msg"},recallMsg:{sid:7,cid:13,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:os.recallMsgTag}]},deleteSelfMsgs:{sid:7,cid:24,service:"msg",params:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:os.deleteSelfMsgTag}],response:[{type:"Long",name:"timetag"}]},recallSuperTeamMsg:{sid:21,cid:17,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:os.recallMsgTag}]},sendMsgReceipt:{sid:7,cid:11,service:"msg",params:[{type:"Property",name:"msgReceiptTag",reflectMapper:os.msgReceiptTag}],response:[{type:"Property",name:"msgReceiptTag",reflectMapper:as.msgReceiptTag}]},batchMarkRead:{sid:4,cid:5,service:"msg",isNoResponse:!0,params:[{type:"byte",name:"sid"},{type:"byte",name:"cid"},{type:"LongArray",name:"ids"}]},syncMsgReceipts:{sid:4,cid:12,service:"msg",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:as.msgReceiptTag},{type:"Number",name:"timetag"}]},syncOfflineMsgs:{sid:4,cid:4,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:as.msg}]},syncRoamingMsgs:{sid:4,cid:9,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:as.msg}]},syncBroadcastMsg:{sid:4,cid:16,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:as.broadcastMsg}]},onBroadcastMsg:{sid:7,cid:17,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:as.broadcastMsg}]},onDeleteSelfMsg:{sid:7,cid:123,service:"msg",response:[{type:"Property",name:"deletedMsg",reflectMapper:as.deleteSelfMsgTag}]},onDeleteSelfMsgs:{sid:7,cid:124,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:as.deleteSelfMsgTag}]},syncDeleteSelfMsgs:{sid:4,cid:21,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:as.deleteSelfMsgTag}]}};const ds={"5_1":"sync"},ms={sync:{sid:5,cid:1,service:"sync",isNoResponse:!0,params:[{type:"Property",name:"sync",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,signaling:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29}}],response:[{type:"Number",name:"timetag"}]}};const ps={"6_26":"getNosCdnHost"},ls={getNosCdnHost:{sid:6,cid:26,service:"misc",response:[{type:"Property",name:"nosConfigTag",reflectMapper:invertSerializeMap({nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4}}).nosConfigTag}]}};var us=function baseAssignValue(e,t,r){"__proto__"==t&&ze?ze(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r},gs=Object.prototype.hasOwnProperty;var ys=function assignValue(e,t,r){var s=e[t];gs.call(e,t)&&me(s,r)&&(void 0!==r||t in e)||us(e,t,r)};var hs=function baseSet(e,t,r,s){if(!h(e))return e;for(var n=-1,i=(t=Ct(t,e)).length,o=i-1,a=e;null!=a&&++n<i;){var c=Et(t[n]),d=r;if("__proto__"===c||"constructor"===c||"prototype"===c)return e;if(n!=o){var m=a[c];void 0===(d=s?s(m,c,a):void 0)&&(d=h(m)?m:cr(t[n+1])?[]:{})}ys(a,c,d),a=a[c]}return e};var fs=function basePickBy(e,t,r){for(var s=-1,n=t.length,i={};++s<n;){var o=t[s],a=xt(e,o);r(a,o)&&hs(i,Ct(o,e),a)}return i};var vs=function baseHasIn(e,t){return null!=e&&t in Object(e)};var Ts=function hasPath(e,t,r){for(var s=-1,n=(t=Ct(t,e)).length,i=!1;++s<n;){var o=Et(t[s]);if(!(i=null!=e&&r(e,o)))break;e=e[o]}return i||++s!=n?i:!!(n=null==e?0:e.length)&&Je(n)&&cr(o,n)&&(gt(e)||nr(e))};var bs=function hasIn(e,t){return null!=e&&Ts(e,t,vs)};var Ss=function basePick(e,t){return fs(e,t,(function(t,r){return bs(e,r)}))};var Ms=function arrayPush(e,t){for(var r=-1,s=t.length,n=e.length;++r<s;)e[n+r]=t[r];return e},ks=o?o.isConcatSpreadable:void 0;var _s=function isFlattenable(e){return gt(e)||nr(e)||!!(ks&&e&&e[ks])};var ws=function baseFlatten(e,t,r,s,n){var i=-1,o=e.length;for(r||(r=_s),n||(n=[]);++i<o;){var a=e[i];t>0&&r(a)?t>1?baseFlatten(a,t-1,r,s,n):Ms(n,a):s||(n[n.length]=a)}return n};var Is=function flatten(e){return(null==e?0:e.length)?ws(e,1):[]};var Cs=function flatRest(e){return We(He(e,void 0,Is),e+"")}((function(e,t){return null==e?{}:Ss(e,t)}));var Es=function stackClear(){this.__data__=new fe,this.size=0};var xs=function stackDelete(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var Ps=function stackGet(e){return this.__data__.get(e)};var As=function stackHas(e){return this.__data__.has(e)};var js=function stackSet(e,t){var r=this.__data__;if(r instanceof fe){var s=r.__data__;if(!ve||s.length<199)return s.push([e,t]),this.size=++r.size,this;r=this.__data__=new Ie(s)}return r.set(e,t),this.size=r.size,this};function Stack(e){var t=this.__data__=new fe(e);this.size=t.size}Stack.prototype.clear=Es,Stack.prototype.delete=xs,Stack.prototype.get=Ps,Stack.prototype.has=As,Stack.prototype.set=js;var Os=Stack;var Fs=function arraySome(e,t){for(var r=-1,s=null==e?0:e.length;++r<s;)if(t(e[r],r,e))return!0;return!1};var Rs=function equalArrays(e,t,r,s,n,i){var o=1&r,a=e.length,c=t.length;if(a!=c&&!(o&&c>a))return!1;var d=i.get(e),m=i.get(t);if(d&&m)return d==t&&m==e;var p=-1,l=!0,u=2&r?new xe:void 0;for(i.set(e,t),i.set(t,e);++p<a;){var g=e[p],y=t[p];if(s)var h=o?s(y,g,p,t,e,i):s(g,y,p,e,t,i);if(void 0!==h){if(h)continue;l=!1;break}if(u){if(!Fs(t,(function(e,t){if(!Ne(u,t)&&(g===e||n(g,e,r,s,i)))return u.push(t)}))){l=!1;break}}else if(g!==y&&!n(g,y,r,s,i)){l=!1;break}}return i.delete(e),i.delete(t),l},Ls=i.Uint8Array;var Ns=function mapToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e,s){r[++t]=[s,e]})),r},Us=o?o.prototype:void 0,Bs=Us?Us.valueOf:void 0;var Ds=function equalByTag(e,t,r,s,n,i,o){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!i(new Ls(e),new Ls(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return me(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var a=Ns;case"[object Set]":var c=1&s;if(a||(a=st),e.size!=t.size&&!c)return!1;var d=o.get(e);if(d)return d==t;s|=2,o.set(e,t);var m=Rs(a(e),a(t),s,n,i,o);return o.delete(e),m;case"[object Symbol]":if(Bs)return Bs.call(e)==Bs.call(t)}return!1};var qs=function baseGetAllKeys(e,t,r){var s=t(e);return gt(e)?s:Ms(s,r(e))};var Hs=function arrayFilter(e,t){for(var r=-1,s=null==e?0:e.length,n=0,i=[];++r<s;){var o=e[r];t(o,r,e)&&(i[n++]=o)}return i};var $s=function stubArray(){return[]},zs=Object.prototype.propertyIsEnumerable,Ks=Object.getOwnPropertySymbols,Vs=Ks?function(e){return null==e?[]:(e=Object(e),Hs(Ks(e),(function(t){return zs.call(e,t)})))}:$s;var Gs=function getAllKeys(e){return qs(e,br,Vs)},Ws=Object.prototype.hasOwnProperty;var Js=function equalObjects(e,t,r,s,n,i){var o=1&r,a=Gs(e),c=a.length;if(c!=Gs(t).length&&!o)return!1;for(var d=c;d--;){var m=a[d];if(!(o?m in t:Ws.call(t,m)))return!1}var p=i.get(e),l=i.get(t);if(p&&l)return p==t&&l==e;var u=!0;i.set(e,t),i.set(t,e);for(var g=o;++d<c;){var y=e[m=a[d]],h=t[m];if(s)var f=o?s(h,y,m,t,e,i):s(y,h,m,e,t,i);if(!(void 0===f?y===h||n(y,h,r,s,i):f)){u=!1;break}g||(g="constructor"==m)}if(u&&!g){var v=e.constructor,T=t.constructor;v==T||!("constructor"in e)||!("constructor"in t)||"function"==typeof v&&v instanceof v&&"function"==typeof T&&T instanceof T||(u=!1)}return i.delete(e),i.delete(t),u},Ys=Z(i,"DataView"),Xs=Z(i,"Promise"),Qs=Z(i,"WeakMap"),Zs="[object Map]",en="[object Promise]",tn="[object Set]",rn="[object WeakMap]",sn="[object DataView]",nn=z(Ys),an=z(ve),cn=z(Xs),dn=z(et),mn=z(Qs),pn=y;(Ys&&pn(new Ys(new ArrayBuffer(1)))!=sn||ve&&pn(new ve)!=Zs||Xs&&pn(Xs.resolve())!=en||et&&pn(new et)!=tn||Qs&&pn(new Qs)!=rn)&&(pn=function(e){var t=y(e),r="[object Object]"==t?e.constructor:void 0,s=r?z(r):"";if(s)switch(s){case nn:return sn;case an:return Zs;case cn:return en;case dn:return tn;case mn:return rn}return t});var ln=pn,un="[object Arguments]",gn="[object Array]",yn="[object Object]",hn=Object.prototype.hasOwnProperty;var fn=function baseIsEqualDeep(e,t,r,s,n,i){var o=gt(e),a=gt(t),c=o?gn:ln(e),d=a?gn:ln(t),m=(c=c==un?yn:c)==yn,p=(d=d==un?yn:d)==yn,l=c==d;if(l&&or(e)){if(!or(t))return!1;o=!0,m=!1}if(l&&!m)return i||(i=new Os),o||lr(e)?Rs(e,t,r,s,n,i):Ds(e,t,c,r,s,n,i);if(!(1&r)){var u=m&&hn.call(e,"__wrapped__"),g=p&&hn.call(t,"__wrapped__");if(u||g){var y=u?e.value():e,h=g?t.value():t;return i||(i=new Os),n(y,h,r,s,i)}}return!!l&&(i||(i=new Os),Js(e,t,r,s,n,i))};var vn=function baseIsEqual(e,t,r,s,n){return e===t||(null==e||null==t||!j(e)&&!j(t)?e!=e&&t!=t:fn(e,t,r,s,baseIsEqual,n))};var Tn=function baseIsMatch(e,t,r,s){var n=r.length,i=n,o=!s;if(null==e)return!i;for(e=Object(e);n--;){var a=r[n];if(o&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++n<i;){var c=(a=r[n])[0],d=e[c],m=a[1];if(o&&a[2]){if(void 0===d&&!(c in e))return!1}else{var p=new Os;if(s)var l=s(d,m,c,e,t,p);if(!(void 0===l?vn(m,d,3,s,p):l))return!1}}return!0};var bn=function isStrictComparable(e){return e==e&&!h(e)};var Sn=function getMatchData(e){for(var t=br(e),r=t.length;r--;){var s=t[r],n=e[s];t[r]=[s,n,bn(n)]}return t};var Mn=function matchesStrictComparable(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}};var kn=function baseMatches(e){var t=Sn(e);return 1==t.length&&t[0][2]?Mn(t[0][0],t[0][1]):function(r){return r===e||Tn(r,e,t)}};var _n=function baseMatchesProperty(e,t){return vt(e)&&bn(t)?Mn(Et(e),t):function(r){var s=Pt(r,e);return void 0===s&&s===t?bs(r,e):vn(t,s,3)}};var wn=function baseProperty(e){return function(t){return null==t?void 0:t[e]}};var In=function basePropertyDeep(e){return function(t){return xt(t,e)}};var Cn=function property(e){return vt(e)?wn(Et(e)):In(e)};var En=function baseIteratee(e){return"function"==typeof e?e:null==e?Be:"object"==typeof e?gt(e)?_n(e[0],e[1]):kn(e):Cn(e)},xn=/\s/;var Pn=function trimmedEndIndex(e){for(var t=e.length;t--&&xn.test(e.charAt(t)););return t},An=/^\s+/;var jn=function baseTrim(e){return e?e.slice(0,Pn(e)+1).replace(An,""):e},On=/^[-+]0x[0-9a-f]+$/i,Fn=/^0b[01]+$/i,Rn=/^0o[0-7]+$/i,Ln=parseInt;var Nn=function toNumber(e){if("number"==typeof e)return e;if(yt(e))return NaN;if(h(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=h(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=jn(e);var r=Fn.test(e);return r||Rn.test(e)?Ln(e.slice(2),r?2:8):On.test(e)?NaN:+e},Un=1/0;var Bn=function toFinite(e){return e?(e=Nn(e))===Un||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};var Dn=function toInteger(e){var t=Bn(e),r=t%1;return t==t?r?t-r:t:0},qn=Math.max;var Hn=function findIndex(e,t,r){var s=null==e?0:e.length;if(!s)return-1;var n=null==r?0:Dn(r);return n<0&&(n=qn(s+n,0)),Pe(e,En(t),n)};const $n={"4_12":"syncMsgReceipts","4_14":"syncSessionAck","4_20":"syncSuperTeamSessionAck","4_22":"nimSyncSessionsWithMoreRoaming","4_25":"syncSessionReliableInfo","7_12":"multiSyncMsgReceipt","7_16":"markSessionAck","7_25":"markMultSessionsAck","7_116":"syncMarkSessionAck","21_25":"markSuperTeamSessionAck","21_32":"markMultSuperTeamSessionsAck","21_125":"syncMarkSuperTeamSessionAck","4_23":"nimSyncStickTopSessions","23_12":"nimAddStickTopSession","23_13":"nimDeleteStickTopSession","23_14":"nimUpdateStickTopSession","23_112":"nimMultiSyncAddStickTopSession","23_113":"nimMultiSyncDeleteStickTopSession","23_114":"nimMultiSyncUpdateStickTopSession"},zn={msgReceiptTag:{to:1,from:2,time:7,idClient:11},stickTopSessionTag:{id:1,ext:2,createTime:3,updateTime:4},sessionAckTag:{scene:1,to:2,timetag:3},sessionReliableSyncTag:{scene:1,sessionId:2,syncStatus:3,syncEndMsgId:4,syncEndMsgidClient:5,syncEndMsgTime:6,syncStartMsgid:7,syncStartMsgidClient:8,syncStartMsgTime:9,nextMsgid:10,nextMsgidClient:11,nextMsgTime:12,roamMsgSync:13,offlineMsgSync:14,netCallOfflineMsgSync:15}},Kn=invertSerializeMap(zn),Vn={syncMsgReceipts:{sid:4,cid:12,service:"session",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:Kn.msgReceiptTag},{type:"Number",name:"timetag"}]},syncSessionAck:{sid:4,cid:14,service:"session",response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Number",name:"timetag"}]},syncSuperTeamSessionAck:{sid:4,cid:20,service:"session",response:[{type:"LongLongMap",name:"superTeam"},{type:"Number",name:"timetag"}]},multiSyncMsgReceipt:{sid:7,cid:12,service:"session",response:[{type:"Property",name:"msgReceiptTag",reflectMapper:Kn.msgReceiptTag}]},markSessionAck:{sid:7,cid:16,service:"session",params:[{type:"byte",name:"scene"},{type:"String",name:"to"},{type:"long",name:"timetag"}]},syncMarkSessionAck:{sid:7,cid:116,service:"session",response:[{type:"byte",name:"scene"},{type:"String",name:"to"},{type:"long",name:"timetag"}]},syncMarkSuperTeamSessionAck:{sid:21,cid:125,service:"session",response:[{type:"String",name:"to"},{type:"long",name:"timetag"}]},markMultSessionsAck:{sid:7,cid:25,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:zn.sessionAckTag}]},markSuperTeamSessionAck:{sid:21,cid:25,service:"session",params:[{type:"long",name:"to"},{type:"long",name:"timetag"}]},nimAddStickTopSession:{sid:23,cid:12,service:"session",params:[{type:"Property",name:"tag",reflectMapper:zn.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:Kn.stickTopSessionTag}]},nimDeleteStickTopSession:{sid:23,cid:13,service:"session",params:[{type:"Property",name:"tag",reflectMapper:zn.stickTopSessionTag}],response:[{type:"Number",name:"timetag"}]},nimUpdateStickTopSession:{sid:23,cid:14,service:"session",params:[{type:"Property",name:"tag",reflectMapper:zn.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:Kn.stickTopSessionTag}]},nimMultiSyncAddStickTopSession:{sid:23,cid:112,service:"session",response:[{type:"Property",name:"data",reflectMapper:Kn.stickTopSessionTag}]},nimMultiSyncDeleteStickTopSession:{sid:23,cid:113,service:"session",response:[{type:"Number",name:"timetag"},{type:"Property",name:"data",reflectMapper:Kn.stickTopSessionTag}]},nimMultiSyncUpdateStickTopSession:{sid:23,cid:114,service:"session",response:[{type:"Property",name:"data",reflectMapper:Kn.stickTopSessionTag}]},nimSyncStickTopSessions:{sid:4,cid:23,service:"session",response:[{type:"Number",name:"timetag"},{type:"Boolean",name:"isThereAnyChange"},{type:"PropertyArray",name:"datas",reflectMapper:Kn.stickTopSessionTag}]},markMultSuperTeamSessionsAck:{sid:21,cid:32,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:zn.sessionAckTag}]},nimSyncSessionsWithMoreRoaming:{sid:21,cid:22,service:"session",response:[{type:"PropertyArray",name:"datas",reflectMapper:{0:"scene",1:"to",2:"from",7:"time",12:"idServer"}}]},syncSessionReliableInfo:{sid:4,cid:25,service:"session",response:[{type:"Property",name:"context",reflectMapper:{1:"timetag",2:"type"}},{type:"PropertyArray",name:"datas",reflectMapper:Kn.sessionReliableSyncTag}]}},Gn={id:{type:"string"},ext:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"}};function formatStickTop(e,t,r=!0){const s=format(Gn,e);return s.isStickOnTop=r,s.id=t.id,Object.assign(Object.assign({},t),{stickTopInfo:t.stickTopInfo?Object.assign({},t.stickTopInfo,s):s})}const Wn={scene:{type:"enum",values:Nt},time:{type:"number"}};class StickTopService{constructor(e){this.core=e}getSession(e){return this.core.session.getSessionWithUncomplete({id:e})||this.core.session.createSession(e)}addStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e);const{scene:t,accid:r}=getAccountFromSessionId(e.id),s=yield this.core.sendCmd("nimAddStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`,ext:e.ext}}),n=this.getSession(e.id);return formatStickTop(s.content.data,n)}))}deleteStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1}},e);const{scene:t,accid:r}=getAccountFromSessionId(e.id),s=yield this.core.sendCmd("nimDeleteStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`}}),n=this.getSession(e.id);return formatStickTop({updateTime:s.content.timetag},n,!1)}))}updateStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e);const{scene:t,accid:r}=getAccountFromSessionId(e.id),s=yield this.core.sendCmd("nimUpdateStickTopSession",{tag:{id:`${"superTeam"===t?"super_team":t}|${r}`,ext:e.ext}}),n=this.getSession(e.id);return formatStickTop(s.content.data,n)}))}stickTopSessionHandler(e,t=!0){const{scene:r,accid:s}=getAccountFromSessionId(e.id,"|"),n=`${r}-${s}`;return formatStickTop(e,this.getSession(n),t)}}class UnreadModuleService{constructor(e){this.core=e,this.logger=e.logger}canSessionResetUnreadCount(e){const t=e.id;if(void 0===e.lastMsg)throw new Error(`Session::canSessionResetUnreadCount: session ${t} is not completly, lastMsg undefined`);return null!==e.lastMsg||e.unread>0?!(e.ack&&e.lastMsg&&e.ack>=e.lastMsg.time)||(this.logger.log(`Session::canSessionResetUnreadCount: session ${t} reset failed, ack time is greater than last message time`),!1):(this.logger.log(`Session::canSessionResetUnreadCount: session ${t} doesn't need to be updated, lastMsg null and unread 0`),!1)}filterSessionForResetUnreadCount(e){const t={cmd:"markMultSuperTeamSessionsAck",params:[]},r={cmd:"markMultSessionsAck",params:[]};return e.forEach((e=>{var s;let n=!1;try{if(n=this.canSessionResetUnreadCount(e),!n)return;const{accid:i,scene:o}=getAccountFromSessionId(e.id),a={to:i,sessionId:e.id,timetag:(null===(s=null==e?void 0:e.lastMsg)||void 0===s?void 0:s.time)||e.updateTime||0},c=function generateSceneForCmd(e){return formatReverse({scene:{type:"enum",values:Nt}},e)}({scene:o});"superTeam"===o?t.params.push(a):r.params.push(Object.assign(Object.assign({},a),c))}catch(e){this.logger.warn(e)}})),{superTeam:t,p2pOrTeam:r}}}var Jn=function baseSlice(e,t,r){var s=-1,n=e.length;t<0&&(t=-t>n?0:n+t),(r=r>n?n:r)<0&&(r+=n),n=t>r?0:r-t>>>0,t>>>=0;for(var i=Array(n);++s<n;)i[s]=e[s+t];return i};var Yn=function isIterateeCall(e,t,r){if(!h(r))return!1;var s=typeof t;return!!("number"==s?Ye(r)&&cr(t,r.length):"string"==s&&t in r)&&me(r[t],e)},Xn=Math.ceil,Qn=Math.max;var Zn=function chunk(e,t,r){t=(r?Yn(e,t,r):void 0===t)?1:Qn(Dn(t),0);var s=null==e?0:e.length;if(!s||t<1)return[];for(var n=0,i=0,o=Array(Xn(s/t));n<s;)o[i++]=Jn(e,n,n+=t);return o};class ModuleService$1{constructor(e){this.core=e}notifyAddTeamMembers(e,t){this.core.emit("addTeamMembers",{team:e,accounts:t,members:generatorMembersByTeam(e,t)})}notifyUpdateTeamManagers(e,t,r,s){this.core.emit("updateTeamManagers",{team:{teamId:e,memberUpdateTime:s},accounts:t,isManager:r,members:t.map((t=>({id:`${e}-${t}`,account:t,type:"manager",updateTime:s})))})}notifyRemoveTeamMembers(e,t){this.core.emit("removeTeamMembers",{team:e,accounts:t})}notifyTransferTeam(e,t,r){this.core.emit("transferTeam",{team:e,from:{id:`${e.teamId}-${t}`,type:"normal",account:t,updateTime:e.memberUpdateTime},to:{id:`${e.teamId}-${r}`,type:"owner",account:r,updateTime:e.memberUpdateTime}})}notifyUpdateTeamMembersMute(e,t,r){this.core.emit("updateTeamMembersMute",{team:e,accounts:t,members:t.map((function(t){return{id:`${e.teamId}-${t}`,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})}}var ei=function arrayEach(e,t){for(var r=-1,s=null==e?0:e.length;++r<s&&!1!==t(e[r],r,e););return e};var ti=function copyObject(e,t,r,s){var n=!r;r||(r={});for(var i=-1,o=t.length;++i<o;){var a=t[i],c=s?s(r[a],e[a],a,r,e):void 0;void 0===c&&(c=e[a]),n?us(r,a,c):ys(r,a,c)}return r};var ri=function baseAssign(e,t){return e&&ti(t,br(t),e)};var si=function nativeKeysIn(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},ni=Object.prototype.hasOwnProperty;var ii=function baseKeysIn(e){if(!h(e))return si(e);var t=hr(e),r=[];for(var s in e)("constructor"!=s||!t&&ni.call(e,s))&&r.push(s);return r};var oi=function keysIn(e){return Ye(e)?gr(e,!0):ii(e)};var ai=function baseAssignIn(e,t){return e&&ti(t,oi(t),e)},ci=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,s=r&&e&&!e.nodeType&&e,n=s&&s.exports===r?i.Buffer:void 0,o=n?n.allocUnsafe:void 0;e.exports=function cloneBuffer(e,t){if(t)return e.slice();var r=e.length,s=o?o(r):new e.constructor(r);return e.copy(s),s}}));var di=function copyArray(e,t){var r=-1,s=e.length;for(t||(t=Array(s));++r<s;)t[r]=e[r];return t};var mi=function copySymbols(e,t){return ti(e,Vs(e),t)},pi=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)Ms(t,Vs(e)),e=Ht(e);return t}:$s;var li=function copySymbolsIn(e,t){return ti(e,pi(e),t)};var ui=function getAllKeysIn(e){return qs(e,oi,pi)},gi=Object.prototype.hasOwnProperty;var yi=function initCloneArray(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&gi.call(e,"index")&&(r.index=e.index,r.input=e.input),r};var hi=function cloneArrayBuffer(e){var t=new e.constructor(e.byteLength);return new Ls(t).set(new Ls(e)),t};var fi=function cloneDataView(e,t){var r=t?hi(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)},vi=/\w*$/;var Ti=function cloneRegExp(e){var t=new e.constructor(e.source,vi.exec(e));return t.lastIndex=e.lastIndex,t},bi=o?o.prototype:void 0,Si=bi?bi.valueOf:void 0;var Mi=function cloneSymbol(e){return Si?Object(Si.call(e)):{}};var ki=function cloneTypedArray(e,t){var r=t?hi(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)};var _i=function initCloneByTag(e,t,r){var s=e.constructor;switch(t){case"[object ArrayBuffer]":return hi(e);case"[object Boolean]":case"[object Date]":return new s(+e);case"[object DataView]":return fi(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return ki(e,r);case"[object Map]":case"[object Set]":return new s;case"[object Number]":case"[object String]":return new s(e);case"[object RegExp]":return Ti(e);case"[object Symbol]":return Mi(e)}},wi=Object.create,Ii=function(){function object(){}return function(e){if(!h(e))return{};if(wi)return wi(e);object.prototype=e;var t=new object;return object.prototype=void 0,t}}();var Ci=function initCloneObject(e){return"function"!=typeof e.constructor||hr(e)?{}:Ii(Ht(e))};var Ei=function baseIsMap(e){return j(e)&&"[object Map]"==ln(e)},xi=N&&N.isMap,Pi=xi?L(xi):Ei;var Ai=function baseIsSet(e){return j(e)&&"[object Set]"==ln(e)},ji=N&&N.isSet,Oi=ji?L(ji):Ai,Fi="[object Arguments]",Ri="[object Function]",Li="[object Object]",Ni={};Ni[Fi]=Ni["[object Array]"]=Ni["[object ArrayBuffer]"]=Ni["[object DataView]"]=Ni["[object Boolean]"]=Ni["[object Date]"]=Ni["[object Float32Array]"]=Ni["[object Float64Array]"]=Ni["[object Int8Array]"]=Ni["[object Int16Array]"]=Ni["[object Int32Array]"]=Ni["[object Map]"]=Ni["[object Number]"]=Ni[Li]=Ni["[object RegExp]"]=Ni["[object Set]"]=Ni["[object String]"]=Ni["[object Symbol]"]=Ni["[object Uint8Array]"]=Ni["[object Uint8ClampedArray]"]=Ni["[object Uint16Array]"]=Ni["[object Uint32Array]"]=!0,Ni["[object Error]"]=Ni[Ri]=Ni["[object WeakMap]"]=!1;var Ui=function baseClone(e,t,r,s,n,i){var o,a=1&t,c=2&t,d=4&t;if(r&&(o=n?r(e,s,n,i):r(e)),void 0!==o)return o;if(!h(e))return e;var m=gt(e);if(m){if(o=yi(e),!a)return di(e,o)}else{var p=ln(e),l=p==Ri||"[object GeneratorFunction]"==p;if(or(e))return ci(e,a);if(p==Li||p==Fi||l&&!n){if(o=c||l?{}:Ci(e),!a)return c?li(e,ai(o,e)):mi(e,ri(o,e))}else{if(!Ni[p])return n?e:{};o=_i(e,p,a)}}i||(i=new Os);var u=i.get(e);if(u)return u;i.set(e,o),Oi(e)?e.forEach((function(s){o.add(baseClone(s,t,r,s,e,i))})):Pi(e)&&e.forEach((function(s,n){o.set(n,baseClone(s,t,r,n,e,i))}));var g=m?void 0:(d?c?ui:Gs:c?oi:br)(e);return ei(g||e,(function(s,n){g&&(s=e[n=s]),ys(o,n,baseClone(s,t,r,n,e,i))})),o};var Bi,Di,qi=function cloneDeep(e){return Ui(e,5)};!function(e){e[e.none=0]="none",e[e.pass=1]="pass",e[e.decline=2]="decline",e[e.read=3]="read",e[e.deleted=4]="deleted",e[e.invalid=5]="invalid"}(Bi||(Bi={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(Di||(Di={}));const Hi={applyTeam:0,rejectTeamApply:1,teamInvite:2,rejectTeamInvite:3,friendRequest:5,deleteFriend:6,recallMsgP2p:7,recallMsgTeam:8,recallMsgSuperTeam:12,deleteMsgP2pOneWay:13,deleteMsgTeamOneWay:14,applySuperTeam:15,rejectSuperTeamApply:16,superTeamInvite:17,rejectSuperTeamInvite:18,customP2p:100,customTeam:101,customSuperTeam:103},$i={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};const zi={setting:{needSaveOffline:{type:"boolean"},isRoutable:{type:"boolean"},envConfig:{type:"string"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"boolean"}},pushInfo:{needPush:{type:"boolean"},needPushBadge:{type:"boolean"},needPushNick:{type:"boolean"},pushApnsText:{type:"string"},pushPayload:{type:"string"},needForcePush:{type:"boolean"},forcePushIDsList:{type:"string"},pushContent:{type:"string",rawKey:"forcePushContent"}},recallMessageInfo:{idClient:{type:"string",rawKey:"deletedIdClient"},idServer:{type:"string",rawKey:"deletedIdServer"},createTime:{type:"number",rawKey:"deletedMsgTime"},fromNick:{type:"string",rawKey:"deletedMsgFromNick"},opeAccount:{type:"string"}}};function formatSystemMessage(e,t,r){const s=+e.type,n=getEnumKeyByEnumValue(Hi,s);r=r||Di.default;const i=Object.assign(Object.assign({},format(zi,e)),{type:n,time:+e.time,to:e.to,from:e.from,idServer:e.idServer,state:Bi[Bi.none],feature:Di[r]});if("string"==typeof i.attach)try{i.attach=JSON.parse(i.attach)}catch(e){t.error(`formatSystemMessage: ${i.idServer} parse attach error`,e&&e.message)}return 5===s&&i.attach?(i.attach.type=$i[+i.attach.vt],"passFriendApply"===i.attach.type?i.state=Bi[Bi.pass]:"rejectFriendApply"===i.attach.type&&(i.state=Bi[Bi.decline])):s<=3&&i.attach&&(i.attach=function formatTeamAttach(e){const{attach:t,tinfo:r}=e,s=__rest(e,["attach","tinfo"]);return s.ext=t,void 0!==r&&(s.team=formatTeam(deserialize(e.tinfo,Wr.team))),s}(i.attach)),i}function generatorSysMsgForCmd(e){const t=Object.assign({},e);return Object.assign(Object.assign({},formatReverse(zi,t)),{type:Hi[t.type],to:t.to,attach:t.attach})}const Ki={"4_6":"syncOfflineSysMsgs","4_18":"syncOfflineSysMsgs","4_19":"syncRecallMsgOfflineAndRoaming","4_101":"syncOfflineSysMsgs","7_3":"onSysMsg","7_7":"sendCustomSysMsg","7_14":"onRecallMsg","21_18":"onRecallMsg","21_117":"onRecallMsg","7_15":"syncRecallMsgOfflineAndRoaming","21_19":"onSysMsg","21_16":"sendSuperTeamCustomSysMsg","101_3":"onSysMsg","101_7":"sendFilterCustomSysMsg"},Vi={sysMsg:{time:0,type:1,to:2,from:3,content:4,attach:5,idServer:6,needSaveOffline:7,pushApnsText:8,pushPayload:9,deletedIdClient:10,deletedIdServer:11,needcAntiSpam:12,antiSpamContent:13,deletedMsgTime:14,deletedMsgFromNick:15,opeAccount:16,forcePushIDsList:18,forcePushContent:19,needForcePush:20,envConfig:21,callbackExt:22,isRoutable:105,needPush:107,needPushBadge:109,needPushNick:110}},Gi=invertSerializeMap(Vi),Wi={onSysMsg:{service:"systemMessage",sid:7,cid:3,response:[{type:"Property",name:"sysMsg",reflectMapper:Gi.sysMsg}]},sendCustomSysMsg:{service:"systemMessage",sid:7,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:Vi.sysMsg}]},sendSuperTeamCustomSysMsg:{service:"systemMessage",sid:21,cid:16,params:[{type:"Property",name:"sysMsg",reflectMapper:Vi.sysMsg}]},sendFilterCustomSysMsg:{service:"systemMessage",sid:101,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:Vi.sysMsg}]},batchMarkRead:{service:"systemMessage",sid:4,cid:5,isNoResponse:!0,params:[{type:"byte",name:"sid"},{type:"byte",name:"cid"},{type:"LongArray",name:"ids"}]},onRecallMsg:{sid:7,cid:14,service:"systemMessage",response:[{type:"Property",name:"sysMsg",reflectMapper:Gi.sysMsg}]},syncRecallMsgOfflineAndRoaming:{sid:7,cid:15,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:Gi.sysMsg},{type:"Number",name:"timetag"},{type:"Number",name:"type"}]},syncOfflineSysMsgs:{sid:4,cid:9,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:Gi.sysMsg}]}};function reverseFriend(e){const t=Object.assign({},e);return["bitsExtension","createTime","updateTime","passRelationShip","relationShip","source"].forEach((e=>{void 0!==t[e]&&(t[e]=parseInt(t[e]))})),void 0!==t.relationShip&&(t.valid=1===t.relationShip),t}const Ji={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};const Yi={"12_4":"getFriends","12_1":"friendReuqest","12_2":"deleteFriend","12_3":"updateFriend","12_5":"syncFriends","12_6":"syncFriendUsers","12_101":"syncFriendRequest","12_102":"syncDeleteFriend","12_103":"syncUpdateFriend"},Xi={updateFriendTag:{account:4,alias:8,ext:10},delFriendParams:{delAlias:1},friendTag:{account:4,relationShip:5,passRelationShip:6,source:7,alias:8,bitsExtension:9,ext:10,createTime:11,updateTime:12,serverex:13},userTag:{account:1,nick:3,avatar:4,sign:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13}},Qi=invertSerializeMap(Xi),Zi={getFriends:{sid:12,cid:4,service:"friend",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:Qi.friendTag},{type:"Number",name:"timetag"}]},friendReuqest:{sid:12,cid:1,service:"friend",params:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}]},deleteFriend:{sid:12,cid:2,service:"friend",params:[{type:"String",name:"account"},{type:"Property",name:"delFriendParams",reflectMapper:Xi.delFriendParams}]},updateFriend:{sid:12,cid:3,service:"friend",params:[{type:"Property",name:"updateFriendTag",reflectMapper:Xi.updateFriendTag}]},syncFriends:{sid:12,cid:5,service:"friend",response:[{type:"PropertyArray",name:"friends",entity:"friendTag",reflectMapper:Qi.friendTag},{type:"Number",name:"timetag"}]},syncFriendUsers:{sid:12,cid:6,service:"friend",response:[{type:"PropertyArray",name:"users",entity:"userTag",reflectMapper:Qi.userTag},{type:"Number",name:"timetag"}]},syncFriendRequest:{sid:12,cid:101,service:"friend",params:[{type:"String",name:"account"},{type:"Number",name:"type"},{type:"String",name:"ps"}],response:[{type:"String",name:"account"},{type:"Number",name:"type"},{type:"String",name:"ps"}]},syncDeleteFriend:{sid:12,cid:102,service:"friend",response:[{type:"String",name:"account"}]},syncUpdateFriend:{sid:12,cid:103,service:"friend",response:[{type:"Property",name:"friend",reflectMapper:Qi.friendTag}]}};const eo={1:"Android",2:"iOS",4:"PC",8:"WindowsPhone",16:"Web",32:"Server",64:"Mac"};function formatSubscribes(e){return e&&e.length>0?e.map((e=>function formatSubscribe(e){const t=Object.assign({},e);return["subscribeTime","time"].forEach((e=>{t[e]&&(t[e]=parseInt(t[e]))})),t}(e))):[]}function formatEvent(e){if(!e)return e;const{serverExt:t}=e,r=__rest(e,["serverExt"]);if(["time","type","value"].forEach((e=>{r[e]&&(r[e]=parseInt(r[e]))})),r.clientType&&(r.clientType=eo[r.clientType]||""),t)try{r.ext=JSON.parse(t),"string"==typeof r.ext[0]&&(r.ext=r.ext[0])}catch(e){}return r}const to={"14_1":"publishEvent","14_2":"pushEvent","14_3":"subscribeEvent","14_4":"unSubscribeEventsByAccounts","14_5":"unSubscribeEventsByType","14_6":"querySubscribeEventsByAccounts","14_7":"querySubscribeEventsByType","14_9":"pushEvents"},ro={msgEvent:{type:1,value:2,idClient:3,ext:4,validTime:5,broadcastType:6,sync:7,validTimeType:8,durable:9,time:10,idServer:11,clientType:12,serverConfig:13,serverExt:14,appid:101,account:103,enableMultiClient:104,consid:106},msgEventSubscribe:{type:1,subscribeTime:2,sync:3,to:102,from:104,time:105}},so=invertSerializeMap(ro),no={publishEvent:{sid:14,cid:1,service:"event",params:[{type:"Property",name:"msgEvent",reflectMapper:ro.msgEvent}],response:[{type:"Property",name:"msgEvent",reflectMapper:so.msgEvent}]},pushEvent:{sid:14,cid:2,service:"event",response:[{type:"Property",name:"msgEvent",reflectMapper:so.msgEvent}]},subscribeEvent:{sid:14,cid:3,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:ro.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByAccounts:{sid:14,cid:4,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:ro.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByType:{sid:14,cid:5,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:ro.msgEventSubscribe}]},querySubscribeEventsByAccounts:{sid:14,cid:6,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:ro.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:so.msgEventSubscribe}]},querySubscribeEventsByType:{sid:14,cid:7,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:ro.msgEventSubscribe}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:so.msgEventSubscribe}]},pushEvents:{sid:14,cid:9,service:"event",response:[{type:"PropertyArray",name:"msgEvents",reflectMapper:so.msgEvent}]}};const io={"23_1":"getThreadMsgs","23_2":"getMsgsByIdServer"},oo={msg:is,threadMsgReq:{beginTime:1,endTime:2,lastMsgId:3,limit:4,reverse:5},threadMsgsMeta:{total:1,lastMsgTime:2}},ao=invertSerializeMap(oo),co={getThreadMsgs:{sid:23,cid:1,service:"msgExtend",params:[{type:"Property",name:"msg",reflectMapper:oo.msg},{type:"Property",name:"threadMsgReq",reflectMapper:oo.threadMsgReq}],response:[{type:"Property",name:"threadMsg",reflectMapper:ao.msg},{type:"Property",name:"threadMsgsMeta",reflectMapper:ao.threadMsgsMeta},{type:"PropertyArray",name:"msgs",reflectMapper:ao.msg}]},getMsgsByIdServer:{sid:23,cid:2,service:"msgExtend",params:[{type:"PropertyArray",name:"reqMsgs",reflectMapper:oo.msg}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:ao.msg}]}};var mo;!function(e){e[e.ASC=1]="ASC",e[e.DESC=2]="DESC"}(mo||(mo={}));const po={"7_6":"getHistoryMsgs","7_9":"deleteRoamingMsgs","4_24":"syncClearServerHistoryMsgs","7_18":"clearHistoryMsgsFromServer","7_118":"multiSyncClearServerHistoryMsgs","7_26":"nimFtsCloudMsgLogsAggWithSession","7_27":"nimFtsCloudMsgLogs"},lo={msg:is,clearHistoryMsgsFromServerReqTag:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,ext:7},clearMsgsParamsWithSync:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,fromAccid:5,time:6,ext:7},ftsReqTag:{keyword:1,fromTime:2,toTime:3,sessionLimit:4,msglogsLimit:5,orderRule:6,p2pSessionList:7,teamSessionList:8,senderList:9,msgTypeList:10,msgSubTypeList:11}},uo=invertSerializeMap(lo),go={deleteRoamingMsgs:{sid:7,cid:9,service:"msgLog",params:[{type:"StrArray",name:"ids"}]},getHistoryMsgs:{sid:7,cid:6,params:[{type:"String",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"int",name:"limit"},{type:"bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:uo.msg}],service:"msgLog"},clearHistoryMsgsFromServer:{sid:7,cid:18,params:[{type:"Property",name:"clearHistoryMsgsFromServerReqTag",reflectMapper:lo.clearHistoryMsgsFromServerReqTag}],response:[{type:"Long",name:"timetag"}],service:"msgLog"},multiSyncClearServerHistoryMsgs:{sid:7,cid:118,response:[{type:"Property",name:"data",reflectMapper:uo.clearMsgsParamsWithSync}],service:"msgLog"},syncClearServerHistoryMsgs:{sid:4,cid:24,service:"msgLog",response:[{type:"PropertyArray",name:"datas",reflectMapper:uo.clearMsgsParamsWithSync}]},nimFtsCloudMsgLogsAggWithSession:{sid:7,cid:26,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:lo.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:uo.msg}]},nimFtsCloudMsgLogs:{sid:7,cid:27,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:lo.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:uo.msg}]}};var yo;!function(e){e[e.p2p=1]="p2p",e[e.team=2]="team"}(yo||(yo={}));const ho={type:{type:"enum",values:yo},isDeleteRoam:{type:"boolean"},isSyncSelf:{type:"boolean"},time:{type:"number"}};function formatClearResult(e){const t=format(ho,e);return{sessionId:"p2p"===t.type?`p2p-${t.otherAccid}`:`team-${t.toTid}`,time:t.time}}const fo={orderRule:{type:"enum",values:mo}};const vo={"22_1":"requestProxy","22_2":"onRequestProxy"},To={requestProxyTag:{zone:1,path:2,method:3,header:4,body:5},requestProxyMsgTag:{from:1,body:2,time:3}},bo=invertSerializeMap(To),So={requestProxy:{sid:22,cid:1,service:"passThrough",params:[{type:"Property",name:"requestProxyTag",reflectMapper:To.requestProxyTag}],response:[{type:"Property",name:"requestProxyTag",reflectMapper:bo.requestProxyTag}]},onRequestProxy:{sid:22,cid:2,service:"passThrough",response:[{type:"Property",name:"proxyMsg",reflectMapper:bo.requestProxyMsgTag}]}};var Mo=function pickBy(e,t){if(null==e)return{};var r=Le(ui(e),(function(e){return[e]}));return t=En(t),fs(e,r,(function(e,r){return t(e,r[0])}))};const ko={"6_2":"getNosToken","6_22":"getOriginUrl","6_26":"getNosCdnHost","6_27":"getGrayscaleConfig","6_28":"getMixStorePolicy","6_29":"getMixStoreToken","6_30":"getFileAuthToken"},_o={nosToken:{objectName:1,token:2,bucket:3,expireTime:4,expireSec:7,tag:8,shortUrl:9},mixStoreTokenReqTag:{provider:0,tokenCount:1,fileExpireSec:2,tag:3,returnBody:4},nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4},grayConfigTag:{config:0,ttl:1},mixStorePolicyTag:{providers:0,ttl:1,mixEnable:2,nosPolicy:3,s3Policy:4},mixStoreTokenResTag:{provider:0,accessKeyId:1,secretAccessKey:2,sessionToken:3,token:4,expireTime:5,bucket:6,objectName:7,fileExpireSec:8,tag:9,shortUrl:10,region:11},nosSafeUrlTag:{safeUrl:0,originUrl:1},mixStoreAuthTokenReqTag:{type:1,urls:2},mixStoreAuthTokenResTag:{type:1,tokens:2,token:3,ttl:4}},wo=invertSerializeMap(_o),Io={getNosToken:{sid:6,cid:2,service:"cloudStorage",response:[{type:"Property",name:"nosToken",reflectMapper:wo.nosToken}],params:[{type:"String",name:"responseBody"},{type:"Property",name:"nosToken",entity:"nosToken",reflectMapper:_o.nosToken}]},getOriginUrl:{sid:6,cid:22,service:"cloudStorage",response:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:wo.nosSafeUrlTag}],params:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:_o.nosSafeUrlTag}]},getNosCdnHost:{sid:6,cid:26,service:"misc",response:[{type:"Property",name:"nosConfigTag",reflectMapper:wo.nosConfigTag}]},getGrayscaleConfig:{sid:6,cid:27,service:"cloudStorage",response:[{type:"Property",name:"grayConfigTag",reflectMapper:wo.grayConfigTag}],params:[{type:"Property",name:"config"}]},getMixStorePolicy:{sid:6,cid:28,service:"cloudStorage",params:[{type:"LongArray",name:"supportType"}],response:[{type:"Property",name:"mixStorePolicyTag",reflectMapper:wo.mixStorePolicyTag}]},getMixStoreToken:{sid:6,cid:29,service:"cloudStorage",params:[{type:"Property",name:"mixStoreTokenReqTag",reflectMapper:_o.mixStoreTokenReqTag}],response:[{type:"Property",name:"mixStoreTokenResTag",reflectMapper:wo.mixStoreTokenResTag}]},getFileAuthToken:{sid:6,cid:30,service:"cloudStorage",params:[{type:"Property",name:"mixStoreAuthTokenReqTag",reflectMapper:_o.mixStoreAuthTokenReqTag}],response:[{type:"Property",name:"mixStoreAuthTokenResTag",reflectMapper:wo.mixStoreAuthTokenResTag}]}};var Co,Eo;!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(Co||(Co={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(Eo||(Eo={}));const xo={chunkUploadHost:"https://wanproxy-web.127.net",commonUploadHost:"https://nos.netease.com",chunkMaxSize:4194304e4,commonMaxSize:104857600,uploadReplaceFormat:"https://{host}/{object}",cdn:{defaultCdnDomain:"nim.nosdn.127.net",cdnDomain:"",bucket:"",objectNamePrefix:""},downloadUrl:"https://{bucket}-nosdn.netease.im/{object}",downloadHostList:["nos.netease.com"],nosCdnEnable:!0,isNeedToGetUploadPolicyFromServer:!0},Po={file:{md5:"$(Etag)",size:"$(ObjectSize)"},image:{md5:"$(Etag)",size:"$(ObjectSize)",w:"$(ImageInfo.Width)",h:"$(ImageInfo.Height)",orientation:"$(ImageInfo.Orientation)"},audio:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Audio.Duration)"},video:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Video.Duration)",w:"$(AVinfo.Video.Width)",h:"$(AVinfo.Video.Height)"}},Ao={accessKeyId:"",secretAccessKey:"",sessionToken:"",region:"",maxRetries:0,bucket:"",objectName:"",token:"",shortUrl:""};function getUploadResponseFormat(e="file"){const t=Po[e]||{};return JSON.stringify(t).replace(/"/gi,'\\"')}var jo,Oo;!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(jo||(jo={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(Oo||(Oo={}));const Fo=wr({none:0,normal:1,all:3}),Ro=wr({normal:0,advanced:1}),Lo=wr({normal:0,owner:1,manager:2}),No={noVerify:0,needVerify:1,rejectAll:2},Uo=wr(No),Bo={needVerify:0,noVerify:1},Do=wr(Bo),qo={manager:0,all:1},Ho=wr(qo),$o={manager:0,all:1},zo=wr($o),Ko={manager:0,all:1},Vo=wr(Ko);function formatSuperTeam(e){const t={type:Ro,muteType:Fo,joinMode:Uo,beInviteMode:Do,inviteMode:Ho,updateTeamMode:zo,updateExtMode:Vo},r=__rest(e,["bits"]);return["teamId"].forEach((e=>{r[e]&&(r[e]=r[e].toString())})),["level","memberNum","memberUpdateTime","createTime","updateTime"].forEach((e=>{void 0!==r[e]&&(r[e]=parseInt(r[e]))})),["valid","validToCurrentUser","mute"].forEach((e=>{void 0!==r[e]&&(r[e]=1===parseInt(r[e]))})),Object.keys(t).forEach((e=>{void 0!==r[e]&&(r[e]=t[e][r[e]]||r[e])})),r}function formatSuperTeams(e){return e&&e.length>0?e.map((e=>formatSuperTeam(e))):[]}function generatorSuperTeamMemberForCmd(e){const t={};return void 0!==e.bitConfigMask&&(t.bits=parseInt(e.bitConfigMask)),["teamId","ext","account","nickInTeam"].forEach((r=>{e[r]&&(t[r]=e[r].toString())})),t}function formatSuperTeamMember(e){const t={type:Lo},{bits:r}=e,s=__rest(e,["bits"]);return void 0!==r&&(s.muteTeam=1===parseInt(r),s.bitConfigMask=r),s.id=`${s.teamId}-${s.account}`,["teamId"].forEach((e=>{s[e]&&(s[e]=s[e].toString())})),["joinTime","updateTime","bitConfigMask"].forEach((e=>{void 0!==s[e]&&(s[e]=parseInt(s[e]))})),["active","valid","mute"].forEach((e=>{void 0!==s[e]&&(s[e]=1===parseInt(s[e]))})),Object.keys(t).forEach((e=>{void 0!==s[e]&&(s[e]=t[e][s[e]]||s[e])})),s}function formatSuperTeamMembers(e){return e&&e.length>0?e.map((e=>formatSuperTeamMember(e))):[]}function generatorMemberBySuperTeam(e,t,r="normal"){return{id:`${e.teamId}-${t}`,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersBySuperTeam(e,t,r="normal"){return t&&t.length>0?t.map((t=>generatorMemberBySuperTeam(e,t,r))):[]}class ModuleService{constructor(e){this.core=e}notifyAddSuperTeamMembers(e,t){this.core.emit("addSuperTeamMembers",{team:e,accounts:t,members:generatorMembersBySuperTeam(e,t)})}notifyUpdateSuperTeamManagers(e,t,r,s){this.core.emit("updateSuperTeamManagers",{team:{teamId:e,memberUpdateTime:s},accounts:t,isManager:r,members:t.map((t=>({id:`${e}-${t}`,type:"manager",account:t,updateTime:s})))})}notifyRemoveSuperTeamMembers(e,t){this.core.emit("removeSuperTeamMembers",{team:e,accounts:t})}notifyTransferSuperTeam(e,t,r){this.core.emit("transferSuperTeam",{team:e,from:{id:`${e.teamId}-${t}`,account:t,type:"normal",updateTime:e.memberUpdateTime},to:{id:`${e.teamId}-${r}`,account:r,type:"owner",updateTime:e.memberUpdateTime}})}notifyUpdateSuperTeamMembersMute(e,t,r){this.core.emit("updateSuperTeamMembersMute",{team:e,accounts:t,members:t.map((function(t){return{id:`${e.teamId}-${t}`,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})}}const Go={"21_5":"addSuperTeamMembers","21_6":"removeSuperTeamMembers","21_7":"leaveSuperTeam","21_8":"updateSuperTeamInfo","21_9":"getSuperTeamInfo","21_12":"getSuperTeams","21_15":"getSuperTeamMembers","21_10":"updateMySuperTeamMemberInfo","21_20":"applySuperTeam","21_21":"passSuperTeamApply","21_22":"rejectSuperTeamApply","21_23":"acceptSuperTeamInvite","21_24":"rejectSuperTeamInvite","21_26":"addSuperTeamManagers","21_27":"removeSuperTeamManagers","21_28":"muteSuperTeam","21_29":"muteSuperTeamMembers","21_30":"updateSuperTeamMemberNick","21_31":"transferSuperTeam","21_33":"getSuperTeamMembersByAccounts","21_34":"queryMuteSuperTeamMembers","21_101":"syncCreateSuperTeam","21_109":"syncSuperTeams","21_110":"syncUpdateSuperTeamMember","21_111":"syncMySuperTeamMembers"},Wo={superTeam:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},superTeamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,updateTime:11,ext:12,mute:13,invitorAccid:14,joinTime:15}},Jo=invertSerializeMap(Wo),Yo={getSuperTeamInfo:{sid:21,cid:9,service:"superTeam",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"superTeam",reflectMapper:Jo.superTeam}]},getSuperTeams:{sid:21,cid:12,service:"superTeam",params:[{type:"long",name:"timetag"}],response:[{type:"PropertyArray",name:"superTeams",reflectMapper:Jo.superTeam},{type:"Number",name:"timetag"}]},updateSuperTeamInfo:{sid:21,cid:8,service:"superTeam",params:[{type:"Property",name:"superTeam",reflectMapper:Wo.superTeam}],response:[{type:"Number",name:"time"}]},addSuperTeamMembers:{sid:21,cid:5,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},removeSuperTeamMembers:{sid:21,cid:6,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},addSuperTeamManagers:{sid:21,cid:26,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeSuperTeamManagers:{sid:21,cid:27,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applySuperTeam:{sid:21,cid:20,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"superTeam",reflectMapper:Jo.superTeam}]},transferSuperTeam:{sid:21,cid:31,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"bool",name:"leave"}]},muteSuperTeam:{sid:21,cid:28,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},muteSuperTeamMembers:{sid:21,cid:29,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"Int",name:"mute"}]},updateSuperTeamMemberNick:{sid:21,cid:30,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Wo.superTeamMember}]},updateMySuperTeamMemberInfo:{sid:21,cid:10,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Wo.superTeamMember}]},getSuperTeamMembersByAccounts:{sid:21,cid:33,service:"superTeam",params:[{type:"StrArray",name:"memberIds"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jo.superTeamMember}]},getSuperTeamMembers:{sid:21,cid:15,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jo.superTeamMember}]},queryMuteSuperTeamMembers:{sid:21,cid:34,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jo.superTeamMember}]},leaveSuperTeam:{sid:21,cid:7,service:"superTeam",params:[{type:"Long",name:"teamId"}]},passSuperTeamApply:{sid:21,cid:21,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamApply:{sid:21,cid:22,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptSuperTeamInvite:{sid:21,cid:23,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamInvite:{sid:21,cid:24,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncSuperTeams:{sid:21,cid:109,service:"superTeam",response:[{type:"PropertyArray",name:"teams",reflectMapper:Jo.superTeam},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},syncCreateSuperTeam:{sid:21,cid:101,service:"superTeam",response:[{type:"Property",name:"superTeam",reflectMapper:Jo.superTeam}]},syncUpdateSuperTeamMember:{sid:21,cid:110,service:"superTeam",response:[{type:"Property",name:"teamMember",reflectMapper:Jo.superTeamMember}]},syncMySuperTeamMembers:{sid:21,cid:111,ext:"sync",service:"superTeam",response:[{type:"PropertyArray",name:"teamMembers",reflectMapper:Jo.superTeamMember},{type:"Number",name:"timetag"}]}};const Xo={"13_1":"getChatroomAddress","24_1":"getQChatAddress"},Qo={getChatroomAddress:{sid:13,cid:1,service:"plugin",params:[{type:"Long",name:"chatroomId"},{type:"Boolean",name:"isWeixinApp"},{type:"Number",name:"ipType"}],response:[{type:"StrArray",name:"address"}]},getQChatAddress:{sid:24,cid:1,service:"plugin",params:[{type:"Property",name:"getQChatAddressTag",reflectMapper:{ipType:1}}],response:[{type:"StrArray",name:"address"}]}};var Zo=Zo||function(e){var t;"undefined"!=typeof window&&window.crypto&&(t=window.crypto),"undefined"!=typeof self&&self.crypto&&(t=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(t=globalThis.crypto),!t&&"undefined"!=typeof window&&window.msCrypto&&(t=window.msCrypto),!t&&"undefined"!=typeof global&&global.crypto&&(t=global.crypto);var cryptoSecureRandomInt=function(){if(t){if("function"==typeof t.getRandomValues)try{return t.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof t.randomBytes)try{return t.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},r=Object.create||function(){function F(){}return function(e){var t;return F.prototype=e,t=new F,F.prototype=null,t}}(),s={},n=s.lib={},i=n.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,s=this.sigBytes,n=e.sigBytes;if(this.clamp(),s%4)for(var i=0;i<n;i++){var o=r[i>>>2]>>>24-i%4*8&255;t[s+i>>>2]|=o<<24-(s+i)%4*8}else for(var a=0;a<n;a+=4)t[s+a>>>2]=r[a>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(cryptoSecureRandomInt());return new o.init(t,e)}}),a=s.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,s=[],n=0;n<r;n++){var i=t[n>>>2]>>>24-n%4*8&255;s.push((i>>>4).toString(16)),s.push((15&i).toString(16))}return s.join("")},parse:function(e){for(var t=e.length,r=[],s=0;s<t;s+=2)r[s>>>3]|=parseInt(e.substr(s,2),16)<<24-s%8*4;return new o.init(r,t/2)}},d=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,s=[],n=0;n<r;n++){var i=t[n>>>2]>>>24-n%4*8&255;s.push(String.fromCharCode(i))}return s.join("")},parse:function(e){for(var t=e.length,r=[],s=0;s<t;s++)r[s>>>2]|=(255&e.charCodeAt(s))<<24-s%4*8;return new o.init(r,t)}},m=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},p=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=m.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,s=this._data,n=s.words,i=s.sigBytes,a=this.blockSize,c=i/(4*a),d=(c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0))*a,m=e.min(4*d,i);if(d){for(var p=0;p<d;p+=a)this._doProcessBlock(n,p);r=n.splice(0,d),s.sigBytes-=m}return new o.init(r,m)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=p.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new l.HMAC.init(e,r).finalize(t)}}});var l=s.algo={};return s}(Math),ea=Zo.enc.Utf8,ta=Zo,ra=ta.lib,sa=ra.WordArray,na=ra.Hasher,ia=ta.algo,oa=[],aa=ia.SHA1=na.extend({_doReset:function(){this._hash=new sa.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,s=r[0],n=r[1],i=r[2],o=r[3],a=r[4],c=0;c<80;c++){if(c<16)oa[c]=0|e[t+c];else{var d=oa[c-3]^oa[c-8]^oa[c-14]^oa[c-16];oa[c]=d<<1|d>>>31}var m=(s<<5|s>>>27)+a+oa[c];m+=c<20?1518500249+(n&i|~n&o):c<40?1859775393+(n^i^o):c<60?(n&i|n&o|i&o)-1894007588:(n^i^o)-899497514,a=o,o=i,i=n<<30|n>>>2,n=s,s=m}r[0]=r[0]+s|0,r[1]=r[1]+n|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,s=8*e.sigBytes;return t[s>>>5]|=128<<24-s%32,t[14+(s+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(s+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=na.clone.call(this);return e._hash=this._hash.clone(),e}});ta.SHA1=na._createHelper(aa),ta.HmacSHA1=na._createHmacHelper(aa),Zo.SHA1,function(e){var t=e,r=t.lib.Base,s=t.enc.Utf8;t.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=s.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),a=i.words,c=o.words,d=0;d<r;d++)a[d]^=1549556828,c[d]^=909522486;i.sigBytes=o.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}(Zo);var ca=Zo,da=ca.lib,ma=da.Base,pa=da.WordArray,la=ca.algo,ua=la.MD5,ga=la.EvpKDF=ma.extend({cfg:ma.extend({keySize:4,hasher:ua,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var r,s=this.cfg,n=s.hasher.create(),i=pa.create(),o=i.words,a=s.keySize,c=s.iterations;o.length<a;){r&&n.update(r),r=n.update(e).finalize(t),n.reset();for(var d=1;d<c;d++)r=n.finalize(r),n.reset();i.concat(r)}return i.sigBytes=4*a,i}});ca.EvpKDF=function(e,t,r){return ga.create(r).compute(e,t)},Zo.EvpKDF;var ya=Zo,ha=ya.lib.WordArray;ya.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,s=this._map;e.clamp();for(var n=[],i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;a<4&&i+.75*a<r;a++)n.push(s.charAt(o>>>6*(3-a)&63));var c=s.charAt(64);if(c)for(;n.length%4;)n.push(c);return n.join("")},parse:function(e){var t=e.length,r=this._map,s=this._reverseMap;if(!s){s=this._reverseMap=[];for(var n=0;n<r.length;n++)s[r.charCodeAt(n)]=n}var i=r.charAt(64);if(i){var o=e.indexOf(i);-1!==o&&(t=o)}return function parseLoop(e,t,r){for(var s=[],n=0,i=0;i<t;i++)if(i%4){var o=r[e.charCodeAt(i-1)]<<i%4*2|r[e.charCodeAt(i)]>>>6-i%4*2;s[n>>>2]|=o<<24-n%4*8,n++}return ha.create(s,n)}(e,t,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},Zo.enc.Base64;var fa=Zo,va=fa.lib,Ta=va.WordArray,ba=va.Hasher,Sa=fa.algo,Ma=[];!function(){for(var e=0;e<64;e++)Ma[e]=4294967296*Math.abs(Math.sin(e+1))|0}();var ka=Sa.MD5=ba.extend({_doReset:function(){this._hash=new Ta.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var s=t+r,n=e[s];e[s]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var i=this._hash.words,o=e[t+0],a=e[t+1],c=e[t+2],d=e[t+3],m=e[t+4],p=e[t+5],l=e[t+6],u=e[t+7],g=e[t+8],y=e[t+9],h=e[t+10],f=e[t+11],v=e[t+12],T=e[t+13],b=e[t+14],S=e[t+15],M=i[0],k=i[1],_=i[2],w=i[3];M=FF(M,k,_,w,o,7,Ma[0]),w=FF(w,M,k,_,a,12,Ma[1]),_=FF(_,w,M,k,c,17,Ma[2]),k=FF(k,_,w,M,d,22,Ma[3]),M=FF(M,k,_,w,m,7,Ma[4]),w=FF(w,M,k,_,p,12,Ma[5]),_=FF(_,w,M,k,l,17,Ma[6]),k=FF(k,_,w,M,u,22,Ma[7]),M=FF(M,k,_,w,g,7,Ma[8]),w=FF(w,M,k,_,y,12,Ma[9]),_=FF(_,w,M,k,h,17,Ma[10]),k=FF(k,_,w,M,f,22,Ma[11]),M=FF(M,k,_,w,v,7,Ma[12]),w=FF(w,M,k,_,T,12,Ma[13]),_=FF(_,w,M,k,b,17,Ma[14]),M=GG(M,k=FF(k,_,w,M,S,22,Ma[15]),_,w,a,5,Ma[16]),w=GG(w,M,k,_,l,9,Ma[17]),_=GG(_,w,M,k,f,14,Ma[18]),k=GG(k,_,w,M,o,20,Ma[19]),M=GG(M,k,_,w,p,5,Ma[20]),w=GG(w,M,k,_,h,9,Ma[21]),_=GG(_,w,M,k,S,14,Ma[22]),k=GG(k,_,w,M,m,20,Ma[23]),M=GG(M,k,_,w,y,5,Ma[24]),w=GG(w,M,k,_,b,9,Ma[25]),_=GG(_,w,M,k,d,14,Ma[26]),k=GG(k,_,w,M,g,20,Ma[27]),M=GG(M,k,_,w,T,5,Ma[28]),w=GG(w,M,k,_,c,9,Ma[29]),_=GG(_,w,M,k,u,14,Ma[30]),M=HH(M,k=GG(k,_,w,M,v,20,Ma[31]),_,w,p,4,Ma[32]),w=HH(w,M,k,_,g,11,Ma[33]),_=HH(_,w,M,k,f,16,Ma[34]),k=HH(k,_,w,M,b,23,Ma[35]),M=HH(M,k,_,w,a,4,Ma[36]),w=HH(w,M,k,_,m,11,Ma[37]),_=HH(_,w,M,k,u,16,Ma[38]),k=HH(k,_,w,M,h,23,Ma[39]),M=HH(M,k,_,w,T,4,Ma[40]),w=HH(w,M,k,_,o,11,Ma[41]),_=HH(_,w,M,k,d,16,Ma[42]),k=HH(k,_,w,M,l,23,Ma[43]),M=HH(M,k,_,w,y,4,Ma[44]),w=HH(w,M,k,_,v,11,Ma[45]),_=HH(_,w,M,k,S,16,Ma[46]),M=II(M,k=HH(k,_,w,M,c,23,Ma[47]),_,w,o,6,Ma[48]),w=II(w,M,k,_,u,10,Ma[49]),_=II(_,w,M,k,b,15,Ma[50]),k=II(k,_,w,M,p,21,Ma[51]),M=II(M,k,_,w,v,6,Ma[52]),w=II(w,M,k,_,d,10,Ma[53]),_=II(_,w,M,k,h,15,Ma[54]),k=II(k,_,w,M,a,21,Ma[55]),M=II(M,k,_,w,g,6,Ma[56]),w=II(w,M,k,_,S,10,Ma[57]),_=II(_,w,M,k,l,15,Ma[58]),k=II(k,_,w,M,T,21,Ma[59]),M=II(M,k,_,w,m,6,Ma[60]),w=II(w,M,k,_,f,10,Ma[61]),_=II(_,w,M,k,c,15,Ma[62]),k=II(k,_,w,M,y,21,Ma[63]),i[0]=i[0]+M|0,i[1]=i[1]+k|0,i[2]=i[2]+_|0,i[3]=i[3]+w|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,s=8*e.sigBytes;t[s>>>5]|=128<<24-s%32;var n=Math.floor(r/4294967296),i=r;t[15+(s+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t[14+(s+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),e.sigBytes=4*(t.length+1),this._process();for(var o=this._hash,a=o.words,c=0;c<4;c++){var d=a[c];a[c]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return o},clone:function(){var e=ba.clone.call(this);return e._hash=this._hash.clone(),e}});function FF(e,t,r,s,n,i,o){var a=e+(t&r|~t&s)+n+o;return(a<<i|a>>>32-i)+t}function GG(e,t,r,s,n,i,o){var a=e+(t&s|r&~s)+n+o;return(a<<i|a>>>32-i)+t}function HH(e,t,r,s,n,i,o){var a=e+(t^r^s)+n+o;return(a<<i|a>>>32-i)+t}function II(e,t,r,s,n,i,o){var a=e+(r^(t|~s))+n+o;return(a<<i|a>>>32-i)+t}fa.MD5=ba._createHelper(ka),fa.HmacMD5=ba._createHmacHelper(ka),Zo.MD5,function(e){e.lib.Cipher||function(){var t=e,r=t.lib,s=r.Base,n=r.WordArray,i=r.BufferedBlockAlgorithm,o=t.enc;o.Utf8;var a=o.Base64,c=t.algo.EvpKDF,d=r.Cipher=i.extend({cfg:s.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(e){return"string"==typeof e?v:h}return function(e){return{encrypt:function(t,r,s){return selectCipherStrategy(r).encrypt(e,t,r,s)},decrypt:function(t,r,s){return selectCipherStrategy(r).decrypt(e,t,r,s)}}}}()});r.StreamCipher=d.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var m=t.mode={},p=r.BlockCipherMode=s.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),l=m.CBC=function(){var e=p.extend();function xorBlock(e,t,r){var s,n=this._iv;n?(s=n,this._iv=void 0):s=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=s[i]}return e.Encryptor=e.extend({processBlock:function(e,t){var r=this._cipher,s=r.blockSize;xorBlock.call(this,e,t,s),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+s)}}),e.Decryptor=e.extend({processBlock:function(e,t){var r=this._cipher,s=r.blockSize,n=e.slice(t,t+s);r.decryptBlock(e,t),xorBlock.call(this,e,t,s),this._prevBlock=n}}),e}(),u=(t.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,s=r-e.sigBytes%r,i=s<<24|s<<16|s<<8|s,o=[],a=0;a<s;a+=4)o.push(i);var c=n.create(o,s);e.concat(c)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}};r.BlockCipher=d.extend({cfg:d.cfg.extend({mode:l,padding:u}),reset:function(){var e;d.reset.call(this);var t=this.cfg,r=t.iv,s=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=s.createEncryptor:(e=s.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,r&&r.words):(this._mode=e.call(s,this,r&&r.words),this._mode.__creator=e)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4});var g=r.CipherParams=s.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),y=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;return(r?n.create([1398893684,1701076831]).concat(r).concat(t):t).toString(a)},parse:function(e){var t,r=a.parse(e),s=r.words;return 1398893684==s[0]&&1701076831==s[1]&&(t=n.create(s.slice(2,4)),s.splice(0,4),r.sigBytes-=16),g.create({ciphertext:r,salt:t})}},h=r.SerializableCipher=s.extend({cfg:s.extend({format:y}),encrypt:function(e,t,r,s){s=this.cfg.extend(s);var n=e.createEncryptor(r,s),i=n.finalize(t),o=n.cfg;return g.create({ciphertext:i,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:s.format})},decrypt:function(e,t,r,s){return s=this.cfg.extend(s),t=this._parse(t,s.format),e.createDecryptor(r,s).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),f=(t.kdf={}).OpenSSL={execute:function(e,t,r,s){s||(s=n.random(8));var i=c.create({keySize:t+r}).compute(e,s),o=n.create(i.words.slice(t),4*r);return i.sigBytes=4*t,g.create({key:i,iv:o,salt:s})}},v=r.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:f}),encrypt:function(e,t,r,s){var n=(s=this.cfg.extend(s)).kdf.execute(r,e.keySize,e.ivSize);s.iv=n.iv;var i=h.encrypt.call(this,e,t,n.key,s);return i.mixIn(n),i},decrypt:function(e,t,r,s){s=this.cfg.extend(s),t=this._parse(t,s.format);var n=s.kdf.execute(r,e.keySize,e.ivSize,t.salt);return s.iv=n.iv,h.decrypt.call(this,e,t,n.key,s)}})}()}(Zo);const _a=Zo,wa=_a.lib.StreamCipher,Ia=_a.algo,Ca=Ia.RC4=wa.extend({_doReset:function(){const e=this._key,t=e.words,r=e.sigBytes,s=this._S=[];for(var n=0;n<256;n++)s[n]=n;n=0;for(var i=0;n<256;n++){const e=n%r,o=t[e>>>2]>>>24-e%4*8&255;i=(i+s[n]+o)%256;const a=s[n];s[n]=s[i],s[i]=a}this._i=this._j=0},_doProcessBlock:function(e,t){e[t]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){const e=this._S;let t=this._i,r=this._j,s=0;for(let n=0;n<4;n++){t=(t+1)%256,r=(r+e[t])%256;const i=e[t];e[t]=e[r],e[r]=i,s|=e[(e[t]+e[r])%256]<<24-8*n}return this._i=t,this._j=r,s}_a.RC4=wa._createHelper(Ca);const Ea=Ia.RC4Drop=Ca.extend({cfg:Ca.cfg.extend({drop:192}),_doReset:function(){Ca._doReset.call(this);for(let e=this.cfg.drop;e>0;e--)generateKeystreamWord.call(this)}});_a.RC4Drop=wa._createHelper(Ea);var xa=Zo.RC4;const Pa={"3_1":"updatePushToken","3_2":"updateAppBackground"},Aa={updatePushToken:{sid:3,cid:1,service:"user",params:[{type:"String",name:"tokenName"},{type:"String",name:"token"},{type:"Int",name:"pushkit"}]},updateAppBackground:{sid:3,cid:2,service:"user",params:[{type:"Boolean",name:"isBackground"},{type:"Int",name:"badge"}]}};return NIM.setAdapters(Rt),NIM.registerService(class AuthService extends Service{constructor(e){super("auth",e),registerParser({cmdMap:mt,cmdConfig:ut})}doLogin(e=!1){var t,r;return __awaiter(this,void 0,void 0,(function*(){const s=this.core.options,n=w.getSystemInfo(),i=Object.assign(Object.assign({},s),{appLogin:e?0:1,appkey:s.appkey,account:s.account,token:s.token,deviceId:this.core.config.deviceId,clientType:16,protocolVersion:1,sdkVersion:91e3,sdkHumanVersion:"0.13.0",os:n.os,browser:n.browser,session:null===(t=this.core.socket)||void 0===t?void 0:t.sessionId,sdkType:Pr[w.platform]||0,userAgent:"Native/0.13.0"}),o=n.os.toLowerCase();"UNIAPP"!==w.platform||"ios"!==o&&"android"!==o||(i.isReactNative=1,i.clientType="ios"===o?2:1,n.pushDeviceInfo&&n.pushDeviceInfo.MANUFACTURER&&(i.deviceInfo=JSON.stringify(n.pushDeviceInfo))),this.logger.log("auth::do login ",s.account,null===(r=this.core.socket)||void 0===r?void 0:r.sessionId);const a=yield this.core.sendCmd("login",{login:i});if(a.error)throw a.error;const{loginRes:c,loginPorts:d,aosPushInfo:m}=a.content;let p=formatMultiPortLoginInfo(d,2);return p=p.filter((e=>e.connectionId!==c.connectionId)),p.length>0&&this.core.emit("multiPortLogin",p),Object.assign(Object.assign({},c),{aosPushInfo:m})}))}kick(e){var t;return __awaiter(this,void 0,void 0,(function*(){const r=yield this.core.sendCmd("kick",e);return null===(t=r.content)||void 0===t?void 0:t.deviceIds}))}multiPortLoginHandler(e){if(e.error)return void this.logger.error("multiPortLoginHandler:: error, ",e.error);const{loginPorts:t,state:r}=e.content,s=formatMultiPortLoginInfo(t,r);s.length>0&&this.core.emit("multiPortLogin",s)}kickedHandler(e){if(e.error)return void this.logger.error("kickedHandler:: error, ",e.error);const t=function formatBeKickedTag(e){const t=format({clientType:{type:"enum",values:Ut},customClientType:{type:"number"}},e);let r=xr[t.reason];return r=r||{reason:"unknow",message:"Unknown reason"},Object.assign(t,r)}(e.content);this.logger.warn("kicked::",t),this.core.doDisconnect(ct.KICKED,t)}},"auth"),NIM.registerService(class MsgService extends Service{constructor(e){super("msg",e),this.service=new ModuleService$2(e),registerParser({cmdMap:ns,cmdConfig:cs})}sendTextMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"text"}))}sendTipMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"tip"}))}sendGeoLocationMsg(e){return validate({attach:{type:"object",rules:{title:{type:"string",allowEmpty:!1},lat:{type:"number"},lng:{type:"number"}}}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"geo",attach:JSON.stringify(e.attach)}))}sendCustomMsg(e){return validate({attach:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"custom"}))}sendMsg(e){var t;validate({scene:{type:"enum",values:getEnumKeys(Nt)},type:{type:"enum",values:getEnumKeys(Lt)},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},setting:{type:"object",rules:{resendFlag:{type:"boolean",required:!1},needSaveHistory:{type:"boolean",required:!1},needRoaming:{type:"boolean",required:!1},needOffline:{type:"boolean",required:!1},needSelfSync:{type:"boolean",required:!1},needRouted:{type:"boolean",required:!1},needUpdateSession:{type:"boolean",required:!1}},required:!1},antiSpamInfo:{type:"object",required:!1,rules:{clientAntispamHitting:{type:"boolean",required:!1},antiSpamUsingYidun:{type:"boolean",required:!1}}},pushInfo:{type:"object",required:!1,rules:{needPush:{type:"boolean",required:!1},pushApnsText:{type:"string",allowEmpty:!1,required:!1},pushPayload:{type:"string",allowEmpty:!1,max:2048,required:!1}}},teamSpecializationInfo:{type:"object",required:!1,rules:{needForcePush:{type:"boolean",required:!1},needACK:{type:"boolean",required:!1},forcePushIDsList:{type:"string",allowEmpty:!1,required:!1},pushContent:{type:"string",allowEmpty:!1,max:150,required:!1}}}},e);const r="p2p"===e.scene?"sendMsg":"team"===e.scene?"sendTeamMsg":"sendSuperTeamMsg",s=function generatorMsgForCmd(e,t,r,s){const{onSendBefore:n,onUploadStart:i,onUploadDone:o,replyMsg:a}=e,c=__rest(e,["onSendBefore","onUploadStart","onUploadDone","replyMsg"]),d=Object.assign(Object.assign({},formatReverse(es,c)),{scene:Nt[e.scene],type:Lt[e.type],from:t,fromClientType:16,fromDeviceId:r,fromNick:null==s?void 0:s.nick,userUpdateTime:null==s?void 0:s.updateTime,status:Bt[Bt.sending]});if(d.idClient=d.resendFlag?e.idClient:at(),!d.idClient)throw new FormatError("idClient is required to resend a message","idClient","required");return d.scene===Nt.team&&d.needForcePush&&(d.pushContent=d.pushContent||d.pushApnsText,d.forcePushIDsList=d.forcePushIDsList?d.forcePushIDsList:"#%@all@%#"),a&&(d.replyMsgFromAccount=a.from,d.replyMsgToAccount=a.to,d.replyMsgTime=+a.time,d.replyMsgIdServer=a.idServer,d.replyMsgIdClient=a.idClient,d.threadMsgFromAccount=a.from,d.threadMsgToAccount=a.to,d.threadMsgTime=+a.time,d.threadMsgIdServer=a.idServer,d.threadMsgIdClient=a.idClient,a.threadMessageInfo&&a.threadMessageInfo.threadMsgIdServer&&(d.threadMsgFromAccount=a.threadMessageInfo.threadMsgFromAccount,d.threadMsgToAccount=a.threadMessageInfo.threadMsgToAccount,d.threadMsgTime=a.threadMessageInfo.threadMsgTime,d.threadMsgIdServer=a.threadMessageInfo.threadMsgIdServer,d.threadMsgIdClient=a.threadMessageInfo.threadMsgIdClient)),d}(e,this.core.account,this.core.config.deviceId,null===(t=this.core.user)||void 0===t?void 0:t.myInfo),n=formatMsg(Object.assign(Object.assign({},s),{time:(new Date).getTime()}),{account:this.core.account,featureValue:Dt.default,statusValue:Bt.sending});try{e.onSendBefore&&e.onSendBefore(n)}catch(e){this.logger.error("sendMsg: options.onSendBefore error",e)}let i;return this.core.eventBus.emit("session/updateForNewMsg",n),this.core.sendCmd(r,{msg:s}).then((t=>{const{content:r,error:o}=t;if(i=r.msg,o)throw o;const a=formatMsg(Object.assign(Object.assign({},s),r.msg),{account:this.core.account,featureValue:Dt.default,statusValue:Bt.sent});return a.from===a.to&&this.markMsgsAck([a]),this.core.eventBus.emit("session/updateForNewMsg",a),this.core.reporter.report("msgSend",{msgId:a.idServer,clientId:a.idClient,msgTime:a.time,fromAccid:"p2p"===e.scene?this.core.account:"",toAccid:a.to,type:Nt[a.scene],roomId:"",tid:"p2p"===e.scene?"":a.to,result:200,faiReason:"",rt:Date.now()-n.time}),a})).catch((t=>{const r=formatMsg(Object.assign(Object.assign(Object.assign({},s),{time:(new Date).getTime()}),i),{account:this.core.account,featureValue:Dt.default,statusValue:7101===t.code?Bt.refused:Bt.sendFailed});throw t.msg=r,this.core.eventBus.emit("session/updateForNewMsg",r),this.core.reporter.report("msgSend",{msgId:r.idServer,clientId:r.idClient,msgTime:r.time,fromAccid:"p2p"===e.scene?this.core.account:"",toAccid:r.to,type:Nt[r.scene],roomId:"",tid:"p2p"===e.scene?"":r.to,result:null==t?void 0:t.code,faiReason:(null==t?void 0:t.message)||"",rt:Date.now()-n.time}),t}))}resendMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}}},e);const t=e.msg,r=Object.assign(Object.assign({},t),{attach:t.attach?JSON.stringify(t.attach):void 0,setting:{resendFlag:!0}});if(t.from!==this.core.account)throw new Error(`You can only resend messages that you sent: ${t.idClient}`);return this.sendMsg(r)}))}forwardMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}},scene:{type:"enum",values:getEnumKeys(Nt)},to:{type:"string",allowEmpty:!1}},e);const t=e.msg,r=Object.assign(Object.assign({},t),{scene:e.scene,to:e.to,attach:t.attach?JSON.stringify(t.attach):void 0});return this.sendMsg(r)}))}sendImageMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"image"}))}sendFileMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"file"}))}sendAudioMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"audio"}))}sendVideoMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"video"}))}doSendFile(e){return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:getEnumKeys(Nt)},to:{type:"string",allowEmpty:!1},type:{type:"string",allowEmpty:!1},attach:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e);let t=e.attach;if(!t){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');try{this.core.reporter.reportTraceStart("nos",{user_id:this.core.account,action:"upload"}),t=yield this.core.cloudStorage.uploadFile(e),this.core.reporter.reportTraceEnd("nos",!0)}catch(e){const t=e;throw this.core.reporter.reportTraceUpdateV2("nos",{operation_type:"transfer",description:t.message,code:t.code||0,target:"",succeed:!1}),this.core.reporter.reportTraceEnd("nos",!1),this.logger.error("sendFile:: upload File error or abort",e),e}try{e.onUploadDone&&e.onUploadDone(t)}catch(e){throw this.logger.error("sendFile options.onUploadDone err",e),e}}return this.sendMsg(Object.assign(Object.assign({},e),{attach:JSON.stringify(t),type:e.type}))}))}recallMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},scene:{type:"enum",values:getEnumKeys(Nt)},time:{type:"number"}}},apnsText:{type:"string",allowEmpty:!1,required:!1},ps:{type:"string",allowEmpty:!1,required:!1}},e);const t=e.msg;return yield this.core.sendCmd({p2p:"recallMsg",team:"recallMsg",superTeam:"recallSuperTeamMsg"}[t.scene],{recallMsgTag:{time:t.time,type:{p2p:7,team:8,superTeam:12}[t.scene],to:t.to,from:t.from,ps:e.ps,attach:e.attach,apnsText:e.apnsText,pushPayload:e.pushPayload,deletedIdClient:t.idClient,deletedIdServer:t.idServer,opeAccount:t.from,env:e.env}}),this.core.eventBus.emit("session/updateForDeletedMsg",formatDeletedMsgs([t])),t}))}deleteSelfMsgs(e){return __awaiter(this,void 0,void 0,(function*(){validate({msgs:{type:"array",rules:{scene:{type:"enum",values:["p2p","team"]},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},time:{type:"number",allowEmpty:!1}}},ext:{type:"string",allowEmpty:!1,required:!1}},e);const t=e.msgs.map((t=>({scene:"p2p"===t.scene?1:2,from:t.from,to:t.to,idServer:t.idServer,idClient:t.idClient,time:t.time,ext:e.ext})));yield this.core.sendCmd("deleteSelfMsgs",{deletedMsgs:t});const r=formatDeletedMsgs(t);return this.core.eventBus.emit("session/updateForDeletedMsg",r),r}))}sendMsgReceipt(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},target:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e);const s=e.msg;if("p2p"!==s.scene||"in"!==s.flow)return void this.logger.warn(`Msg scene: ${s.scene}, flow: ${s.flow} is not allowed to send msg receipt`);const n={to:s.target,idClient:s.idClient,time:s.time},i=yield this.core.sendCmd("sendMsgReceipt",{msgReceiptTag:n}),o=parseInt(null===(r=null===(t=i.content)||void 0===t?void 0:t.msgReceiptTag)||void 0===r?void 0:r.time);return Object.assign(Object.assign({},n),{time:o?Math.min(o,n.time):n.time})}))}sendTeamMsgReceipt(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}},max:50}},e);const t=e.teamMsgReceipts;this.core.sendCmd("sendTeamMsgReceipt",{teamMsgReceipts:t})}))}getTeamMsgReads(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e);const r=e.teamMsgReceipts,s=yield this.core.sendCmd("getTeamMsgReads",{teamMsgReceipts:r});let n=null===(t=s.content)||void 0===t?void 0:t.teamMsgReceipts;return n=n?n.map((e=>Object.assign(Object.assign({},e),{read:parseInt(e.read),unread:parseInt(e.unread)}))):[],n}))}getTeamMsgReadAccounts(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamMsgReceipt:{type:"object",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e);const t=e.teamMsgReceipt;return(yield this.core.sendCmd("getTeamMsgReadAccounts",{teamMsgReceiptTag:t})).content}))}markMsgsAck(e){if(!(e&&e.length>0))return;const t=[],r=[];e.forEach((e=>{"p2p"===e.scene&&"in"===e.flow?t.push(e):"team"===e.scene&&"in"===e.flow&&r.push(e)})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:7,cid:2,ids:t.map((e=>e.idServer))}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:8,cid:3,ids:r.map((e=>e.idServer))})}onMsgHandler(e){var t;if(e.error)return void this.logger.error("msgHandler::recvError",e.error);const r="number"==typeof Pt(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0,s=e.content.msg;s.idServer=s.idServer||r;const n=Date.now(),i=getSessionId(s,this.core.account),o=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:i}),a=formatMsg(s,o?{account:this.core.account,sessionAck:o.ack,msgReceiptTime:o.msgReceiptTime}:{account:this.core.account});if("debug"===this.core.options.debugLevel?this.logger.debug("msgHandler::recvMsg",a.idClient,a.idServer,a):this.logger.log("msgHandler::recvMsg",a.idClient,a.idServer),this.markMsgsAck([a]),this.core.eventBus.emit("session/updateForNewMsg",a),this.core.emit("msg",a),"notification"===a.type)this.core.eventBus.emit("team/onNotification",a);else if("out"!==a.flow){const t="p2p"===a.scene,r={msgId:a.idServer,clientId:a.idClient,receiveTime:e.__receiveTime,serverTime:a.time,callbackTime:Date.now(),preHandleTime:n,fromAccid:a.from,toAccid:this.core.account,type:Nt[a.scene],tid:t?"":a.to,result:200,failReason:"",rt:Date.now()-a.time};this.core.reporter.report("msgReceive",r,!0)}}nimOnTeamMsgsHandler(e){e.content.datas.forEach((t=>{this.onMsgHandler(Object.assign({},e,{content:{msg:t}}))}))}syncRoamingMsgsHandler(e){var t,r;let s=e.content.msgs||[];if(0===s.length)return;const n=getSessionId(s[0],this.core.account),i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:n});s=formatMsgs(s,i?{account:this.core.account,featureValue:Dt.roam,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account,featureValue:Dt.roam});const o=s[0].time,a={timetag:o,sessionId:n,msgs:ss(s)};(null===(r=this.core.sync)||void 0===r?void 0:r.getSyncDoneFlag())||this.core.eventBus.emit("session/syncMsgs",a),this.core.emit("syncRoamingMsgs",a),this.core.eventBus.emit("sync/updateTimetag",{roamingMsgs:o})}syncOfflineMsgsHandler(e){const t=e.content.msgs||[];if(0===t.length)return;const r={},s=[];t.forEach((e=>{const t=getSessionId(e,this.core.account),n=this.core.session.getSessionWithUncomplete({id:t}),i=formatMsg(e,n?{account:this.core.account,featureValue:Dt.leave,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:this.core.account,featureValue:Dt.leave});s.push(i),r[i.sessionId]?r[i.sessionId].push(i):r[i.sessionId]=[i]})),this.markMsgsAck(s);let n=0;Object.keys(r).forEach((e=>{const t=r[e].sort(((e,t)=>t.time-e.time));t[0].time>n&&(n=t[0].time);const s={timetag:t[0].time,sessionId:e,msgs:t};this.core.eventBus.emit("session/syncMsgs",s),this.core.emit("syncOfflineMsgs",s)})),this.core.eventBus.emit("sync/updateTimetag",{offlineMsgs:n})}syncDeleteSelfMsgsHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.deletedMsgs;r&&r.length>0||this.logger.warn("syncDeleteSelfMsgs:: no msgs");const s=r[r.length-1].time;this.core.eventBus.emit("sync/updateTimetag",{deleteSelfMsgs:s})}onDeleteSelfMsgHandler(e){const t=formatDeletedMsgs([e.content.deletedMsg]);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)}onDeleteSelfMsgsHandler(e){const t=formatDeletedMsgs(e.content.deletedMsgs);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)}onBroadcastMsgHandler(e){const t=e.content.msg,r=this.service.processBroadcastMsg([t]);this.core.emit("broadcastMsgs",r)}syncBroadcastMsgHandler(e){const t=e.content.msgs,r=this.service.processBroadcastMsg(t);this.core.emit("broadcastMsgs",r)}},"msg"),NIM.registerService(class MiscService extends Service{constructor(e){super("misc",e),this.core=e,this.nosCdnHostTimer=0,registerParser({cmdMap:ps,cmdConfig:ls})}},"misc"),NIM.registerService(class UserService extends Service{constructor(e){super("user",e),this.myInfo=formatUser({}),registerParser({cmdMap:Yr,cmdConfig:Zr})}setBlack(e){return validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),this.core.sendCmd("setBlack",e).then((()=>{}))}setMute(e){return validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),this.core.sendCmd("setMute",e).then((()=>{}))}getRelations(){return this.core.sendCmd("syncRelations",{timetag:0})}getBlackList(){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("syncRelations",{timetag:0})).blackList||[]}))}getMuteList(){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("syncRelations",{timetag:0})).muteList||[]}))}updatePushToken(){return __awaiter(this,void 0,void 0,(function*(){this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead")}))}updateAppBackground(){return __awaiter(this,void 0,void 0,(function*(){this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead")}))}getUsersNameCardFromServer(e){return validate({accounts:{type:"array",max:150,itemType:"string"}},e),this.core.sendCmd("getUsersNameCardFromServer",Cs(e,["accounts"])).then((t=>{const{content:r}=t;return this.logger.log("user:: getUsers done",e.accounts),r&&r.users?r.users.map((e=>formatUser(e))):[]}))}updateMyNameCard(e){if(validate({nick:{type:"string",required:!1},avatar:{type:"string",required:!1},signature:{type:"string",required:!1},gender:{type:"enum",values:getEnumKeys(Kr),required:!1},email:{type:"string",required:!1},birth:{type:"string",required:!1},tel:{type:"string",required:!1},ext:{type:"string",required:!1}},e),0===Object.keys(e).length)return Promise.resolve(this.myInfo);const t=Cs(e,["nick","avatar","signature","email","birth","tel","ext"]);return e.gender&&(t.gender=Kr[e.gender]),this.core.sendCmd("updateMyNameCard",{user:t}).then((r=>{const{content:s}=r;return s&&s.timetag&&this.core.eventBus.emit("sync/updateTimetag",{myInfo:+s.timetag}),e.gender&&(t.gender=e.gender),this.myInfo=Object.assign({},this.myInfo,t),this.myInfo}))}onUpdateBlackListHandler(e){const{content:t}=e;t.account?this.core.emit("updateBlackList",t):this.logger.warn("onUpdateBlackListHandler: no account")}onUpdateMuteListHandler(e){const{content:t}=e;t.account?this.core.emit("updateMuteList",t):this.logger.warn("onUpdateBlackListHandler: no account")}syncRelationsHandler(e){const{content:t}=e,{list:r,timetag:s}=t,n={blackList:[],muteList:[]};return s&&this.core.eventBus.emit("sync/updateTimetag",{relations:s}),r&&r.length&&r.forEach((e=>{const t=function formatRelationMember(e){const t={account:e.account,updateTime:+e.updateTime,createTime:+e.createTime};return"1"===e.isMuted&&(t.isMuted=!0),"1"===e.isBlack&&(t.isBlack=!0),t}(e);t.isBlack&&n.blackList.push(t),t.isMuted&&n.muteList.push(t)})),this.core.emit("relations",n),Promise.resolve(n)}syncMyNameCardHandler(e){e.content.user&&(this.myInfo=formatUser(e.content.user),this.core.emit("syncMyNameCard",this.myInfo),this.core.eventBus.emit("sync/updateTimetag",{myInfo:e.content.timetag}))}onUpdateMyNameCardHandler(e){const t=e.content.user;t?(Object.assign(this.myInfo,formatUser(t)),this.core.emit("updateMyNameCard",this.myInfo)):this.logger.warn("onUpdateMyNameCardHandler no user info")}},"user"),NIM.registerService(class SessionService extends Service{constructor(e,t){super("session",e),this.list=new Map,this.unreadCountFilterFn=e=>!0,this.lastMessageFilterFn=e=>!0,this.initEventListeners(),registerParser({cmdMap:$n,cmdConfig:Vn}),"function"==typeof(null==t?void 0:t.unreadCountFilterFn)&&(this.unreadCountFilterFn=t.unreadCountFilterFn),"function"==typeof(null==t?void 0:t.lastMessageFilterFn)&&(this.lastMessageFilterFn=t.lastMessageFilterFn),this.stickTopService=new StickTopService(e),this.unreadModule=new UnreadModuleService(e)}initEventListeners(){this.core.eventBus.on("session/syncMsgs",this.onSyncMsgs.bind(this)),this.core.eventBus.on("session/updateForNewMsg",this.updateSessionWithMsg.bind(this)),this.core.eventBus.on("session/updateForClearMsg",((e,t=!0)=>{e&&e.length>0&&e.forEach((e=>{this.updateSession({id:e.sessionId,lastMsg:null,unread:0,unreadMsgs:[]},t)}))})),this.core.eventBus.on("session/updateForDeletedMsg",this.updateSessionForDeletedMsg.bind(this))}createSession(e,t){try{const{scene:r,accid:s}=getAccountFromSessionId(e);return{id:e,scene:r,to:s,lastMsg:t,updateTime:t?t.time:0,unread:0,unreadMsgs:[],ack:0}}catch(t){throw this.logger.error(`Failed to create session with ${e}`,t),new Error(`Failed to create session with ${e}`)}}getSession(e){validate({id:{type:"string",allowEmpty:!1}},e);const t=this.list.get(e.id);if(this.isSessionComplete(t))return t}getSessionWithUncomplete(e){return this.list.get(e.id)}getAllSessions(){const e=[];for(const[t,r]of this.list)this.isSessionComplete(r)&&e.push(r);return e}getSessions(e){validate({limit:{type:"number",required:!1},lastSessionId:{type:"string",allowEmpty:!1,required:!1},desc:{type:"boolean",required:!1}},e);const t=[],{limit:r=100,desc:s=!0}=e;let{lastSessionId:n}=e,i=0;if(s){for(const[e,r]of this.list){if(n===e)break;this.isSessionComplete(r)&&t.push(r)}return t.slice(-r).reverse()}for(const[e,s]of this.list)if(n)e===n&&(n=void 0);else if(this.isSessionComplete(s)){if(++i>r)break;t.push(s)}return t}resetSessionUnreadCount(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1}},e),validate({id:{type:"string",allowEmpty:!1}},e);const r=e.id,s=this.list.get(r);if(!s)throw this.logger.warn("resetSessionUnreadCount: can not find session "+r),new Error("Session::canSessionResetUnreadCount: can not find session "+r);let n=!1;try{n=this.unreadModule.canSessionResetUnreadCount(s)}catch(e){this.logger.warn(e)}if(!1===n)return;const{accid:i,scene:o}=getAccountFromSessionId(r),a={to:i,timetag:(null===(t=null==s?void 0:s.lastMsg)||void 0===t?void 0:t.time)||s.updateTime||0};let c="markSuperTeamSessionAck";return"superTeam"!==o&&(a.scene="p2p"===o?0:1,c="markSessionAck"),this.core.sendCmd(c,a).then((()=>{const e=this.storeUnreadByAck(r,a.timetag);e&&this.core.emit("updateSession",e)}))}))}resetMultiSessionUnreadCount(e){return __awaiter(this,void 0,void 0,(function*(){validate({ids:{type:"array",itemType:"string",min:1}},e);const t=e.ids.map((e=>this.list.get(e))).filter(((t,r)=>!!t||(this.logger.warn("Session::canSessionResetUnreadCount: can not find session "+e.ids[r]),!1))),{superTeam:r,p2pOrTeam:s}=this.unreadModule.filterSessionForResetUnreadCount(t),n=Zn(r.params,10),i=Zn(s.params,10);for(const e of n)yield this.core.sendCmd(r.cmd,{datas:e}),e.forEach((e=>{const t=this.storeUnreadByAck(e.sessionId,e.timetag);t&&this.core.emit("updateSession",t)}));for(const e of i)yield this.core.sendCmd(s.cmd,{datas:e}),e.forEach((e=>{const t=this.storeUnreadByAck(e.sessionId,e.timetag);t&&this.core.emit("updateSession",t)}))}))}resetAllSessionsUnreadCount(){const e=[];return this.list.forEach((t=>{e.push(t.id)})),this.resetMultiSessionUnreadCount({ids:e})}deleteSession(e){return __awaiter(this,void 0,void 0,(function*(){validate({id:{type:"string",allowEmpty:!1},isSyncToServer:{type:"boolean",required:!1}},e),this.list.delete(e.id),this.core.msgLog&&e.isSyncToServer&&(yield this.core.msgLog.deleteRoamingMsgs({ids:[e.id]}))}))}deleteAllSessionsFromLocal(){this.list.clear()}addStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield this.stickTopService.addStickTopSession(e);return this.list.set(t.id,t),t}))}deleteStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield this.stickTopService.deleteStickTopSession(e);return this.list.set(t.id,t),t}))}updateStickTopSession(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield this.stickTopService.updateStickTopSession(e);return this.list.set(t.id,t),t}))}nimMultiSyncAddStickTopSessionHandler(e){const t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimMultiSyncDeleteStickTopSessionHandler(e){const t=this.stickTopService.stickTopSessionHandler({id:e.content.data.id,updateTime:e.content.timetag},!1);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimMultiSyncUpdateStickTopSessionHandler(e){const t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)}nimSyncStickTopSessionsHandler(e){e.content.datas.forEach((e=>{const t=this.stickTopService.stickTopSessionHandler(e);this.list.set(t.id,t)}))}updateSessionWithMsg(e){let t=!0,r=!0;try{t=!!this.unreadCountFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, unreadCountFilterFn error",e)}try{r=!!this.lastMessageFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, lastMessageFilterFn error",e)}const s=this.list.get(e.sessionId)||this.createSession(e.sessionId);let n=!1;if(this.logger.log("session:updateSessionWithMsg, pending ",e.sessionId,e.idClient,e.idServer,r,t),r&&(!s.lastMsg||s.lastMsg.time<e.time||e.status===Bt[Bt.sending]||s.lastMsg.status===Bt[Bt.sending])&&(s.lastMsg=e,s.updateTime=e.time,n=!0),t&&e.status===Bt[Bt.unread]&&e.time>(s.ack||0)){s.unread++;const t=s.unreadMsgs||[];t.unshift(e),t.sort(((e,t)=>t.time-e.time)),n=!0}n&&(this.logger.log("session:updateSessionWithMsg updating ",s.id,s.unread,s.lastMsg&&s.lastMsg.idClient),this.list.set(s.id,s),this.core.emit("updateSession",s))}storeUnreadByAck(e,t){const r=this.list.get(e)||this.createSession(e);if(r.ack&&t<r.ack)return void this.logger.warn("storeUnreadByAck: not need update ack",e,t,r.ack);const s=r.unreadMsgs||[],n=[];let i=0;return r.unreadMsgs=[],s.length>0&&(s.forEach((e=>{e.time>t&&(i++,n.push(e))})),r.unreadMsgs=n.sort(((e,t)=>t.time-e.time))),r.ack=t,r.unread=i,r.lastMsg&&"unread"===r.lastMsg.status&&t>=r.lastMsg.time&&(r.lastMsg.status="read"),this.list.set(e,r),r}updateSession(e,t=!0){const r=e.id,s=this.list.get(r)||this.createSession(e.id),n=Object.assign(s,e);return this.list.set(r,n),this.logger.log("updateSession: update",t,Cs(e,["id","ack","unread"]),n.lastMsg&&n.lastMsg.idClient),t&&this.core.emit("updateSession",n),n}isSessionComplete(e){return!!e&&(!!(e.id&&e.scene&&e.to)&&void 0!==e.lastMsg)}syncSessionAckHandler(e){const t=e.content.p2p||{},r=e.content.team.m_map||{};this.logger.log("syncSessionAck::",t,r),Object.keys(t).forEach((e=>{this.updateSession({id:"p2p-"+e,ack:t[e]},!1)})),Object.keys(r).forEach((e=>{this.updateSession({id:"team-"+e,ack:r[e]},!1)}))}syncSuperTeamSessionAckHandler(e){const t=e.content.superTeam.m_map;this.logger.log("syncSuperTeamSessionAck::",t),Object.keys(t).forEach((e=>{this.updateSession({id:"superTeam-"+e,ack:t[e]},!1)}))}syncMarkSessionAckHandler(e){const t=e.content,r=`${0===t.scene?"p2p":1===t.scene?"team":"superTeam"}-${t.to}`,s=this.list.get(r);if(s&&s.ack&&t.timetag<s.ack)this.logger.warn(`syncMarkSessionAckHandler: ${r} do not need update ack`,s.ack,t.timetag);else{const e=this.storeUnreadByAck(r,t.timetag);e&&this.core.emit("updateSession",e)}}syncMarkSuperTeamSessionAckHandler(e){e.content.scene=5,this.syncMarkSessionAckHandler(e)}onSyncDone(){let e=[];this.list.forEach(((t,r)=>{e.push(this.storeUnreadByAck(r,t.ack||0))})),this.list.clear(),e.sort(((e,t)=>e.updateTime-t.updateTime)).forEach((e=>{this.list.set(e.id,e)})),e=e.filter((e=>this.isSessionComplete(e))).sort(((e,t)=>t.updateTime-e.updateTime)),e.length>0&&this.core.emit("sessions",e)}onSyncMsgs(e){let t=this.list.get(e.sessionId),r=[];try{r=e.msgs.filter((e=>this.unreadCountFilterFn(JSON.parse(JSON.stringify(e)))))}catch(e){this.logger.error("session:onSyncMsgs, unreadCountFilterFn error ",e)}let s,n=[];try{n=e.msgs.filter((e=>this.lastMessageFilterFn(JSON.parse(JSON.stringify(e)))))}catch(e){this.logger.error("session:onSyncMsgs, lastMessageFilterFn error ",e)}n&&n.length>0&&(s=n[n.length-1],s=n[0].time>s.time?n[0]:s);const i=s?s.time:0;t||(t=s?this.createSession(e.sessionId,s):this.createSession(e.sessionId)),t.unreadMsgs=t.unreadMsgs?r.concat(t.unreadMsgs).filter((e=>e.status===Bt[Bt.unread])):r.filter((e=>e.status===Bt[Bt.unread])),t.updateTime&&t.updateTime>=i||(t.updateTime=i),t.lastMsg&&t.lastMsg.time>=i||(t.lastMsg=s),this.list.set(t.id,t)}updateSessionForDeletedMsg(e){const t={};e.forEach((e=>{const r=e.to===this.core.account?e.from:e.to,s=`${e.scene}-${r}`,n=this.list.get(s);if(!n)return;if((n.ack||0)<e.time&&e.from!==this.core.account&&n.unread>0&&(n.unread=n.unread-1,n.unreadMsgs&&n.unreadMsgs.length>0)){const t=Hn(n.unreadMsgs,{idClient:e.idClient});t>=0&&n.unreadMsgs.splice(t,1)}n.lastMsg&&n.lastMsg.idClient===e.idClient&&(n.lastMsg=null),t[n.id]=!0})),Object.keys(t).forEach((e=>{const t=this.list.get(e);t&&this.core.emit("updateSession",t)}))}multiSyncMsgReceiptHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.msgReceiptTag;if(r){this.updateSessionMsgReceiptTime([r],!0),r.msgReceiptTime=r.time,r.sesssionId=`p2p-${r.from}`;const e=__rest(r,["time","from"]);this.core.emit("msgReceipts",[e])}}syncMsgReceiptsHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.msgReceipts;r&&this.updateSessionMsgReceiptTime(r,!1)}updateSessionMsgReceiptTime(e,t=!0){e&&e.length>0&&e.forEach((e=>{let r=this.list.get(`p2p-${e.from}`);r||(r=this.createSession(`p2p-${e.from}`));const s=parseInt(e.time);r.msgReceiptTime&&r.msgReceiptTime>=s||(r.msgReceiptTime=s,r.lastMsg&&"sent"===r.lastMsg.status&&s>=r.lastMsg.time&&(r.lastMsg.status="receipt"),this.logger.log(`session: update session ${r.id} msgReceiptTime: ${r.msgReceiptTime}`),this.list.set(r.id,r),t&&this.core.emit("updateSession",r))}))}nimSyncSessionsWithMoreRoamingHandler(e){const t=function formatMoreRoamingSession(e,t){return e.map((e=>{const r=format(Wn,e);return r.sessionId=getSessionId(e,t),r}))}(e.content.datas,this.core.account);this.logger.log("session:syncSessionsWithMoreRoaming",t)}},"session"),NIM.registerService(class TeamService extends Service{constructor(e){super("team",e),this.myTeamMembersMap=new Map,this.service=new ModuleService$1(e),this.core.eventBus.on("team/onNotification",(e=>this.notificationHandler(e))),registerParser({cmdMap:Vr,cmdConfig:Jr})}mergeMyTeamMembers(e){e.forEach((e=>{const t=e.teamId,r=this.myTeamMembersMap.get(t),s=Object.assign({},r,e);this.myTeamMembersMap.set(t,s)}))}getTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e);return formatTeam((yield this.core.sendCmd("getTeamInfo",{teamId:e.teamId})).content.team)}))}getTeams(){return __awaiter(this,void 0,void 0,(function*(){return formatTeams((yield this.core.sendCmd("getTeams",{timetag:0})).content.teams)}))}getTeamsById(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamIds:{type:"array",itemType:"string"}},e);const t=yield this.core.sendCmd("getTeamsById",{teamIds:e.teamIds});return{teams:formatTeams(t.content.teams),tids:t.content.tids}}))}createTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"enum",values:["advanced","normal"]},name:{type:"string",allowEmpty:!1},level:{type:"number",required:!1},accounts:{type:"array",itemType:"string",required:!1},ps:{type:"string",allowEmpty:!1,max:5e3,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!1,required:!1},announcement:{type:"string",allowEmpty:!1,required:!1},avatar:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",allowEmpty:!1,required:!1}},e);const t=generateTeam(e);return formatTeam((yield this.core.sendCmd("createTeam",{team:t,accounts:e.accounts||[],ps:e.ps||""})).content.team)}))}dismissTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("dismissTeam",{teamId:e.teamId})}))}leaveTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("leaveTeam",{teamId:e.teamId})}))}transferTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),yield this.core.sendCmd("transferTeam",e)}))}updateTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!1,required:!1},announcement:{type:"string",allowEmpty:!1,required:!1},avatar:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",allowEmpty:!1,required:!1}},e);const t=generateTeam(e);return yield this.core.sendCmd("updateTeamInfo",{team:t}),formatTeam(t)}))}getTeamMembers(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",required:!1}},e);const r=yield this.core.sendCmd("getTeamMembers",{teamId:e.teamId,timetag:0}),s=formatTeamMembers(null===(t=r.content)||void 0===t?void 0:t.teamMembers);return e.accounts&&e.accounts.length>0?s.filter((t=>{var r;return null===(r=e.accounts)||void 0===r?void 0:r.includes(t.account)})):s}))}getMutedTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e);return formatTeamMembers((yield this.core.sendCmd("getMutedTeamMembers",{teamId:e.teamId})).content.teamMembers)}))}addTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),yield this.core.sendCmd("addTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""})}))}removeTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("removeTeamMembers",{teamId:e.teamId,accounts:e.accounts})}))}applyTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e);return formatTeam((yield this.core.sendCmd("applyTeam",{teamId:e.teamId,ps:e.ps||""})).content.team)}))}addTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("addTeamManagers",e)}))}removeTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("removeTeamManagers",e)}))}updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!1,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e);const t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext});yield this.core.sendCmd("updateMyMemberInfo",{teamMember:t});const r=formatTeamMember(Object.assign({updateTime:(new Date).getTime(),account:this.core.account},t));this.mergeMyTeamMembers([r]),this.core.emit("updateTeamMember",r);const s=qi(this.myTeamMembersMap.get(r.teamId));return this.core.emit("myTeamMembers",[s]),r}))}updateMemberNick(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!1}},e);const t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account});yield this.core.sendCmd("updateNickInTeam",{teamMember:t});return formatTeamMember(Object.assign({updateTime:(new Date).getTime()},t))}))}muteTeamMember(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteTeamMember",{teamId:e.teamId,account:e.account,mute:e.mute?1:0})}))}getTeamMemberInvitorAccid(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:200}},e);const r={teamId:e.teamId};e.accounts&&e.accounts.length>0&&(r.accounts=e.accounts);const s=yield this.core.sendCmd("getTeamMemberInvitorAccid",r);return(null===(t=s.content)||void 0===t?void 0:t.accountsMap)||{}}))}muteTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteTeam",{teamId:e.teamId,mute:e.mute?1:0})}))}passTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("passTeamApply",e)}))}rejectTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),yield this.core.sendCmd("rejectTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""})}))}acceptTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("acceptTeamInvite",e)}))}rejectTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),yield this.core.sendCmd("rejectTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""})}))}notifyTeamMsgReceiptsHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.teamMsgReceipts;r&&r.length>0&&(this.core.emit("teamMsgReceipts",r),this.core.emit("msgReceipts",r))}syncTeamsHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{teams:parseInt(t.timetag)});const r=null==t?void 0:t.teams;if(r&&r.length){const e=formatTeams(r);this.core.emit("teams",e)}}syncCreateTeamHandler(e){const t=e.content,r=formatTeam(null==t?void 0:t.team),s=generatorMemberByTeam(r,r.owner,"owner");this.core.emit("createTeam",r,s)}syncUpdateTeamMemberHandler(e){const t=e.content,r=formatTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMyTeamMembers([r]),this.core.emit("updateTeamMember",r);const s=qi(this.myTeamMembersMap.get(r.teamId));this.core.emit("myTeamMembers",[s])}syncMyTeamMembersHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{myTeamMembers:parseInt(t.timetag)});const r=null==t?void 0:t.teamMembers.map((e=>formatTeamMember(e)));this.mergeMyTeamMembers(r),this.core.emit("myTeamMembers",qi(r))}notificationHandler(e){const{attach:t,scene:r,from:s,to:n,time:i,idServer:o,idClient:a}=e,{team:c,account:d,accounts:m,type:p}=t;if("team"===r)switch("debug"===this.core.options.debugLevel?this.logger.debug("team::recvNotification",o,a,t):this.logger.log("team::recvNotification",o,a,n,p,d,m),p){case"updateTeam":c.updateTime=i,this.core.emit("updateTeam",c);break;case"addTeamMembers":this.service.notifyAddTeamMembers(c,m);break;case"acceptTeamInvite":this.service.notifyAddTeamMembers(c,[s]);break;case"passTeamApply":this.service.notifyAddTeamMembers(c,[d]);break;case"addTeamManagers":this.service.notifyUpdateTeamManagers(n,m,!0,i);break;case"removeTeamManagers":this.service.notifyUpdateTeamManagers(n,m,!1,i);break;case"removeTeamMembers":this.service.notifyRemoveTeamMembers(c,m);break;case"leaveTeam":this.service.notifyRemoveTeamMembers(c,[s]);break;case"dismissTeam":this.core.emit("dismissTeam",{teamId:n});break;case"transferTeam":this.service.notifyTransferTeam(c,s,d);break;case"updateTeamMemberMute":this.service.notifyUpdateTeamMembersMute(c,[d],t.mute)}}},"team"),NIM.registerService(class SystemMessageService extends Service{constructor(e){super("systemMessage",e),this.sysMsgUnread={total:0,friend:0,msg:0,team:0,superTeam:0},this.core.eventBus.on("logined",(()=>{this.initEventListeners()})),registerParser({cmdMap:Ki,cmdConfig:Wi})}initEventListeners(){this.core.eventBus.on("systemMessage/passFriendApply",(e=>{this.core.emit("updateSystemMessages",[{idServer:e.idServer,from:e.account,state:"pass",type:"friendRequest"}])})),this.core.eventBus.on("systemMessage/rejectFriendApply",(e=>{this.core.emit("updateSystemMessages",[{idServer:e.idServer,from:e.account,state:"decline",type:"friendRequest"}])}))}doMarkSysMsgAck(e){const t=[],r=[],s=["applySuperTeam","rejectSuperTeamApply","superTeamInvite","rejectSuperTeamInvite","customSuperTeam"];e.forEach((e=>{e.idServer&&(s.includes(e.type)?r.push(e.idServer):t.push(e.idServer))})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:"7",cid:"3",ids:t}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:"21",cid:"19",ids:r})}sendCustomSysMsg(e){validate({to:{type:"string",allowEmpty:!1},type:{type:"enum",values:["customP2p","customTeam","customSuperTeam"]},attach:{type:"string",allowEmpty:!1},setting:{type:"object",rules:{needSaveOffline:{type:"boolean",required:!1},env:{type:"string",allowEmpty:!1,required:!1}},required:!1},pushInfo:{type:"object",required:!1,rules:{needPush:{type:"boolean",required:!1},pushApnsText:{type:"string",required:!1},pushPayload:{type:"string",required:!1}}}},e);const t="customSuperTeam"===e.type?"sendSuperTeamCustomSysMsg":"sendCustomSysMsg";return this.core.sendCmd(t,{sysMsg:generatorSysMsgForCmd(e)}).then((()=>{this.logger.log("sendCustomSysMsg success")})).catch((e=>{throw this.logger.error("sendCustomSysMsg failed",e.message),e}))}onSysMsgHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(!r)return void this.logger.warn("onSysMsg no content.sysMsg");const s="number"==typeof Pt(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0;r.idServer=r.idServer||s;const n=formatSystemMessage(r,this.logger,Di.default);this.core.emit("sysMsg",n),this.doMarkSysMsgAck([n])}syncOfflineSysMsgsHandler(e){if(!(e.content.sysMsgs&&e.content.sysMsgs.length>0))return;const t=e.content.sysMsgs.map((e=>formatSystemMessage(e,this.logger,Di.leave)));this.core.emit("syncSysMsgs",t),this.doMarkSysMsgAck(t)}onRecallMsgHandler(e){var t;const r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(!r)return void this.logger.warn("onSysMsg no content.sysMsg");const s="number"==typeof Pt(e,"raw.r[0]")?`${e.raw.r[0]}`:void 0;r.idServer=r.idServer||s;const n=formatDeletedMsgs([r],function getSceneFromRecallSysMsg(e){return e===Hi.recallMsgP2p?"p2p":e===Hi.recallMsgTeam?"team":e===Hi.recallMsgSuperTeam?"superTeam":""}(+r.type));this.core.eventBus.emit("session/updateForDeletedMsg",n);const i=formatSystemMessage(r,this.logger,Di.default);this.core.emit("sysMsg",i),this.doMarkSysMsgAck([i])}syncRecallMsgOfflineAndRoamingHandler(e){const{timetag:t,type:r,sysMsgs:s}=e.content,n=parseInt(r),i=1===n?Di.leave:Di.roam,o=s.map((e=>formatSystemMessage(e,this.logger,i)));1===n&&this.doMarkSysMsgAck(o),this.core.eventBus.emit("sync/updateTimetag",{recallMsg:t}),this.core.emit("syncSysMsgs",o)}},"systemMessage"),NIM.registerService(class FriendService extends Service{constructor(e){super("friend",e),registerParser({cmdMap:Yi,cmdConfig:Zi})}getFriends(){var e;return __awaiter(this,void 0,void 0,(function*(){const t=yield this.core.sendCmd("getFriends",{timetag:0});let r=(null===(e=t.content)||void 0===e?void 0:e.friends)||[];return r=r.map((e=>reverseFriend(e))),r}))}addFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},ps:{type:"string",allowEmpty:!1,required:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:1,ps:e.ps||""});const t=(new Date).getTime();return{account:e.account,createTime:t,updateTime:t,valid:!0,source:0,passRelationShip:1,relationShip:1,bitsExtension:0}}))}applyFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:2,ps:e.ps||""})}))}passFriendApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:3,ps:e.ps||""}).then((t=>(this.core.eventBus.emit("systemMessage/passFriendApply",e),t)))}))}rejectFriendApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("friendReuqest",{account:e.account,type:4,ps:e.ps||""}).then((t=>(this.core.eventBus.emit("systemMessage/rejectFriendApply",e),t)))}))}deleteFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},delAlias:{type:"boolean"}},e),yield this.core.sendCmd("deleteFriend",{account:e.account,delFriendParams:{delAlias:!0===e.delAlias?1:0}})}))}updateFriend(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},alias:{type:"string"},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("updateFriend",{updateFriendTag:e})}))}syncFriendRequestHandler(e){const t=function formatFriendRequest(e){const t=Object.assign({},e);try{t.ps=t.ps&&JSON.parse(t.ps)}catch(e){}if(t.type=Ji[t.type],"addFriend"===t.type||"passFriendApply"===t.type){const r=(new Date).getTime();t.friend={account:e.account,alias:"",createTime:r,ext:"",updateTime:r,valid:!0}}return t}(e.content);this.core.emit("syncFriend",t)}syncDeleteFriendHandler(e){const t=e.content.account;this.logger.log(`friend::emit syncFriendAction: deleteFriend ${t}`),this.core.emit("syncFriend",{type:"deleteFriend",account:t})}syncUpdateFriendHandler(e){const t=reverseFriend(e.content.friend);this.logger.log("friend::emit syncFriendAction: updateFriend, ",null==t?void 0:t.account),this.core.emit("syncFriend",{type:"updateFriend",friend:t})}syncFriendsHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friends:parseInt(t.timetag)});const r=null==t?void 0:t.friends;if(r&&r.length){const e=r.map((e=>reverseFriend(e)));this.core.emit("friends",e)}}syncFriendUsersHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friendUsers:parseInt(t.timetag)});const r=null==t?void 0:t.users;if(r&&r.length){const e=r.map((e=>formatUser(e)));this.core.emit("users",e)}}},"friend"),NIM.registerService(class EventService extends Service{constructor(e){super("event",e),registerParser({cmdMap:to,cmdConfig:no})}publishEvent(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},value:{type:"number"},ext:{type:"string",required:!1},validTime:{type:"number",min:60,max:2592e3,required:!1},broadcastType:{type:"number",required:!1},sync:{type:"boolean",required:!1}},e);const r=Object.assign(Object.assign({validTime:604800},e),{idClient:at(),sync:!0===e.sync?1:0}),s=yield this.core.sendCmd("publishEvent",{msgEvent:r});return formatEvent((null===(t=s.content)||void 0===t?void 0:t.msgEvent)||{})}))}subscribeEvent(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100},subscribeTime:{type:"number",min:60,max:2592e3,required:!1}},e);const r=Object.assign(Object.assign({subscribeTime:2592e3},e),{sync:!0===e.sync?1:0}),s=yield this.core.sendCmd("subscribeEvent",{msgEventSubscribe:r,accounts:e.accounts});return{failedAccounts:(null===(t=s.content)||void 0===t?void 0:t.accounts)||[]}}))}unSubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e);const r={type:e.type};let s;if(e.accounts&&e.accounts.length>0){const n=yield this.core.sendCmd("unSubscribeEventsByAccounts",{msgEventSubscribe:r,accounts:e.accounts});s=(null===(t=n.content)||void 0===t?void 0:t.accounts)||[]}else yield this.core.sendCmd("unSubscribeEventsByType",{msgEventSubscribe:r}),s=[];return{failedAccounts:s}}))}querySubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,(function*(){let r;return validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e),r=e.accounts&&e.accounts.length>0?yield this.core.sendCmd("querySubscribeEventsByAccounts",{msgEventSubscribe:{type:e.type},accounts:e.accounts}):yield this.core.sendCmd("querySubscribeEventsByType",{msgEventSubscribe:{type:e.type}}),formatSubscribes(null===(t=r.content)||void 0===t?void 0:t.msgEventSubscribes)}))}pushEventHandler(e){var t;const r=(null===(t=e.content)||void 0===t?void 0:t.msgEvent)||{};this.core.emit("pushEvents",[formatEvent(r)])}pushEventsHandler(e){var t;const r=(null===(t=e.content)||void 0===t?void 0:t.msgEvents)||{};this.core.emit("pushEvents",function formatEvents(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatEvent(e))):[]}(r))}},"event"),NIM.registerService(class MsgExtendService extends Service{constructor(e){super("msgExtend",e),registerParser({cmdMap:io,cmdConfig:co})}getThreadMsgs(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:getEnumKeys(Nt)},threadMsgFromAccount:{type:"string",allowEmpty:!1},threadMsgIdServer:{type:"string",allowEmpty:!1},threadMsgTime:{type:"number"},threadMsgToAccount:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},lastMsgId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1}},e);const r=yield this.core.sendCmd("getThreadMsgs",function generateThreadMsgsParams(e){const t={scene:Cr[e.scene],from:e.threadMsgFromAccount,to:e.threadMsgToAccount,time:e.threadMsgTime,idServer:e.threadMsgIdServer},r={limit:e.limit<100?e.limit:100,beginTime:"number"==typeof e.beginTime?e.beginTime:0,reverse:!0===e.reverse?1:0};return e.lastMsgId&&(r.lastMsgId=e.lastMsgId),{msg:t,threadMsgReq:r}}(e));let{msgs:s,threadMsg:n}=r.content;const{threadMsgsMeta:i}=r.content,o=getSessionId(n,this.core.account),a=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:o});return s=formatMsgs(s,a?{account:this.core.account,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:this.core.account}),n=formatMsg(n,a?{account:this.core.account,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:this.core.account}),{msgs:s,threadMsg:n,total:parseInt(i.total),timetag:parseInt(i.lastMsgTime)}}))}getMsgsByIdServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({reqMsgs:{type:"array",rules:{scene:{type:"enum",values:getEnumKeys(Nt)},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},time:{type:"number"}},min:1,max:100}},e);return(yield this.core.sendCmd("getMsgsByIdServer",{reqMsgs:e.reqMsgs.map((e=>Object.assign(Object.assign({},e),{scene:getEnumKeyByEnumValue(Nt,e.scene)})))})).content.msgs.map((e=>{var t;const r=getSessionId(e,this.core.account),s=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg(e,s?{account:this.core.account,sessionAck:s.ack,msgReceiptTime:s.msgReceiptTime}:{account:this.core.account})}))}))}},"msgExtend"),NIM.registerService(class MsgLogService extends Service{constructor(e){super("msgLog",e),registerParser({cmdMap:po,cmdConfig:go})}deleteRoamingMsgs(e){return __awaiter(this,void 0,void 0,(function*(){validate({ids:{type:"array",itemType:"string"}},e);let t=[];try{t=e.ids.map((e=>{const{scene:t,accid:r}=getAccountFromSessionId(e);return`${t}|${r}`}))}catch(t){throw this.logger.error(`Failed to delete roaming msgs with ${e.ids}`,t),new Error(`Failed to create session with ${e.ids}`)}yield this.core.sendCmd("deleteRoamingMsgs",{ids:t})}))}getHistoryMsgs(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:Object.keys(Cr)},to:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1},lastMsgId:{type:"string",required:!1,allowEmpty:!1},asc:{type:"boolean",required:!1},msgTypes:{type:"array",itemType:"string",required:!1}},e);const r="p2p"===e.scene?"getHistoryMsgs":"team"===e.scene?"getHistoryTeamMsgs":"getHistorySuperTeamMsgs",s=yield this.core.sendCmd(r,Object.assign(Object.assign({beginTime:0,endTime:0,lastMsgId:0,limit:100,reverse:!1},e),{msgTypes:e.msgTypes?e.msgTypes.map((e=>Er[e])):[]})),{content:n}=s;if(!(n.msgs&&n.msgs.length>0))return[];const i=getSessionId(n.msgs[0],this.core.account),o=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:i}),a=formatMsgs(n.msgs,o?{account:this.core.account,sessionAck:o.ack,msgReceiptTime:o.msgReceiptTime}:{account:this.core.account});return!0===e.asc?a.sort(((e,t)=>e.time-t.time)):a}))}clearHistoryMsgsFromServer(e){return __awaiter(this,void 0,void 0,(function*(){validate({scene:{type:"enum",values:["p2p","team"]},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},isSyncSelf:{type:"boolean",required:!1}},e);const t=Object.assign(Object.assign({isDeleteRoam:1},e),{type:"team"===e.scene?2:1,isSyncSelf:!0===e.isSyncSelf?1:0});t[2===t.type?"toTid":"otherAccid"]=e.to;const r=(yield this.core.sendCmd("clearHistoryMsgsFromServer",{clearHistoryMsgsFromServerReqTag:t})).content;return this.core.eventBus.emit("session/updateForClearMsg",[{sessionId:`${e.scene}-${e.to}`}],!0),r}))}multiSyncClearServerHistoryMsgsHandler(e){const t=formatClearResult(e.content.data);this.core.eventBus.emit("session/updateForClearMsg",[t],!0),this.core.emit("clearServerHistoryMsgs",[t])}ftsCloudMsgLogs(e){return __awaiter(this,void 0,void 0,(function*(){return this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogs")}))}ftsCloudMsgLogsAggWithSession(e){return __awaiter(this,void 0,void 0,(function*(){return this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogsAggWithSession")}))}baseFtsCloudMsgLogs(e,t){return __awaiter(this,void 0,void 0,(function*(){if(validate({keyword:{type:"string",allowEmpty:!1},fromTime:{type:"number",required:!1},toTime:{type:"number",required:!1},sessionLimit:{type:"number",required:!1},msglogsLimit:{type:"number",required:!1},orderRule:{type:"enum",values:getEnumKeys(mo),required:!1},p2pSessionList:{type:"array",itemType:"string",required:!1},teamSessionList:{type:"array",itemType:"string",required:!1},senderList:{type:"array",itemType:"string",required:!1},msgTypeList:{type:"array",itemType:"enum",values:getEnumKeys(Lt),required:!1},msgSubTypeList:{type:"array",itemType:"number",required:!1}},e),e.fromTime&&e.toTime&&e.toTime<e.fromTime)throw new ValidateError("Request parameter error: toTime should be greater than fromTime",e,"");const r=function generateFtsTagForCmd(e){const t=format(fo,e);return Array.isArray(t.msgTypeList)&&(t.msgTypeList=t.msgTypeList.map((e=>Lt[e])).join(",")),["p2pSessionList","teamSessionList","senderList","msgSubTypeList"].forEach((e=>{Array.isArray(t[e])&&(t[e]=t[e].join(","))})),t}(e);return(yield this.core.sendCmd(t,{tag:r})).content.datas.map((e=>{var t;const r=getSessionId(e,this.core.account),s=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg(e,s?{account:this.core.account,sessionAck:s.ack,msgReceiptTime:s.msgReceiptTime}:{account:this.core.account})}))}))}syncClearServerHistoryMsgsHandler(e){const t=function formatClearResults(e){return Array.isArray(e)&&e.length>0?e.map((e=>formatClearResult(e))):[]}(e.content.datas);this.core.emit("clearServerHistoryMsgs",t)}},"msgLog"),NIM.registerService(class PassThroughService extends Service{constructor(e){super("passThrough",e),this.core=e,registerParser({cmdMap:vo,cmdConfig:So})}request(e){return validate({path:{type:"string",allowEmpty:!1}},e),this.core.sendCmd("requestProxy",{requestProxyTag:e}).then((e=>{const{content:t}=e;return t.proxyTag}))}onRequestProxyHandler(e){const{proxyMsg:t}=e.content;t&&t.time&&(t.time=+t.time),this.core.emit("proxyMsg",t)}},"passThrough"),NIM.registerService(class CloudStorageService{constructor(e,t={}){this.GRAYKEY="AllGrayscaleConfig",this.MIXSTOREKEY="AllMixStorePolicy",this.config={},this.nosCdnHostTimer=0,this.grayConfig={mixStoreEnable:!1,timeStamp:0,ttl:0},this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=jo.nos,this.s3=null,this.mixStoreErrorCount=10,this.nosErrorCount=0,this.circuitTimer=0,this.name="cloudStorage",this.logger=e.logger,this.core=e,registerParser({cmdMap:ko,cmdConfig:Io}),this.setOptions(t)}setOptions(e={}){const t=e.storageKeyPrefix||"NIMClient";this.GRAYKEY=t+"-AllGrayscaleConfig",this.MIXSTOREKEY=t+"-AllMixStorePolicy";const{s3:r}=e,s=__rest(e,["s3"]),n=Object.assign({},xo,this.config);if(s&&Object.prototype.hasOwnProperty.call(s,"cdn")){const e={cdn:Object.assign(Object.assign({},n.cdn),s.cdn)};this.config=Object.assign({},n,s,e)}else this.config=Object.assign({},n,s);r&&(this.s3=r)}init(){return __awaiter(this,void 0,void 0,(function*(){this.grayConfig=null,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=jo.nos,this.mixStoreErrorCount=10,this.config.isNeedToGetUploadPolicyFromServer&&(yield this.getGrayscaleConfig(this.core.options.appkey),yield this.getNosCdnHost())}))}uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({maxSize:{type:"number",required:!1},type:{type:"enum",values:["file","image","audio","video"]}},e),!e.fileInput&&!e.file&&!e.filePath)throw new Error("uploadFile needs target file object or a filePath");if(e.type&&"file"!==e.type){const t=Pt(e,"file.type");if("string"==typeof t&&-1===t.indexOf(e.type))throw new Error(`The meta type "${t}" does not match "${e.type}"`)}if(!(this.grayConfig&&this.grayConfig.mixStoreEnable&&this.mixStorePolicy.providers.length))return this.logger.log("uploadFile:: uploadFile begin, use old nos"),this.nosUpload(e);this.logger.log(`uploadFile:: uploadFile begin,Current settings grayConfig mixStoreEnable:${this.grayConfig.mixStoreEnable} curProvider:${this.curProvider}`),this.s3||(this.curProvider=jo.nos);let t=Ao;try{t=(yield this.core.sendCmd("getMixStoreToken",{mixStoreTokenReqTag:{provider:this.curProvider,tokenCount:1,tag:"qchat",returnBody:getUploadResponseFormat(e.type)}})).content.mixStoreTokenResTag}catch(e){throw this.core.logger.error("uploadFile:: getMixStoreToken error",e),new UploadError("getMixStoreToken error",e,this.curProvider,this.mixStorePolicy)}return this.curProvider===jo.s3?this.s3Upload(e,t):this.nosUpload(e,t)}))}nosUpload(e,t){var r,s;return __awaiter(this,void 0,void 0,(function*(){const n=Pt(this.core,"config.cdn.bucket"),i={tag:e.nosScenes||n||"nim",expireSec:e.nosSurvivalTime};let o,a;if(!t)try{o=yield this.core.sendCmd("getNosToken",{responseBody:getUploadResponseFormat(e.type),nosToken:i})}catch(e){throw this.core.logger.error("uploadFile:: getNosToken error",e),new UploadError("getNosToken error",e,1)}try{const r=o?o.content.nosToken:t;this.core.logger.debug("uploadFile:: uploadFile params",{nosToken:r,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,platform:w.platform}),a=yield this.core.adapters.uploadFile(Object.assign(Object.assign({},e),{nosToken:r,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,maxSize:e.maxSize||this.config.chunkMaxSize}))}catch(s){if(this.core.logger.error("uploadFile::nos uploadFile error",s),t){if(0===this.nosErrorCount){try{this._addCircuitTimer()}catch(t){throw new UploadError("upload file error",t,this.curProvider,this.mixStorePolicy,e.file||e.filePath)}return this.nosErrorCount=null===(r=this.mixStorePolicy.nosPolicy)||void 0===r?void 0:r.uploadConfig.retryPolicy.retry,this.uploadFile(e)}return this.nosErrorCount--,this.nosUpload(e,t)}throw new UploadError("nos uploadFile error",s,1)}const c=null==a?void 0:a.type,d=c&&c.indexOf("/")>-1?c.slice(0,c.indexOf("/")):"",m={image:"imageInfo",video:"vinfo",audio:"vinfo"};let p,l=this.config.uploadReplaceFormat.replace("{host}",this.config.cdn.cdnDomain||this.config.cdn.defaultCdnDomain).replace("{object}",o?o.content.nosToken.objectName:null==t?void 0:t.objectName);if(t&&t.shortUrl&&(l=t.shortUrl),!m[d])return Object.assign({url:l},a);try{l.indexOf("_im_url=1")<0&&(p=yield this.core.adapters.request(`${l}?${m[d]}`,{method:"GET",dataType:"json",timeout:5e3}))}catch(e){return this.core.logger.error("uploadFile:: fetch file info error",e),Object.assign({url:l},a)}if(p){const{data:e}=p,t="imageInfo"===m[d]?e:null===(s=null==e?void 0:e.GetVideoInfo)||void 0===s?void 0:s.VideoInfo,r={url:l,name:a.name,size:a.size,ext:a.ext,w:t.Width,h:t.Height,orientation:t.Orientation,dur:t.Duration,audioCodec:t.AudioCodec,videoCodec:t.VideoCodec,container:t.Container};return Mo(r,(function(e,t){return void 0!==t}))}return Object.assign({url:l},a)}))}getNosCdnHost(){var e;return __awaiter(this,void 0,void 0,(function*(){let t;try{t=yield this.core.sendCmd("getNosCdnHost")}catch(e){return void this.logger.error("getNosCdnHost::error",e)}if(!t)return;const r=null===(e=null==t?void 0:t.content)||void 0===e?void 0:e.nosConfigTag,s=parseInt(null==r?void 0:r.expire);0!==s&&r.cdnDomain?-1===s?(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix):(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix,this.nosCdnHostTimer=this.core.timerManager.addTimer((()=>{this.getNosCdnHost()}),1e3*s)):(this.config.cdn.bucket="",this.config.cdn.cdnDomain="",this.config.cdn.objectNamePrefix="")}))}getGrayscaleConfig(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(w.localStorage)try{w.localStorage.getItem&&w.localStorage.getItem(this.GRAYKEY)&&(this.grayConfig=JSON.parse(w.localStorage.getItem(this.GRAYKEY))[e])}catch(e){w.localStorage.getItem(this.GRAYKEY)&&this.core.logger.error("uploadFile:: JSON.parse grayscaleConfig error ",e)}if(!this.grayConfig||this.grayConfig.timeStamp+1e3*this.grayConfig.ttl<(new Date).getTime()){const t=yield this.core.sendCmd("getGrayscaleConfig",{config:{}});if(t.content&&t.content.grayConfigTag){this.logger.log("uploadFile::getAppGrayConfigRequest success ");try{this.grayConfig=JSON.parse(t.content.grayConfigTag.config),this.grayConfig.ttl=JSON.parse(t.content.grayConfigTag.ttl)}catch(e){this.logger.error("getGrayscaleConfig error",e)}if(!this.grayConfig)return;const r=w.localStorage.getItem(this.GRAYKEY)?JSON.parse(w.localStorage.getItem(this.GRAYKEY)):{};this.grayConfig.timeStamp=(new Date).getTime(),r[e]=this.grayConfig,w.localStorage.setItem(this.GRAYKEY,JSON.stringify(r))}else this.logger.debug("uploadFile:: result grayConfig:",t.content)}(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable)&&(yield this._getMixStorePolicy(e))}))}_getMixStorePolicy(e){return __awaiter(this,void 0,void 0,(function*(){const t=(new Date).getTime();if(w.localStorage)try{if(this.mixStorePolicy=JSON.parse(w.localStorage.getItem(this.MIXSTOREKEY))[e],this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.timeStamp&&this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl>t){const r=this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl-t;this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),r)}}catch(t){w.localStorage.getItem(this.MIXSTOREKEY)&&JSON.parse(w.localStorage.getItem(this.MIXSTOREKEY))[e]&&this.core.logger.error("uploadFile:: JSON.parse mixStorePolicy error ",t)}if(!this.mixStorePolicy||this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl<=t)try{const t=(yield this.core.sendCmd("getMixStorePolicy",{supportType:this.s3?[1,2]:[1]})).content.mixStorePolicyTag;this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.mixStorePolicy.ttl=Number(t.ttl),this.mixStorePolicy.providers=t.providers.split(","),this.circuitTimer&&this.core.timerManager.deleteTimer(this.circuitTimer),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.nosPolicy=t.nosPolicy?JSON.parse(t.nosPolicy):null,this.mixStorePolicy.s3Policy=t.s3Policy?JSON.parse(t.s3Policy):null,null===this.mixStorePolicy.s3Policy?this.mixStorePolicy.providers=["1"]:null===this.mixStorePolicy.nosPolicy?this.mixStorePolicy.providers=["2"]:this.mixStorePolicy.providers=this.mixStorePolicy.s3Policy.priority<this.mixStorePolicy.nosPolicy.priority?["2","1"]:["1","2"],this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),1e3*this.mixStorePolicy.ttl);const r=w.localStorage.getItem(this.MIXSTOREKEY)?JSON.parse(w.localStorage.getItem(this.MIXSTOREKEY)):{};this.mixStorePolicy.timeStamp=(new Date).getTime(),r[e]=this.mixStorePolicy,w.localStorage.setItem(this.MIXSTOREKEY,JSON.stringify(r))}catch(t){if(this.logger.error("getMixStorePolicy error",t),0===this.mixStoreErrorCount)throw new Error("getMixStorePolicy all count error");this._getMixStorePolicy(e),this.mixStoreErrorCount--}this.mixStorePolicy.nosPolicy&&(this.nosErrorCount=this.mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry)}))}s3Upload(e,t){return __awaiter(this,void 0,void 0,(function*(){let r;if(e.file)r=e.file;else if("string"==typeof e.fileInput){this.logger.warn("fileInput will abandon,Please use file or filepath");const t=document.getElementById(e.fileInput);if(!(t&&t.files&&t.files[0]))throw new Error("Can not get file from fileInput");r=t.files[0]}else{if(!(e.fileInput&&e.fileInput.files&&e.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${e.fileInput}`);r=e.fileInput.files[0]}if(!this.mixStorePolicy.s3Policy)throw new Error("dont get s3 policy");const s={accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey,sessionToken:t.sessionToken,region:t.region,maxRetries:this.mixStorePolicy.s3Policy.uploadConfig.retryPolicy.retry},n=new(0,this.s3);n.config.update(s);const i=decodeURIComponent(t.bucket),o=decodeURIComponent(t.objectName),a=r,c={Bucket:i,Key:o,Body:a,Metadata:{token:t.token},ContentType:a.type||"application/octet-stream"};this.core.logger.debug("uploadFile:: s3 upload params:",c);const d=n.upload(c);return new Promise((r=>{const s=(new Date).getTime();d.send(((n,i)=>{var o,c;if(n){this.logger.error("uploadFile:","api::s3:upload file failed",n),this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(c=null===(o=this.core)||void 0===o?void 0:o.socket)||void 0===c?void 0:c.sessionId,start_time:s,action:1}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof n.status?n.status:"number"==typeof n.code?n.code:0,description:n.message||`${n.code}`,operation_type:1,target:n.hostname}),this.core.reporter.reportTraceEnd("exceptions",1);try{this._addCircuitTimer()}catch(n){throw new UploadError("upload file error",n,this.curProvider,this.mixStorePolicy,e.file||e.filePath)}r(this.uploadFile(e))}else{let e=this.mixStorePolicy.s3Policy.cdnSchema;e=e.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn),e=e.replace("{objectName}",i.Key),r({size:a.size,name:a.name,url:t.shortUrl?t.shortUrl:e,ext:a.name.split(".")[1]||"unknown"})}}))}))}))}getPrivateUrl(e){var t;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),"";const[r,s,n,i,o,a,c,d]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);if(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable){const t=this._getUrlType(e);return t===jo.s3&&this.mixStorePolicy.s3Policy&&(e=this.mixStorePolicy.s3Policy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",a)),t===jo.nos&&this.mixStorePolicy.nosPolicy&&(e=this.mixStorePolicy.nosPolicy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",a)),e}const{downloadUrl:m,downloadHostList:p,nosCdnEnable:l}=this.config,u=this.config.cdn.cdnDomain,g=this.config.cdn.objectNamePrefix?decodeURIComponent(this.config.cdn.objectNamePrefix):"",y=decodeURIComponent(a),h=y.indexOf(g);if(u&&h>-1&&l)return`${s}${u}/${y.slice(h)}`;if(p.includes(i)&&a.includes("/")){const e=a.indexOf("/"),t=a.substring(0,e),r=a.substring(e+1);return m.replace("{bucket}",t).replace("{object}",r)}const f=p.filter((e=>"string"==typeof i&&i.includes(e)))[0],v=f?i.replace(f,"").replace(/\W/g,""):null;return v?m.replace("{bucket}",v).replace("{object}",a):e}getOriginUrl(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getOriginUrl",{nosSafeUrlTag:{safeUrl:e}})).content.nosSafeUrlTag.originUrl}))}getFileToken(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number",min:2,max:3},urls:{type:"array",required:!1,itemType:"string"}},e);const t=this.mixStorePolicy.nosPolicy?this.mixStorePolicy.nosPolicy.authPolicy.policyType:null,r=this.mixStorePolicy.s3Policy?this.mixStorePolicy.s3Policy.authPolicy.policyType:null;if(t===String(Oo.dontNeed)&&r===String(Oo.dontNeed))throw this.logger.error("don't need token"),new Error("don't need token");if(e.type===Oo.time){if(t&&t.indexOf(String(Oo.time))>=0||r&&r.indexOf(String(Oo.time))>0)return this.getFileAuthToken(e);throw this.logger.error("don't support time token "),new Error("don't support type time token ")}{if(!e.urls||!e.urls.length)throw this.logger.error("urls is required when urls token"),new Error("urls is required when urls token");let s=[],n=[];if(e.urls.forEach((e=>{const t=this._getUrlType(e);t===jo.nos&&n.push(e),t===jo.s3&&s.push(e)})),(!r||0!==s.length&&r.indexOf(String(Oo.urls))<0)&&(this.logger.warn("s3 url don't support url token"),s=[]),(!t||0!==n.length&&t.indexOf(String(Oo.urls))<0)&&(this.logger.warn("nos url don't support url token"),n=[]),0===s.length&&0===n.length)throw this.logger.error("not support urls"),new Error("not support urls");if(0===s.length||0===n.length)return e.urls=JSON.stringify(e.urls),this.getFileAuthToken(e)}}))}getFileAuthToken(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getFileAuthToken",{mixStoreAuthTokenReqTag:e})).content.mixStoreAuthTokenResTag}))}_getUrlType(e){return this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.nosPolicy.dlcdns.some((t=>e.indexOf(t)>=0))?jo.nos:this.mixStorePolicy.s3Policy&&this.mixStorePolicy.s3Policy.dlcdns.some((t=>e.indexOf(t)>=0))?jo.s3:null}_addCircuitTimer(){const e=this.mixStorePolicy.providers,t=e[(e.indexOf(String(this.curProvider))+1)%e.length];if(t===e[0])throw new Error("uploadFile all policy fail");const r=Pt(this.mixStorePolicy,"s3Policy.uploadConfig.retryPolicy");if(r&&r.retryNext&&t&&(this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${t}`),this.curProvider=parseInt(t),this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.s3Policy)){const e=this.mixStorePolicy[this.curProvider===jo.nos?"nosPolicy":"s3Policy"].uploadConfig.retryPolicy.circuit;if(!e||0===e)return;this.circuitTimer=this.core.timerManager.addTimer((()=>{this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${parseInt(this.mixStorePolicy.providers[0])}`),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.core.timerManager.deleteTimer(this.circuitTimer)}),1e3*e)}}process(e){const t=this[e.cmd+"Handler"];return"function"==typeof t?t.call(this,e):e.error&&!e.error.ignore?Promise.reject(e.error):Promise.resolve(e)}},"cloudStorage"),NIM.registerService(class SuperTeamService extends Service{constructor(e){super("superTeam",e),this.mySuperTeamMembersMap=new Map,this.service=new ModuleService(e),registerParser({cmdMap:Go,cmdConfig:Yo}),this.core.eventBus.on("team/onNotification",(e=>this.notificationHandler(e)))}mergeMySuperTeamMembers(e){e.forEach((e=>{const t=e.teamId,r=this.mySuperTeamMembersMap.get(t),s=Object.assign({},r,e);this.mySuperTeamMembersMap.set(t,s)}))}getSuperTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e);return formatSuperTeam((yield this.core.sendCmd("getSuperTeamInfo",{teamId:e.teamId})).content.superTeam)}))}getSuperTeams(){return __awaiter(this,void 0,void 0,(function*(){return formatSuperTeams((yield this.core.sendCmd("getSuperTeams",{timetag:0})).content.superTeams)}))}updateSuperTeamInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!1,required:!1},announcement:{type:"string",allowEmpty:!1,required:!1},avatar:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",allowEmpty:!1,required:!1}},e);const t=function generateSuperTeam(e){const t=Object.assign({},e),r={joinMode:No,beInviteMode:Bo,inviteMode:qo,updateTeamMode:$o,updateExtMode:Ko};return["avatar","name","intro","announcement","ext"].forEach((e=>{void 0!==t[e]&&(t[e]=t[e].toString())})),Object.keys(r).forEach((e=>{void 0!==t[e]&&(t[e]=r[e][t[e]])})),t}(e);return yield this.core.sendCmd("updateSuperTeamInfo",{superTeam:t}),formatSuperTeam(t)}))}addSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),yield this.core.sendCmd("addSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""})}))}removeSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),yield this.core.sendCmd("removeSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts})}))}addSuperTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("addSuperTeamManagers",e)}))}removeSuperTeamManagers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),yield this.core.sendCmd("removeSuperTeamManagers",e)}))}applySuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e);return formatSuperTeam((yield this.core.sendCmd("applySuperTeam",{teamId:e.teamId,ps:e.ps||""})).content.superTeam)}))}transferSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),yield this.core.sendCmd("transferSuperTeam",e)}))}muteSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteSuperTeam",{teamId:e.teamId,mute:e.mute?1:0})}))}muteSuperTeamMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string"},mute:{type:"boolean"}},e),yield this.core.sendCmd("muteSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,mute:e.mute?1:0})}))}updateMemberNick(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!1}},e);const t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account});yield this.core.sendCmd("updateSuperTeamMemberNick",{teamMember:t});return formatSuperTeamMember(Object.assign({updateTime:(new Date).getTime()},t))}))}updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!1,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e);const t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext});yield this.core.sendCmd("updateMySuperTeamMemberInfo",{teamMember:t});const r=formatSuperTeamMember(Object.assign({updateTime:(new Date).getTime(),account:this.core.account},t));this.mergeMySuperTeamMembers([r]),this.core.emit("updateSuperTeamMember",r);const s=qi(this.mySuperTeamMembersMap.get(r.teamId));return this.core.emit("mySuperTeamMembers",[s]),r}))}getSuperTeamMembersByAccounts(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:20,min:1}},e);const r=e.accounts.map((t=>`${e.teamId}|${t}`)),s=yield this.core.sendCmd("getSuperTeamMembersByAccounts",{memberIds:r});return formatSuperTeamMembers(null===(t=s.content)||void 0===t?void 0:t.superTeamMembers)}))}getSuperTeamMembers(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,max:1e3,required:!1},reverse:{type:"boolean",required:!1}},e);const r=yield this.core.sendCmd("getSuperTeamMembers",Object.assign({joinTime:0,limit:100,reverse:!1},e));return formatSuperTeamMembers(null===(t=r.content)||void 0===t?void 0:t.superTeamMembers)}))}queryMuteMembers(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},reverse:{type:"boolean",required:!1}},e);return formatSuperTeamMembers((yield this.core.sendCmd("queryMuteSuperTeamMembers",Object.assign({limit:100,joinTime:0,reverse:!1},e))).content.superTeamMembers)}))}leaveSuperTeam(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),yield this.core.sendCmd("leaveSuperTeam",{teamId:e.teamId})}))}passSuperTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("passSuperTeamApply",e)}))}rejectSuperTeamApply(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),yield this.core.sendCmd("rejectSuperTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""})}))}acceptSuperTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),yield this.core.sendCmd("acceptSuperTeamInvite",e)}))}rejectSuperTeamInvite(e){return __awaiter(this,void 0,void 0,(function*(){validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),yield this.core.sendCmd("rejectSuperTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""})}))}syncSuperTeamsHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{superTeams:parseInt(t.timetag)});const r=null==t?void 0:t.superTeams;if(r&&r.length){const e=formatSuperTeams(r);this.core.emit("superTeams",e)}}syncCreateSuperTeamHandler(e){const t=e.content,r=formatSuperTeam(null==t?void 0:t.superTeam),s=generatorMemberBySuperTeam(r,r.owner,"owner");this.core.emit("createSuperTeam",r,s)}syncUpdateSuperTeamMemberHandler(e){const t=e.content,r=formatSuperTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMySuperTeamMembers([r]),this.core.emit("updateSuperTeamMember",r);const s=qi(this.mySuperTeamMembersMap.get(r.teamId));this.core.emit("mySuperTeamMembers",[s])}syncMySuperTeamMembersHandler(e){const t=e.content;this.core.eventBus.emit("sync/updateTimetag",{mySuperTeamMembers:parseInt(t.timetag)});const r=null==t?void 0:t.teamMembers.map((e=>formatSuperTeamMember(e)));this.mergeMySuperTeamMembers(r),this.core.emit("mySuperTeamMembers",qi(r))}notificationHandler(e){const{attach:t,scene:r,from:s,to:n,time:i,idServer:o,idClient:a}=e,{team:c,account:d,accounts:m,type:p}=t;if("superTeam"===r)switch("debug"===this.core.options.debugLevel?this.logger.debug("superTeam::recvNotification",o,a,t):this.logger.log("superTeam::recvNotification",o,a,n,p,d,m),p){case"updateSuperTeam":c.updateTime=i,this.core.emit("updateSuperTeam",c);break;case"addSuperTeamMembers":this.service.notifyAddSuperTeamMembers(c,m);break;case"acceptSuperTeamInvite":this.service.notifyAddSuperTeamMembers(c,[s]);break;case"passSuperTeamApply":this.service.notifyAddSuperTeamMembers(c,[d]);break;case"addSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(n,m,!0,i);break;case"removeSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(n,m,!1,i);break;case"removeSuperTeamMembers":this.service.notifyRemoveSuperTeamMembers(c,m);break;case"leaveSuperTeam":this.service.notifyRemoveSuperTeamMembers(c,[s]);break;case"dismissSuperTeam":this.core.emit("dismissSuperTeam",{teamId:n});break;case"transferSuperTeam":this.service.notifyTransferSuperTeam(c,s,d);break;case"updateSuperTeamMembersMute":this.service.notifyUpdateSuperTeamMembersMute(c,m,t.mute)}}},"superTeam"),NIM.registerService(class SyncService extends Service{constructor(e,t={}){super("sync",e),this.options=t,this.syncDoneFlag=!1,this.options=Object.assign({myInfo:!!e.user.name,offlineMsgs:!!e.msg.name,teams:!!e.team.name,myTeamMembers:!!e.team.name,roamingMsgs:!!e.msg.name,relations:!!e.user.name,friends:!!e.friend.name,friendUsers:!!e.user.name,msgReceipts:!!e.msg.name,recallMsg:!!e.msg.name,sessionAck:!!e.session.name,superTeamSessionAck:!!e.session.name,superTeams:!!e.superTeam.name,mySuperTeamMembers:!!e.superTeam.name,superTeamRoamingMsgs:!!e.superTeam.name,deleteSuperTeamMsg:!!e.superTeam.name,deleteSelfMsgs:!!e.msg.name,sessionHistoryMsgsDelete:!!e.msgLog.name,signaling:!!e.signaling.name},t),this.timetags={},this.pArray=[],this.initEventListeners(),registerParser({cmdMap:ds,cmdConfig:ms})}getSyncDoneFlag(){return this.syncDoneFlag}doSync(){return __awaiter(this,void 0,void 0,(function*(){const e=this.genSyncParams();this.logger.log("doSync: ",e),yield this.core.sendCmd("sync",{sync:e})}))}initEventListeners(){this.core.eventBus.on("sync/updateTimetag",(e=>{Object.keys(e).forEach((t=>{e[t]>(this.timetags[t]||0)&&(this.timetags[t]=e[t])}))})),this.core.eventBus.on("logined",(()=>{this.syncDoneFlag=!1}))}genSyncParams(){return Object.keys(this.options).filter((e=>{const t=e;return this.options[t]})).reduce(((e,t)=>{const r=t;return e[r]=this.timetags[r]||0,e}),{})}handleImmediate(e){var t;this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),this.logger.log("sync: emit syncdone",null===(t=e.content)||void 0===t?void 0:t.timetag),this.syncDoneFlag=!0,this.core.emit("syncdone")}syncHandler(e){"ALI"===function getMiniappEnv(){return"undefined"!=typeof tt&&tt.getSystemInfo?"TT":"undefined"!=typeof swan&&swan.getSystemInfo?"BAIDU":"undefined"!=typeof my&&my.getSystemInfo?"ALI":"undefined"!=typeof wx&&wx.getSystemInfo?"WX":"unknow environment"}()?(this.logger.log("sync: emit ALIAPP sycnHandler, handle later"),setTimeout((()=>{this.handleImmediate(e)}),100)):this.handleImmediate(e)}},"sync"),NIM.registerService(class PluginService extends Service{constructor(e){super("plugin",e),this.core=e,registerParser({cmdMap:Xo,cmdConfig:Qo})}getChatroomAddress(e){return __awaiter(this,void 0,void 0,(function*(){validate({chatroomId:{type:"string",allowEmpty:!1},ipType:{type:"number",required:!1}},e);return(yield this.core.sendCmd("getChatroomAddress",{chatroomId:e.chatroomId,isWeixinApp:"WXAPP"===w.platform,ipType:e.ipType||0})).content.address}))}getQChatAddress(e){return __awaiter(this,void 0,void 0,(function*(){validate({ipType:{type:"number",required:!1}},e);return(yield this.core.sendCmd("getQChatAddress",{getQChatAddressTag:{ipType:(null==e?void 0:e.ipType)||0}})).content.address}))}},"plugin"),NIM.registerService(class OfflinePushService extends Service{constructor(e){super("offlinePush",e),this.plugin=void 0,this.authConfig=void 0,this.appBackgroundOptions={badge:0,isBackground:!1},this.setTokenAndBackgroundStateAfterLogin=e=>{this.plugin&&(this.regToken(e&&e.aosPushInfo),this.core.sendCmd("updateAppBackground",this.appBackgroundOptions))},registerParser({cmdMap:Pa,cmdConfig:Aa}),this.core.eventBus.on("logined",this.setTokenAndBackgroundStateAfterLogin)}setOfflinePushConfig(e){e.plugin?(validate({plugin:{type:"object",required:!0},authConfig:{type:"object",required:!0}},e),this.plugin=e.plugin,this.authConfig=e.authConfig):this.logger.warn("setOfflinePushConfig: invoke setOfflinePushConfig without plugin. If you are not running iOS or android app, please ignore this notice.")}regToken(e){const t=w.getSystemInfo()||{},r=t.os?t.os.toLowerCase():"";if(this.logger.log("OfflinePushService: os",r),"ios"!==r&&"android"!==r)return void this.logger.warn("OfflinePushService: only Android or IOS support offline push");if(!this.plugin||"function"!=typeof this.plugin.getDeviceToken)return void this.logger.warn("OfflinePushService: plugin.getDeviceToken is not a function");let s="";e&&e.pushType?s=e.pushType:"ios"===r?s="":"android"===r&&(s="8"),this.logger.log("OfflinePushService:: prepare to get device token. suggestPushType: "+s),this.logger.log("OfflinePushService push config",JSON.stringify(this.authConfig,null,2)),this.plugin.getDeviceToken({suggestPushType:s,config:this.authConfig},(e=>{e?(this.logger.log("OfflinePushService:: token is :"+e),this.pushTokenToServer(s,e)):this.logger.warn("OfflinePushService:: token is empty. Please check your parameters")}))}pushTokenToServer(e,t){let r="";const s=this.authConfig;switch(e){case"5":r=s.xmCertificateName;break;case"6":r=s.hwCertificateName;break;case"7":r=s.mzCertificateName;break;case"8":r=s.fcmCertificateName;break;case"9":r=s.vivoCertificateName;break;case"10":r=s.oppoCertificateName;break;default:r=s.apnsCertificateName}""===r||void 0===r?this.logger.warn("OfflinePushService:: certificate name is empty for push type: ",e):this.updatePushToken({tokenName:r,token:t,pushkit:0})}updatePushToken(e){return __awaiter(this,void 0,void 0,(function*(){let t;validate({tokenName:{type:"string",allowEmpty:!1,required:!0},token:{type:"string",allowEmpty:!1,required:!0},pushkit:{type:"number",required:!1}},e);try{const r=ea.parse("557d1e3cafa43e2589a588270c53d56f");t=ea.stringify(xa.decrypt(e.token,r)),this.logger.log("updatePushToken:: token",t)}catch(t){return this.logger.log("updatePushToken:: decrypt error",t),void this.logger.warn("updatePushToken:: token before decrypt",e.token)}yield this.core.sendCmd("updatePushToken",Object.assign(Object.assign({},e),{token:t}))}))}updateAppBackground(e){return __awaiter(this,void 0,void 0,(function*(){validate({isBackground:{type:"boolean",required:!0},badge:{type:"number",required:!1}},e),this.appBackgroundOptions=e,yield this.core.sendCmd("updateAppBackground",{isBackground:e.isBackground,badge:e.badge||0})}))}},"offlinePush"),NIM}));
